<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tek-Pak Inventory Admin — Light</title>
<meta name="color-scheme" content="light" />
<style>
  :root{
    --bg:#f6f8fb;
    --panel:#ffffff;
    --panel2:#f1f5fb;
    --text:#0f172a;
    --muted:#475569;
    --border:rgba(15,23,42,.12);
    --shadow:0 18px 45px rgba(2,8,23,.10);
    --radius:16px;

    --accent:#2563eb;
    --good:#16a34a;
    --warn:#d97706;
    --bad:#dc2626;

    --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--sans);
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 10% 0%, rgba(37,99,235,.14), transparent 50%),
      radial-gradient(900px 600px at 90% 10%, rgba(22,163,74,.10), transparent 55%),
      linear-gradient(180deg, #ffffff, var(--bg));
  }

  header{
    position:sticky; top:0; z-index:50;
    backdrop-filter:saturate(180%) blur(10px);
    background:rgba(246,248,251,.86);
    border-bottom:1px solid var(--border);
  }

  .topbar{
    max-width: 1650px;
    margin:0 auto;
    padding:12px 14px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
  }

  .brand{display:flex; gap:12px; align-items:center; min-width:280px}
  .logo{
    width:38px; height:38px;
    border-radius:14px;
    border:1px solid var(--border);
    background:linear-gradient(180deg, #fff, var(--panel2));
    box-shadow:0 10px 22px rgba(2,8,23,.08);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  .logo img{width:100%;height:100%;object-fit:contain;display:block}
  .title{font-weight:900; letter-spacing:.2px; line-height:1.05;}
  .subtitle{font-size:12px; color:var(--muted); margin-top:2px;}

  .pill{
    font-family:var(--mono);
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:linear-gradient(180deg, #fff, var(--panel2));
    color:rgba(15,23,42,.82);
    white-space:nowrap;
  }

  .actions{display:flex; align-items:center; justify-content:flex-end; gap:10px; flex-wrap:wrap; flex:1}

  .input{
    border:1px solid var(--border);
    background:#fff;
    border-radius:14px;
    padding:10px 10px;
    min-width: 240px;
    outline:none;
    box-shadow:0 8px 22px rgba(2,8,23,.06);
  }

  button{
    cursor:pointer;
    border:1px solid var(--border);
    background:linear-gradient(180deg, #fff, var(--panel2));
    color:var(--text);
    border-radius:14px;
    padding:10px 12px;
    font-weight:800;
    letter-spacing:.1px;
    box-shadow:0 10px 26px rgba(2,8,23,.08);
    transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, opacity .12s ease;
  }
  button:hover{ transform:translateY(-1px); border-color:rgba(37,99,235,.35); box-shadow:0 14px 34px rgba(2,8,23,.10); }
  button:active{ transform:translateY(0px) scale(.99); }
  button:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:0 10px 26px rgba(2,8,23,.06); }

  .btn-primary{ border-color:rgba(37,99,235,.35); }
  .btn-good{ border-color:rgba(22,163,74,.30); }
  .btn-bad{ border-color:rgba(220,38,38,.30); }
  .btn-ghost{ background:transparent; box-shadow:none; }

  main{
    max-width: 1650px;
    margin:0 auto;
    padding:14px;
    display:grid;
    grid-template-columns: 380px 1fr;
    gap:14px;
  }

  .card{
    border:1px solid var(--border);
    border-radius:var(--radius);
    background:rgba(255,255,255,.86);
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  .card h3{
    margin:0;
    padding:14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    border-bottom:1px solid var(--border);
    font-size:14px;
  }
  .body{ padding:14px; }

  label{
    display:block;
    font-size:12px;
    color:rgba(15,23,42,.78);
    margin:10px 0 6px;
    font-weight:700;
  }

  select, textarea, .field{
    width:100%;
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 10px;
    outline:none;
    background:#fff;
    color:var(--text);
    box-shadow:0 8px 22px rgba(2,8,23,.06);
  }
  textarea{ min-height:92px; resize:vertical; }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .muted{ color:var(--muted); font-size:12px; line-height:1.45; }
  .mini{ font-family:var(--mono); font-size:12px; color:rgba(15,23,42,.82); }

  .tableWrap{
    max-height: calc(100vh - 170px);
    overflow:auto;
    border-top:1px solid var(--border);
    background:#fff;
  }

  table{ width:100%; border-collapse:separate; border-spacing:0; font-size:13px; }
  thead th{
    position:sticky; top:0; z-index:10;
    background:rgba(255,255,255,.94);
    border-bottom:1px solid var(--border);
    padding:10px;
    text-align:left;
    font-size:12px;
    color:rgba(15,23,42,.85);
    white-space:nowrap;
  }
  tbody td{
    border-bottom:1px solid rgba(15,23,42,.06);
    padding:10px;
    vertical-align:top;
  }
  tbody tr:hover td{ background:rgba(37,99,235,.05); }

  .thumbs{ display:flex; gap:8px; flex-wrap:wrap; }
  .thumb{
    width:44px; height:44px; border-radius:12px;
    border:1px solid var(--border);
    background:linear-gradient(180deg, #fff, var(--panel2));
    overflow:hidden;
    cursor:pointer;
    box-shadow:0 8px 18px rgba(2,8,23,.08);
    display:flex; align-items:center; justify-content:center;
  }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

  .toast{
    position:fixed; bottom:16px; right:16px;
    background:rgba(255,255,255,.94);
    border:1px solid var(--border);
    padding:12px 14px;
    border-radius:16px;
    box-shadow: var(--shadow);
    max-width: 520px;
    display:none;
    z-index:80;
    white-space:pre-wrap;
  }

  .modal{
    position:fixed; inset:0;
    display:none; align-items:center; justify-content:center;
    background:rgba(2,8,23,.45);
    z-index:90;
    padding:16px;
  }

  .modal .panel{
    width:min(1100px, 100%);
    max-height: 92vh;
    overflow:auto;
    border-radius:22px;
    border:1px solid var(--border);
    background:#fff;
    box-shadow: 0 30px 90px rgba(2,8,23,.22);
  }

  .modal .panel header{
    position:sticky; top:0;
    background:rgba(255,255,255,.95);
    border-bottom:1px solid var(--border);
  }

  .modal .panel .content{ padding:14px; }

  .lightbox{
    position:fixed; inset:0;
    display:none;
    align-items:center; justify-content:center;
    background:rgba(2,8,23,.72);
    z-index:120;
    padding:18px;
  }
  .lightbox img{
    max-width: min(1200px, 96vw);
    max-height: 92vh;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.28);
    box-shadow: 0 26px 80px rgba(0,0,0,.40);
    background:#fff;
  }

  .kbd{
    font-family:var(--mono);
    font-size:12px;
    padding:2px 6px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#fff;
  }
</style>
</head>
<body>

<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="excellence.png" alt="Tek-Pak Logo" onerror="this.style.display='none'">
      </div>
      <div>
        <div class="title">Tek-Pak Inventory Admin</div>
        <div class="subtitle">Light theme • Google Sheets → Apps Script API</div>
      </div>
      <div class="pill mini" id="apiStatus">API: —</div>
    </div>

    <div class="actions">
      <input id="apiKey" class="input" placeholder="API key (stored locally on this device)" />
      <button class="btn-primary" id="btnConnect">Connect</button>
      <button id="btnRefresh">Refresh</button>
      <button class="btn-good" id="btnNew">+ New</button>
      <button id="btnExport">Export JSON</button>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <h3>
      Filters
      <span class="muted" id="countLabel">0 items</span>
    </h3>
    <div class="body">
      <label>Search</label>
      <input id="q" class="field" placeholder="Search title, serial, model, notes…" />

      <div class="grid2">
        <div>
          <label>Status</label>
          <select id="fStatus"><option value="">Any</option></select>
        </div>
        <div>
          <label>Category</label>
          <select id="fCategory"><option value="">Any</option></select>
        </div>
      </div>

      <label>Location</label>
      <select id="fLocation"><option value="">Any</option></select>

      <div class="grid2">
        <div>
          <label>Manufacturer</label>
          <select id="fManufacturer"><option value="">Any</option></select>
        </div>
        <div>
          <label>Condition</label>
          <select id="fCondition"><option value="">Any</option></select>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnApply">Apply</button>
        <button class="btn-ghost" id="btnClear">Clear</button>
      </div>

      <div style="height:12px;"></div>
      <div class="muted">
        Tips:
        <div>• <span class="kbd">Ctrl</span> + <span class="kbd">K</span> focuses search</div>
        <div>• Store per-item <b>eBay</b> + <b>PayPal</b> URLs for storefront buttons</div>
      </div>
    </div>
  </section>

  <section class="card">
    <h3>
      Inventory
      <span class="muted" id="lastSync">Last sync: —</span>
    </h3>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:110px;">Actions</th>
            <th>Title</th>
            <th style="width:120px;">Purchased</th>
            <th style="width:120px;">Sold</th>
            <th style="width:120px;">Status</th>
            <th style="width:150px;">Category</th>
            <th style="width:170px;">Location</th>
            <th style="width:220px;">Make/Model</th>
            <th style="width:190px;">Serial</th>
            <th style="width:220px;">Images</th>
            <th style="width:210px;">Buy Links</th>
            <th style="width:220px;">Notes</th>
            <th style="width:180px;">Item ID</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="13" class="muted" style="padding:14px;">Connect to API to load inventory…</td></tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<div class="modal" id="modal">
  <div class="panel">
    <header>
      <div class="topbar">
        <div class="brand" style="min-width:auto;">
          <div>
            <div class="title" id="modalTitle">Edit Item</div>
            <div class="subtitle mini" id="modalId">—</div>
          </div>
        </div>
        <div class="actions">
          <button id="btnClose">Close</button>
          <button class="btn-good" id="btnSave">Save</button>
        </div>
      </div>
    </header>

    <div class="content">
      <div class="grid2">
        <div>
          <label>Title</label>
          <input id="e_title" class="field" placeholder="e.g., Lenovo ThinkPad X1 Carbon" />
        </div>
        <div class="grid2">
          <div>
            <label>Purchased Price</label>
            <input id="e_purchased" class="field" placeholder="0.00" inputmode="decimal"/>
          </div>
          <div>
            <label>Sold Price</label>
            <input id="e_sold" class="field" placeholder="0.00" inputmode="decimal"/>
          </div>
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>Status</label>
          <select id="e_status"></select>
        </div>
        <div>
          <label>Category</label>
          <select id="e_category"></select>
        </div>
        <div>
          <label>Location</label>
          <select id="e_location"></select>
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>Manufacturer</label>
          <select id="e_manufacturer"></select>
        </div>
        <div>
          <label>Model</label>
          <input id="e_model" class="field" placeholder="Model name/number" />
        </div>
        <div>
          <label>Serial</label>
          <input id="e_serial" class="field" placeholder="Serial / Service Tag" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Condition</label>
          <select id="e_condition"></select>
        </div>
        <div>
          <label>Item ID</label>
          <input id="e_id" class="field" placeholder="Auto on save if blank" />
          <div class="muted">Leave blank for auto-generated ID.</div>
        </div>
      </div>

      <label>Notes</label>
      <textarea id="e_notes" placeholder="Specs, issues, included accessories, etc."></textarea>

      <label>Images (up to 5 URLs)</label>
      <div class="grid3">
        <input id="e_img1" class="field" placeholder="img1 URL" />
        <input id="e_img2" class="field" placeholder="img2 URL" />
        <input id="e_img3" class="field" placeholder="img3 URL" />
        <input id="e_img4" class="field" placeholder="img4 URL" />
        <input id="e_img5" class="field" placeholder="img5 URL" />
      </div>

      <div style="height:8px;"></div>
      <div class="row">
        <button id="btnPreviewImg">Preview Images</button>
        <button class="btn-primary" id="btnOpenEbay">Open eBay</button>
        <button class="btn-primary" id="btnOpenPaypal">Open PayPal</button>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>eBay Item URL</label>
          <input id="e_ebay" class="field" placeholder="https://www.ebay.com/itm/..." />
        </div>
        <div>
          <label>PayPal Button URL</label>
          <input id="e_paypal" class="field" placeholder="https://www.paypal.com/..." />
        </div>
      </div>

      <div style="height:10px;"></div>
      <div class="muted" id="saveHint">Saved to Google Sheet via Apps Script API.</div>
    </div>
  </div>
</div>

<div class="lightbox" id="lightbox">
  <img id="lightboxImg" alt="preview" />
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG — ONLY CHANGE THIS
========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbx8JaVyZqA4gXHPABTh28LtlcdxKvGLiEWQ2IBmWBLa_9ReExMURNz6kifJUX85-7DO/exec"; // must be /exec

/* ========================= */
const $ = (id)=>document.getElementById(id);
const LS_KEY = "tekpak_admin_api_key_light_v2";

let apiKey = "";
let dropdowns = {};
let items = [];
let editing = null;
let _saveLock = false;

/* -------------------------
   UI helpers
------------------------- */
function toast(msg, good=true){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  t.style.borderColor = good ? "rgba(22,163,74,.30)" : "rgba(220,38,38,.30)";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> t.style.display="none", 3200);
}
function setApiStatus(ok, msg){
  const el = $("apiStatus");
  el.textContent = ok ? "API: OK" : ("API: " + msg);
  el.style.borderColor = ok ? "rgba(22,163,74,.30)" : "rgba(220,38,38,.30)";
}

/* -------------------------
   Network helpers
------------------------- */
async function fetchWithTimeout(url, opts={}, ms=20000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{
    return await fetch(url, { ...opts, signal: ctrl.signal, cache:"no-store", redirect:"follow" });
  } finally {
    clearTimeout(t);
  }
}

/**
 * API strategy:
 * - ALWAYS include action + key in query string (works with e.parameter)
 * - ALSO include action + key in POST body (works if server parses JSON body)
 * This makes you compatible with basically any of the common Apps Script API patterns.
 */
function buildQS(action){
  return `action=${encodeURIComponent(action)}&key=${encodeURIComponent(apiKey||"")}&t=${Date.now()}`;
}

async function api(action, payload={}, {allowOpaque=false} = {}){
  const url = API_URL + "?" + buildQS(action);

  // include action+key in body too, for scripts that read JSON body
  const bodyObj = { action, key: apiKey, ...payload };
  const body = JSON.stringify(bodyObj);

  try{
    const res = await fetchWithTimeout(url, {
      method:"POST",
      mode:"cors",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body
    }, 25000);

    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); }
    catch(e){ throw new Error("Bad JSON from server:\n" + text.slice(0,300)); }

    if(!data.ok) throw new Error(data.error || "API error");
    return data;

  }catch(err){
    const msg = String(err && err.message ? err.message : err);
    if(!allowOpaque) throw new Error(msg || "Failed to fetch");

    // fallback fire-and-refresh path
    await fetchWithTimeout(url, {
      method:"POST",
      mode:"no-cors",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body
    }, 25000);

    return { ok:true, opaque:true };
  }
}

async function ping(){
  const url = API_URL + "?" + buildQS("ping");
  const r = await fetchWithTimeout(url, { method:"GET", mode:"cors" }, 15000);
  const text = await r.text();
  let j;
  try{ j = JSON.parse(text); }
  catch(e){ throw new Error("Bad JSON from ping:\n" + text.slice(0,300)); }
  if(!j.ok) throw new Error(j.error || "Ping failed");
  return j;
}

/* -------------------------
   Formatting
------------------------- */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function formatMoney(v){
  const n = Number(String(v||"0").replace(/[^0-9.\-]/g,"") || 0);
  return n.toLocaleString(undefined, {style:"currency", currency:"USD"});
}
function numClean(s){
  return String(s||"0").replace(/[^0-9.\-]/g,"") || "0";
}

/* -------------------------
   Dropdowns
------------------------- */
function optList(select, values, includeBlank=false, blankLabel="Any"){
  select.innerHTML = "";
  if(includeBlank){
    const o = document.createElement("option");
    o.value=""; o.textContent=blankLabel;
    select.appendChild(o);
  }
  (values||[]).forEach(v=>{
    const o = document.createElement("option");
    o.value=v; o.textContent=v;
    select.appendChild(o);
  });
}
function setSelectValueSafe(select, value){
  const v = String(value || "").trim();
  if(!v){ select.value = ""; return; }
  const exists = Array.from(select.options).some(o => o.value === v);
  if(!exists){
    const o = document.createElement("option");
    o.value = v; o.textContent = v + " (existing)";
    select.appendChild(o);
  }
  select.value = v;
}

/* -------------------------
   Rendering
------------------------- */
function getImgs(item){
  return [item["img1"], item["img2"], item["img3"], item["img4"], item["img5"]].filter(Boolean);
}
function thumbsFor(item){
  const urls = getImgs(item);
  if(!urls.length) return `<span class="muted">—</span>`;
  return `<div class="thumbs">
    ${urls.slice(0,5).map(u=>`
      <div class="thumb" data-img="${escapeHtml(u)}" title="Click to preview">
        <img src="${escapeHtml(u)}" alt="">
      </div>`).join("")}
  </div>`;
}
function buyLinksFor(item){
  const ebay = (item["ebay item url"]||"").trim();
  const pp = (item["paypal button url"]||"").trim();
  let out = "";
  if(ebay) out += `<button class="btn-primary btn-ghost" data-open="${escapeHtml(ebay)}">eBay</button> `;
  if(pp) out += `<button class="btn-primary btn-ghost" data-open="${escapeHtml(pp)}">PayPal</button>`;
  return out || `<span class="muted">—</span>`;
}

function render(){
  const tb = $("tbody");

  const q = $("q").value.trim().toLowerCase();
  const status = $("fStatus").value;
  const category = $("fCategory").value;
  const location = $("fLocation").value;
  const manufacturer = $("fManufacturer").value;
  const condition = $("fCondition").value;

  const filtered = items.filter(it=>{
    if(status && it["status"]!==status) return false;
    if(category && it["category"]!==category) return false;
    if(location && it["location"]!==location) return false;
    if(manufacturer && it["manufacturer"]!==manufacturer) return false;
    if(condition && it["condition"]!==condition) return false;

    if(q){
      const hay = (
        (it["title"]||"") + " " +
        (it["notes"]||"") + " " +
        (it["serial"]||"") + " " +
        (it["model"]||"") + " " +
        (it["manufacturer"]||"") + " " +
        (it["item id"]||"")
      ).toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  $("countLabel").textContent = `${filtered.length} items`;

  if(!apiKey){
    tb.innerHTML = `<tr><td colspan="13" class="muted" style="padding:14px;">
      Paste your API key and click <b>Connect</b>.
    </td></tr>`;
    return;
  }

  if(!filtered.length){
    tb.innerHTML = `<tr><td colspan="13" class="muted" style="padding:14px;">No items match your filters.</td></tr>`;
    return;
  }

  tb.innerHTML = filtered.map(it=>{
    const title = it["title"] || "(untitled)";
    const notes = it["notes"] || "";
    const mm = ((it["manufacturer"]||"") + " " + (it["model"]||"")).trim();

    return `<tr>
      <td><button data-edit="${escapeHtml(it["item id"]||"")}">Edit</button></td>
      <td>
        <div style="font-weight:900">${escapeHtml(title)}</div>
        <div class="muted">${escapeHtml(notes.slice(0,120))}${notes.length>120?"…":""}</div>
      </td>
      <td>${formatMoney(it["purchased price"])}</td>
      <td>${formatMoney(it["sold price"])}</td>
      <td>${escapeHtml(it["status"]||"")}</td>
      <td>${escapeHtml(it["category"]||"")}</td>
      <td>${escapeHtml(it["location"]||"")}</td>
      <td>${escapeHtml(mm||"")}</td>
      <td class="mini">${escapeHtml(it["serial"]||"")}</td>
      <td>${thumbsFor(it)}</td>
      <td>${buyLinksFor(it)}</td>
      <td class="muted">${escapeHtml((notes||"").slice(0,90))}${(notes||"").length>90?"…":""}</td>
      <td class="mini">${escapeHtml(it["item id"]||"")}</td>
    </tr>`;
  }).join("");

  tb.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-edit");
      const found = items.find(x => (x["item id"]||"") === id);
      openEditor(found);
    });
  });

  tb.querySelectorAll(".thumb").forEach(t=>{
    t.addEventListener("click", ()=> openLightbox(t.getAttribute("data-img")));
  });

  tb.querySelectorAll("[data-open]").forEach(b=>{
    b.addEventListener("click", ()=> window.open(b.getAttribute("data-open"), "_blank", "noopener"));
  });
}

/* -------------------------
   Lightbox
------------------------- */
function openLightbox(url){
  $("lightboxImg").src = url;
  $("lightbox").style.display = "flex";
}
$("lightbox").addEventListener("click", ()=> $("lightbox").style.display="none");

/* -------------------------
   Editor
------------------------- */
function openEditor(item){
  const origId = item ? (item["item id"] || "") : "";

  editing = item ? {...item, _origId: origId} : {
    "item id":"",
    "location":"",
    "title":"",
    "purchased price":"0",
    "sold price":"0",
    "status":"",
    "category":"",
    "manufacturer":"",
    "model":"",
    "serial":"",
    "condition":"",
    "img1":"","img2":"","img3":"","img4":"","img5":"",
    "ebay item url":"",
    "paypal button url":"",
    "notes":"",
    _origId:""
  };

  $("modalTitle").textContent = item ? "Edit Item" : "New Item";
  $("modalId").textContent = editing["item id"] ? editing["item id"] : "new";

  $("e_title").value = editing["title"] || "";
  $("e_purchased").value = editing["purchased price"] || "0";
  $("e_sold").value = editing["sold price"] || "0";

  setSelectValueSafe($("e_status"), editing["status"] || "");
  setSelectValueSafe($("e_category"), editing["category"] || "");
  setSelectValueSafe($("e_location"), editing["location"] || "");
  setSelectValueSafe($("e_manufacturer"), editing["manufacturer"] || "");
  setSelectValueSafe($("e_condition"), editing["condition"] || "");

  $("e_model").value = editing["model"] || "";
  $("e_serial").value = editing["serial"] || "";

  $("e_id").value = editing["item id"] || "";
  $("e_notes").value = editing["notes"] || "";

  $("e_img1").value = editing["img1"] || "";
  $("e_img2").value = editing["img2"] || "";
  $("e_img3").value = editing["img3"] || "";
  $("e_img4").value = editing["img4"] || "";
  $("e_img5").value = editing["img5"] || "";

  $("e_ebay").value = editing["ebay item url"] || "";
  $("e_paypal").value = editing["paypal button url"] || "";

  $("modal").style.display = "flex";
  updatePreviewButtons_();
}

function closeEditor(){
  $("modal").style.display = "none";
  editing = null;
}

function updatePreviewButtons_(){
  const ebay = $("e_ebay").value.trim();
  const pp = $("e_paypal").value.trim();
  $("btnOpenEbay").disabled = !ebay;
  $("btnOpenPaypal").disabled = !pp;
}

async function saveEditor(){
  if(!editing || _saveLock) return;
  _saveLock = true;

  const btn = $("btnSave");
  const prev = btn.textContent;
  btn.textContent = "Saving…";
  btn.disabled = true;

  const title = $("e_title").value.trim();
  if(!title){
    toast("Title is required.", false);
    btn.textContent = prev; btn.disabled = false;
    _saveLock = false;
    return;
  }

  const payload = {
    "item id": $("e_id").value.trim(),
    "location": $("e_location").value.trim(),
    "title": title,
    "purchased price": numClean($("e_purchased").value),
    "sold price": numClean($("e_sold").value),
    "status": $("e_status").value.trim(),
    "category": $("e_category").value.trim(),
    "manufacturer": $("e_manufacturer").value.trim(),
    "model": $("e_model").value.trim(),
    "serial": $("e_serial").value.trim(),
    "condition": $("e_condition").value.trim(),
    "img1": $("e_img1").value.trim(),
    "img2": $("e_img2").value.trim(),
    "img3": $("e_img3").value.trim(),
    "img4": $("e_img4").value.trim(),
    "img5": $("e_img5").value.trim(),
    "ebay item url": $("e_ebay").value.trim(),
    "paypal button url": $("e_paypal").value.trim(),
    "notes": $("e_notes").value.trim()
  };

  try{
    const res = await api("upsertItem", {
      match_id: editing._origId || "",
      item: payload
    }, { allowOpaque:true });

    if(res && res.opaque){
      toast("Saved ✓ (confirmed by refresh)");
      await refresh();
      closeEditor();
      render();
    } else {
      const saved = res.data || payload;
      const id = saved["item id"] || payload["item id"];
      const idx = items.findIndex(x => (x["item id"]||"") === id);
      if(idx >= 0) items[idx] = saved;
      else items.unshift(saved);
      toast("Saved ✓");
      closeEditor();
      render();
    }
  }catch(err){
    toast(err.message || "Save failed", false);
  }finally{
    btn.textContent = prev;
    btn.disabled = false;
    _saveLock = false;
  }
}

/* -------------------------
   Data loading
------------------------- */
async function loadDropdowns(){
  if(!apiKey) return;
  const res = await api("getDropdowns", {});
  dropdowns = res.data || {};

  optList($("fStatus"), dropdowns.status || [], true);
  optList($("fCategory"), dropdowns.category || [], true);
  optList($("fLocation"), dropdowns.location || [], true);
  optList($("fManufacturer"), dropdowns.manufacturer || [], true);
  optList($("fCondition"), dropdowns.condition || [], true);

  optList($("e_status"), dropdowns.status || [], false);
  optList($("e_category"), dropdowns.category || [], false);
  optList($("e_location"), dropdowns.location || [], false);
  optList($("e_manufacturer"), dropdowns.manufacturer || [], false);
  optList($("e_condition"), dropdowns.condition || [], false);
}

async function refresh(){
  if(!apiKey){ render(); return; }
  try{
    const res = await api("listItems", {});
    items = res.data || [];
    $("lastSync").textContent = "Last sync: " + new Date().toLocaleString();
    render();
  }catch(err){
    toast(err.message || "Refresh failed", false);
  }
}

async function connect(){
  apiKey = $("apiKey").value.trim();
  if(!apiKey){
    toast("Paste API key first.", false);
    return;
  }
  localStorage.setItem(LS_KEY, apiKey);

  try{
    const j = await ping();
    setApiStatus(true, j.version ? ("OK • " + j.version) : "OK");

    await loadDropdowns();
    await refresh();
    toast("Connected ✓");
  }catch(err){
    setApiStatus(false, "FAIL");
    toast(err.message || "Connect failed", false);
  }
}

/* -------------------------
   Wire UI
------------------------- */
$("btnConnect").addEventListener("click", connect);
$("btnRefresh").addEventListener("click", refresh);
$("btnNew").addEventListener("click", ()=> openEditor(null));
$("btnClose").addEventListener("click", closeEditor);
$("btnSave").addEventListener("click", saveEditor);

$("btnApply").addEventListener("click", render);
$("btnClear").addEventListener("click", ()=>{
  $("q").value = "";
  $("fStatus").value = "";
  $("fCategory").value = "";
  $("fLocation").value = "";
  $("fManufacturer").value = "";
  $("fCondition").value = "";
  render();
});

$("q").addEventListener("input", render);

document.addEventListener("keydown", (e)=>{
  if(e.ctrlKey && e.key.toLowerCase() === "k"){
    e.preventDefault();
    $("q").focus();
  }
  if(e.key === "Escape"){
    if($("lightbox").style.display === "flex") $("lightbox").style.display = "none";
    if($("modal").style.display === "flex") closeEditor();
  }
});

$("modal").addEventListener("click", (e)=>{
  if(e.target === $("modal")) closeEditor();
});

$("btnPreviewImg").addEventListener("click", ()=>{
  const urls = [
    $("e_img1").value.trim(),
    $("e_img2").value.trim(),
    $("e_img3").value.trim(),
    $("e_img4").value.trim(),
    $("e_img5").value.trim()
  ].filter(Boolean);
  if(!urls.length){ toast("No image URLs yet.", false); return; }
  openLightbox(urls[0]);
});

$("btnOpenEbay").addEventListener("click", ()=>{
  const u = $("e_ebay").value.trim();
  if(u) window.open(u, "_blank", "noopener");
});
$("btnOpenPaypal").addEventListener("click", ()=>{
  const u = $("e_paypal").value.trim();
  if(u) window.open(u, "_blank", "noopener");
});

["e_ebay","e_paypal"].forEach(id=>{
  $(id).addEventListener("input", updatePreviewButtons_);
});

/* Export JSON */
$("btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(items, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "tekpak-inventory-export.json";
  a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
});

/* Boot */
(function boot(){
  const saved = localStorage.getItem(LS_KEY) || "";
  $("apiKey").value = saved;
  apiKey = saved.trim();

  // status indicator (does not block UI)
  if(API_URL && !API_URL.includes("PASTE_YOUR")){
    ping().then(j=>{
      setApiStatus(true, j.version ? ("OK • " + j.version) : "OK");
    }).catch(()=>{
      setApiStatus(false, "FAIL");
    });
  } else {
    setApiStatus(false, "SET URL");
  }

  render();
})();
</script>

</body>
</html>
