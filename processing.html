<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YardFlow Command Center — PROCESSING</title>
<style>
  :root{
    --bg:#070b14; --panel:#0f1727; --panel2:#0b1220; --text:#eaf1ff; --muted:#9fb3d1;
    --line:rgba(255,255,255,.10); --accent:#3aa0ff; --good:#3dff8d; --warn:#ffd166; --bad:#ff4d6d;
    --r:18px; --r2:22px; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    --sans: system-ui,-apple-system, Segoe UI, Roboto, Arial;
    --shadow: 0 22px 60px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text); font-family:var(--sans);
    background:
      radial-gradient(900px 600px at 15% -10%, rgba(58,160,255,.20), transparent 60%),
      radial-gradient(900px 600px at 95% 10%, rgba(255,209,102,.10), transparent 55%),
      var(--bg);
  }
  header{
    position:sticky; top:0; z-index:10;
    padding:14px 16px; border-bottom:1px solid var(--line);
    background:linear-gradient(180deg, rgba(15,23,39,.92), rgba(7,11,20,.70));
    backdrop-filter: blur(10px);
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }
  .brand{display:flex; gap:12px; align-items:center}
  .logo{
    width:38px; height:38px; border-radius:14px;
    background:linear-gradient(135deg, rgba(255,209,102,.90), rgba(58,160,255,.55));
    box-shadow:0 14px 40px rgba(0,0,0,.45);
  }
  .title{font-weight:900; letter-spacing:.2px}
  .sub{color:var(--muted); font-size:12px; line-height:1.2}
  .nav{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
  .chipNav{
    font-size:12px; padding:7px 10px; border-radius:999px; border:1px solid var(--line);
    background:rgba(255,255,255,.04); color:var(--text); text-decoration:none; font-weight:800;
  }
  .chipNav.active{border-color:rgba(255,209,102,.65); box-shadow:0 0 0 2px rgba(255,209,102,.12) inset}
  .wrap{
    display:grid; grid-template-columns: 360px 1fr; gap:14px;
    padding:14px; max-width:1500px; margin:0 auto;
  }
  @media (max-width: 1040px){ .wrap{grid-template-columns:1fr} }
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius:var(--r2);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card h3{
    margin:0; padding:12px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-size:14px; letter-spacing:.2px;
  }
  .card .body{padding:12px}
  .gridKpi{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
  @media (max-width: 1040px){ .gridKpi{grid-template-columns: repeat(2, 1fr)} }
  .kpi{
    border:1px solid var(--line); border-radius:18px; padding:10px;
    background:rgba(0,0,0,.20);
  }
  .kpi .label{color:var(--muted); font-size:11px}
  .kpi .value{font-weight:950; font-size:18px; margin-top:4px}
  .kpi .mini{color:var(--muted); font-size:11px; margin-top:2px}

  .lab{font-size:12px; color:var(--muted); margin:10px 0 6px}
  input, select, textarea{
    width:100%; padding:10px 10px; border-radius:14px;
    border:1px solid var(--line); background:rgba(0,0,0,.25); color:var(--text);
    outline:none;
  }
  textarea{min-height:96px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width: 700px){ .row{grid-template-columns:1fr} }

  .btns{display:flex; gap:10px; flex-wrap:wrap}
  button{
    border:none; border-radius:14px; padding:10px 12px; cursor:pointer;
    background:rgba(255,255,255,.06); color:var(--text); font-weight:900;
    border:1px solid var(--line);
  }
  button.primary{background:linear-gradient(135deg, rgba(58,160,255,.95), rgba(58,160,255,.55)); border-color:rgba(58,160,255,.55)}
  button.good{background:linear-gradient(135deg, rgba(61,255,141,.85), rgba(61,255,141,.35)); border-color:rgba(61,255,141,.55); color:#06210f}
  button.warn{background:linear-gradient(135deg, rgba(255,209,102,.9), rgba(255,209,102,.35)); border-color:rgba(255,209,102,.55); color:#241600}
  button.danger{background:linear-gradient(135deg, rgba(255,77,109,.9), rgba(255,77,109,.35)); border-color:rgba(255,77,109,.55); color:#2a0010}
  .miniBtn{padding:8px 10px; border-radius:12px; font-size:12px}
  .kbd{font-family:var(--mono); font-size:11px; color:var(--muted)}

  .list{display:flex; flex-direction:column; gap:8px; max-height:62vh; overflow:auto; padding-right:6px}
  .item{
    padding:10px; border-radius:18px; border:1px solid var(--line);
    background:rgba(255,255,255,.03); cursor:pointer;
  }
  .item .top{display:flex; justify-content:space-between; gap:10px; align-items:center}
  .tp{font-family:var(--mono); font-weight:950; font-size:12px}
  .pill{font-size:11px; padding:5px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted)}
  .meta{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.25}
  .divider{height:1px; background:var(--line); margin:12px 0}
  .hint{color:var(--muted); font-size:12px; line-height:1.35}
  .rightHead{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .statusLine{color:var(--muted); font-size:12px}
  .toast{
    position:fixed; left:14px; bottom:14px;
    background:rgba(0,0,0,.65); border:1px solid var(--line);
    padding:10px 12px; border-radius:14px; display:none;
  }

  /* Suffix / prefix inputs */
  .affix{
    display:flex; align-items:center;
    border:1px solid var(--line); border-radius:14px; overflow:hidden;
    background:rgba(0,0,0,.25);
  }
  .affix input{border:none; border-radius:0; background:transparent}
  .affix span{padding:0 10px; color:var(--muted); font-size:12px; border-left:1px solid var(--line)}

  /* Multi-select chips */
  .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:6px}
  .chipBox{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.20);
    cursor:pointer; user-select:none;
    font-size:12px; font-weight:900;
  }
  .chipBox input{accent-color: var(--accent); width:16px; height:16px}
  .chipBox.on{border-color: rgba(58,160,255,.55); box-shadow: 0 0 0 2px rgba(58,160,255,.12) inset}

  .tpCallout{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    padding:10px; border-radius:16px; border:1px solid var(--line);
    background:rgba(0,0,0,.22);
  }
  .tpCallout .big{font-family:var(--mono); font-weight:950;}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <div class="title">YardFlow Command Center</div>
      <div class="sub"><b>PROCESSING</b> • Diag + Spec Capture • Connectivity is multi-select ✅</div>
    </div>
  </div>

  <div class="nav">
    <a class="chipNav" href="./intake.html">Intake</a>
    <a class="chipNav active" href="./processing.html">Processing</a>
    <a class="chipNav" href="./staging.html">Staging</a>
    <a class="chipNav" href="./logistics.html">Logistics</a>
    <button class="primary" onclick="newItem()">+ New Item</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h3>PROCESSING Queue <span class="pill" id="queueCount">0</span></h3>
    <div class="body">
      <div class="lab">Search</div>
      <input id="q" placeholder="SKU, CPU, series…" oninput="renderList()" />

      <div class="row">
        <div>
          <div class="lab">Filter: Condition</div>
          <select id="filtCondition" onchange="renderList()"></select>
        </div>
        <div>
          <div class="lab">Sort</div>
          <select id="sortBy" onchange="renderList()">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="sku">SKU</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>
      <div class="list" id="list"></div>

      <div class="divider"></div>
      <div class="hint">
        <b>Shortcuts:</b>
        <span class="kbd">Enter</span> save •
        <span class="kbd">Ctrl</span>+<span class="kbd">→</span> next •
        <span class="kbd">Ctrl</span>+<span class="kbd">F</span> search
      </div>
    </div>
  </div>

  <div style="display:grid; gap:14px">
    <div class="card">
      <h3>Today’s Snapshot</h3>
      <div class="body">
        <div class="gridKpi">
          <div class="kpi"><div class="label">In Queue (TRIAGE)</div><div class="value" id="kpiQueue">0</div><div class="mini">items waiting</div></div>
          <div class="kpi"><div class="label">Missing CPU</div><div class="value" id="kpiCPU">0</div><div class="mini">quick fix</div></div>
          <div class="kpi"><div class="label">Missing RAM/SSD</div><div class="value" id="kpiMem">0</div><div class="mini">GB fields</div></div>
          <div class="kpi"><div class="label">Most Common</div><div class="value" id="kpiCommon">—</div><div class="mini">condition</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3><div class="rightHead"><span>Processing Form</span><span class="statusLine" id="statusLine">—</span></div></h3>
      <div class="body" id="detail"><div class="hint">Select an item from the queue.</div></div>
    </div>

    <div class="card">
      <h3>PROCESSING Checklist</h3>
      <div class="body">
        <div class="hint">
          Capture specs like you’re writing the listing:
          <br>• Screen size, CPU, RAM, Storage
          <br>• GPU/Series if relevant
          <br>• Features + <b>Connectivity (multi-select)</b> + condition
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===================== CONFIG (YARDOS API) ===================== */
const API_URL = "https://script.google.com/macros/s/AKfycbwRXMtWXFH35aPQbjnfeA3gvQXnaSgtTZ4tgMiI5Psc6fAFmwj9-WdYG4L04qf0Rj5J/exec";
const API_KEY = ""; // optional: matches Settings!API_KEY if you set one

// YardOS uses tabs. We’ll use Retail by default for this lane.
const TAB = "Inventory_Retail";

// Processing lane = items whose Status is TRIAGE (change if you want)
const QUEUE_STATUS = "TRIAGE";
// “Next” button will set Status to INTAKE (change if you want)
const NEXT_STATUS = "INTAKE";

let dropdowns = {};
let headers = [];
let db = [];           // listInventory results
let currentRow = 0;    // _row
let currentItem = null;

/* ===================== UTIL ===================== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display="none", 1600);
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("'","&#39;"); }
function uniq(list){ return [...new Set(list.filter(Boolean))]; }

/* ===================== JSONP GET ===================== */
function apiGet(params){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    let script;

    const timeout = setTimeout(()=>{
      cleanup();
      reject(new Error("API timeout"));
    }, 12000);

    function cleanup(){
      clearTimeout(timeout);
      try{ delete window[cb]; }catch{}
      if (script && script.parentNode) script.parentNode.removeChild(script);
    }

    window[cb] = (data)=>{ cleanup(); resolve(data); };

    const q = new URLSearchParams({ ...params, callback: cb });
    if (API_KEY) q.set("key", API_KEY);

    const url = API_URL + (API_URL.includes("?") ? "&" : "?") + q.toString();
    script = document.createElement("script");
    script.src = url;
    script.onerror = ()=>{ cleanup(); reject(new Error("API load error")); };
    document.head.appendChild(script);
  });
}

/* ===================== DATA ===================== */
async function loadDropdowns(){
  const dd = await apiGet({ action:"getDropdowns" });
  if (!dd || !dd.ok) throw new Error(dd?.error || "Dropdowns failed");
  dropdowns = dd.dropdowns || {};
}

async function refreshQueue(){
  // Pull all, then filter by Status === QUEUE_STATUS (YardOS listInventory can filter status but only exact)
  const res = await apiGet({ action:"listInventory", tab: TAB });
  if (!res || !res.ok) throw new Error(res?.error || "listInventory failed");
  headers = res.headers || [];
  const all = res.items || [];
  db = all.filter(x => String(x.Status||"").toUpperCase() === QUEUE_STATUS);
}

async function getRow(row){
  const res = await apiGet({ action:"getRow", tab:TAB, row });
  if (!res || !res.ok) throw new Error(res?.error || "getRow failed");
  return res.item;
}

async function upsertRow(payload){
  const res = await apiGet({
    action:"upsertInventory",
    tab: TAB,
    user: "yardflow-processing",
    payload: JSON.stringify(payload)
  });
  if (!res || !res.ok) throw new Error(res?.error || "upsertInventory failed");
  return res;
}

/* ===================== LIST + KPIs ===================== */
function setFilterOptions(){
  const sel = document.getElementById("filtCondition");
  const values = uniq(db.map(x=>x.Condition_Grade || x.Condition).filter(Boolean));
  sel.innerHTML = `<option value="">All</option>` + values.map(v=>`<option>${escapeHtml(v)}</option>`).join("");
}

function renderKPIs(){
  const queue = db;
  document.getElementById("kpiQueue").textContent = queue.length;

  const missCPU = queue.filter(x=>!(x.CPU||"").toString().trim()).length;
  document.getElementById("kpiCPU").textContent = missCPU;

  const missMem = queue.filter(x=>!(x.MemoryGB||"").toString().trim() || !(x.StorageGB||"").toString().trim()).length;
  document.getElementById("kpiMem").textContent = missMem;

  const conds = queue.map(x=>x.Condition_Grade || x.Condition).filter(Boolean);
  if (!conds.length) document.getElementById("kpiCommon").textContent = "—";
  else{
    const counts = conds.reduce((m,c)=>(m[c]=(m[c]||0)+1,m),{});
    const top = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
    document.getElementById("kpiCommon").textContent = top;
  }
}

function renderList(){
  const q = (document.getElementById("q").value || "").toLowerCase();
  const cond = document.getElementById("filtCondition").value || "";
  const sortBy = document.getElementById("sortBy").value;

  let list = [...db];

  if (cond){
    list = list.filter(x => String(x.Condition_Grade || x.Condition || "") === cond);
  }

  if (q){
    list = list.filter(x=>{
      const hay = [
        x.TP_SKU, x.Title, x.CPU, x.Series, x.GPU,
        x.ScreenSizeIn, x.MemoryGB, x.StorageGB,
        x.Connectivity, x.Features, x.Brand, x.Model
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  if (sortBy==="newest") list.sort((a,b)=>(Number(b._row)||0)-(Number(a._row)||0));
  if (sortBy==="oldest") list.sort((a,b)=>(Number(a._row)||0)-(Number(b._row)||0));
  if (sortBy==="sku") list.sort((a,b)=>(String(a.TP_SKU||"")).localeCompare(String(b.TP_SKU||"")));

  document.getElementById("queueCount").textContent = list.length;

  const el = document.getElementById("list");
  el.innerHTML = "";

  if (!list.length){
    el.innerHTML = `<div class="hint">No items with Status <b>${escapeHtml(QUEUE_STATUS)}</b>.</div>`;
    setFilterOptions();
    renderKPIs();
    return;
  }

  list.forEach(it=>{
    const d = document.createElement("div");
    d.className = "item";
    d.onclick = ()=> openItem(it._row);

    const needs = (!it.CPU || !it.MemoryGB || !it.StorageGB)
      ? ` <span class="pill" style="border-color:rgba(255,209,102,.55)">Needs specs</span>` : "";
    const conn = String(it.Connectivity||"").trim();
    const condShow = it.Condition_Grade || it.Condition || "—";

    d.innerHTML = `
      <div class="top">
        <div class="tp">${escapeHtml(it.TP_SKU || ("Row " + it._row))}</div>
        <div class="pill">${escapeHtml(condShow)}</div>
      </div>
      <div class="meta">
        CPU: <b>${escapeHtml(it.CPU || "—")}</b>${needs}<br>
        ${it.ScreenSizeIn?`${escapeHtml(it.ScreenSizeIn)}in`:""}
        ${it.MemoryGB?` • ${escapeHtml(it.MemoryGB)}GB`:""}
        ${it.StorageGB?` • ${escapeHtml(it.StorageGB)}GB`:""}
        ${conn?`<br>Conn: ${escapeHtml(conn)}`:""}
      </div>
    `;
    el.appendChild(d);
  });

  setFilterOptions();
  renderKPIs();
}

/* ===================== FORM HELPERS ===================== */
function affix(id, value, placeholder, suffix){
  return `<div class="affix"><input id="${id}" value="${escapeAttr(value||"")}" placeholder="${escapeAttr(placeholder)}"/><span>${escapeHtml(suffix)}</span></div>`;
}

/* Multi-select Connectivity */
function parseMulti(value){
  return String(value||"")
    .split(",")
    .map(s=>s.trim())
    .filter(Boolean);
}
function renderConnectivityChips(selectedList){
  const selected = new Set(selectedList);
  const opts = (dropdowns.Connectivity && dropdowns.Connectivity.length)
    ? dropdowns.Connectivity
    : ["Wi-Fi","Bluetooth","Ethernet","LTE/5G","USB-C","Thunderbolt","HDMI","Other"];

  return `
    <div class="chips" id="connChips">
      ${opts.map(opt=>{
        const checked = selected.has(opt) ? "checked" : "";
        const on = selected.has(opt) ? "on" : "";
        return `
          <label class="chipBox ${on}">
            <input type="checkbox" value="${escapeAttr(opt)}" ${checked} onchange="syncChipStyles()" />
            <span>${escapeHtml(opt)}</span>
          </label>
        `;
      }).join("")}
    </div>
  `;
}
function syncChipStyles(){
  const wrap = document.getElementById("connChips");
  if(!wrap) return;
  wrap.querySelectorAll(".chipBox").forEach(lbl=>{
    const cb = lbl.querySelector('input[type="checkbox"]');
    lbl.classList.toggle("on", !!cb?.checked);
  });
}
function getConnectivityFromChips(){
  const wrap = document.getElementById("connChips");
  if(!wrap) return "";
  const checked = [...wrap.querySelectorAll('input[type="checkbox"]:checked')].map(i=>i.value);
  return checked.join(", ");
}
function selectHTML(list, selected){
  list = list || [];
  return `<option value="">—</option>` + list.map(v=>`<option ${v===selected?'selected':''}>${escapeHtml(v)}</option>`).join("");
}

/* ===================== ACTIONS ===================== */
async function newItem(){
  // Create new row in YardOS
  const title = prompt("Title for new item?");
  if (!title) return;

  const payload = {
    Title: title,
    Status: QUEUE_STATUS,
    Qty: 1
  };

  await upsertRow(payload);
  await boot(false);
  toast("New item created");
}

async function openItem(row){
  currentRow = Number(row||0);
  if (!currentRow) return;

  const it = await getRow(currentRow);
  currentItem = it;

  const sku = it.TP_SKU || `Row ${currentRow}`;
  const condList = (dropdowns.Condition_Grade && dropdowns.Condition_Grade.length)
    ? dropdowns.Condition_Grade
    : (dropdowns.Condition && dropdowns.Condition.length ? dropdowns.Condition : ["A","B","C","Parts/Repair"]);

  document.getElementById("statusLine").textContent = `${sku} • Status: ${it.Status || "—"}`;

  document.getElementById("detail").innerHTML = `
    <div class="tpCallout" style="align-items:flex-start;">
      <div style="width:100%;">
        <div style="color:var(--muted); font-size:12px; margin-bottom:6px;">SKU</div>
        <div class="big">${escapeHtml(sku)}</div>
        <div class="hint" style="margin-top:6px;">Editing core spec fields for listing prep.</div>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Screen Size</div>
        ${affix("f_ScreenSizeIn", it.ScreenSizeIn, "e.g., 15.6", "in")}
      </div>
      <div>
        <div class="lab">CPU</div>
        <input id="f_CPU" value="${escapeAttr(it.CPU||"")}" placeholder="e.g., i7-8650U" />
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Storage</div>
        ${affix("f_StorageGB", it.StorageGB, "e.g., 256", "GB")}
      </div>
      <div>
        <div class="lab">Memory</div>
        ${affix("f_MemoryGB", it.MemoryGB, "e.g., 16", "GB")}
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">GPU</div>
        <input id="f_GPU" value="${escapeAttr(it.GPU||"")}" placeholder="e.g., Intel UHD / RTX 3050" />
      </div>
      <div>
        <div class="lab">Series</div>
        <input id="f_Series" value="${escapeAttr(it.Series||"")}" placeholder="e.g., ThinkPad T / Latitude" />
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Connectivity (multi-select)</div>
        ${renderConnectivityChips(parseMulti(it.Connectivity))}
      </div>
      <div>
        <div class="lab">Condition</div>
        <select id="f_Condition_Grade">${selectHTML(condList, it.Condition_Grade || it.Condition)}</select>
      </div>
    </div>

    <div class="lab">Features</div>
    <textarea id="f_Features" placeholder="touchscreen, backlit keyboard, fingerprint…">${escapeHtml(it.Features||"")}</textarea>

    <div class="divider"></div>
    <div class="btns">
      <button class="good" onclick="save()">Save</button>
      <button class="primary" onclick="moveNext()">Next → Set Status ${escapeHtml(NEXT_STATUS)}</button>
      <button class="miniBtn" onclick="refreshCurrent()">Refresh</button>
    </div>

    <div class="hint" style="margin-top:10px">
      Saves <b>Connectivity</b> as comma-separated values in one cell (e.g., <i>Wi-Fi, Bluetooth</i>).
    </div>
  `;

  setTimeout(syncChipStyles, 0);
}

async function refreshCurrent(){
  if (!currentRow) return;
  await boot(false);
  await openItem(currentRow);
  toast("Refreshed from sheet");
}

async function save(){
  if (!currentRow) return;

  const payload = {
    _row: currentRow,
    ScreenSizeIn: document.getElementById("f_ScreenSizeIn").value.trim(),
    CPU: document.getElementById("f_CPU").value.trim(),
    StorageGB: document.getElementById("f_StorageGB").value.trim(),
    MemoryGB: document.getElementById("f_MemoryGB").value.trim(),
    GPU: document.getElementById("f_GPU").value.trim(),
    Series: document.getElementById("f_Series").value.trim(),
    Connectivity: getConnectivityFromChips(),
    Features: document.getElementById("f_Features").value,
    // Prefer Condition_Grade column if it exists in your sheet; otherwise Condition
    Condition_Grade: document.getElementById("f_Condition_Grade").value,
    Condition: document.getElementById("f_Condition_Grade").value
  };

  await upsertRow(payload);
  await boot(false);
  toast("Saved to sheet");
}

async function moveNext(){
  if (!currentRow) return;
  await save();

  // Set Status to NEXT_STATUS
  await upsertRow({ _row: currentRow, Status: NEXT_STATUS });

  currentRow = 0;
  currentItem = null;
  document.getElementById("detail").innerHTML = `<div class="hint">Updated Status to <b>${escapeHtml(NEXT_STATUS)}</b>.</div>`;
  document.getElementById("statusLine").textContent = "—";
  await boot(false);
  toast("Forwarded");
}

/* ===================== Keyboard shortcuts ===================== */
document.addEventListener("keydown", (e)=>{
  if (e.ctrlKey && (e.key==="f" || e.key==="F")){ e.preventDefault(); document.getElementById("q").focus(); }
  if (e.key==="Enter" && currentRow && document.activeElement && document.activeElement.tagName!=="TEXTAREA"){ e.preventDefault(); save(); }
  if (e.ctrlKey && e.key==="ArrowRight"){ e.preventDefault(); if(currentRow) moveNext(); }
});

/* ===================== Boot ===================== */
async function boot(showToast=true){
  try{
    await loadDropdowns();
    await refreshQueue();
    renderList();
    renderKPIs();
    if (showToast) toast("Connected to sheet");
  }catch(err){
    document.getElementById("list").innerHTML =
      `<div class="hint"><b>API error.</b><br>${escapeHtml(err.message || String(err))}</div>`;
  }
}
boot();
</script>
</body>
</html>
