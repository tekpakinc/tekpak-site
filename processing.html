<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YardFlow Command Center — PROCESSING</title>
<style>
  :root{
    --bg:#070b14; --panel:#0f1727; --panel2:#0b1220; --text:#eaf1ff; --muted:#9fb3d1;
    --line:rgba(255,255,255,.10); --accent:#3aa0ff; --good:#3dff8d; --warn:#ffd166; --bad:#ff4d6d;
    --r:18px; --r2:22px; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    --sans: system-ui,-apple-system, Segoe UI, Roboto, Arial;
    --shadow: 0 22px 60px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text); font-family:var(--sans);
    background:
      radial-gradient(900px 600px at 15% -10%, rgba(58,160,255,.20), transparent 60%),
      radial-gradient(900px 600px at 95% 10%, rgba(255,209,102,.10), transparent 55%),
      var(--bg);
  }
  header{
    position:sticky; top:0; z-index:10;
    padding:14px 16px; border-bottom:1px solid var(--line);
    background:linear-gradient(180deg, rgba(15,23,39,.92), rgba(7,11,20,.70));
    backdrop-filter: blur(10px);
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }
  .brand{display:flex; gap:12px; align-items:center}
  .logo{
    width:38px; height:38px; border-radius:14px;
    background:linear-gradient(135deg, rgba(255,209,102,.90), rgba(58,160,255,.55));
    box-shadow:0 14px 40px rgba(0,0,0,.45);
  }
  .title{font-weight:900; letter-spacing:.2px}
  .sub{color:var(--muted); font-size:12px; line-height:1.2}
  .nav{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
  .chipNav{
    font-size:12px; padding:7px 10px; border-radius:999px; border:1px solid var(--line);
    background:rgba(255,255,255,.04); color:var(--text); text-decoration:none; font-weight:800;
  }
  .chipNav.active{border-color:rgba(255,209,102,.65); box-shadow:0 0 0 2px rgba(255,209,102,.12) inset}
  .wrap{
    display:grid; grid-template-columns: 360px 1fr; gap:14px;
    padding:14px; max-width:1500px; margin:0 auto;
  }
  @media (max-width: 1040px){ .wrap{grid-template-columns:1fr} }
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius:var(--r2);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card h3{
    margin:0; padding:12px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-size:14px; letter-spacing:.2px;
  }
  .card .body{padding:12px}
  .gridKpi{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
  @media (max-width: 1040px){ .gridKpi{grid-template-columns: repeat(2, 1fr)} }
  .kpi{
    border:1px solid var(--line); border-radius:18px; padding:10px;
    background:rgba(0,0,0,.20);
  }
  .kpi .label{color:var(--muted); font-size:11px}
  .kpi .value{font-weight:950; font-size:18px; margin-top:4px}
  .kpi .mini{color:var(--muted); font-size:11px; margin-top:2px}

  .lab{font-size:12px; color:var(--muted); margin:10px 0 6px}
  input, select, textarea{
    width:100%; padding:10px 10px; border-radius:14px;
    border:1px solid var(--line); background:rgba(0,0,0,.25); color:var(--text);
    outline:none;
  }
  textarea{min-height:96px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width: 700px){ .row{grid-template-columns:1fr} }

  .btns{display:flex; gap:10px; flex-wrap:wrap}
  button{
    border:none; border-radius:14px; padding:10px 12px; cursor:pointer;
    background:rgba(255,255,255,.06); color:var(--text); font-weight:900;
    border:1px solid var(--line);
  }
  button.primary{background:linear-gradient(135deg, rgba(58,160,255,.95), rgba(58,160,255,.55)); border-color:rgba(58,160,255,.55)}
  button.good{background:linear-gradient(135deg, rgba(61,255,141,.85), rgba(61,255,141,.35)); border-color:rgba(61,255,141,.55); color:#06210f}
  button.warn{background:linear-gradient(135deg, rgba(255,209,102,.9), rgba(255,209,102,.35)); border-color:rgba(255,209,102,.55); color:#241600}
  button.danger{background:linear-gradient(135deg, rgba(255,77,109,.9), rgba(255,77,109,.35)); border-color:rgba(255,77,109,.55); color:#2a0010}
  .miniBtn{padding:8px 10px; border-radius:12px; font-size:12px}
  .kbd{font-family:var(--mono); font-size:11px; color:var(--muted)}

  .list{display:flex; flex-direction:column; gap:8px; max-height:62vh; overflow:auto; padding-right:6px}
  .item{
    padding:10px; border-radius:18px; border:1px solid var(--line);
    background:rgba(255,255,255,.03); cursor:pointer;
  }
  .item .top{display:flex; justify-content:space-between; gap:10px; align-items:center}
  .tp{font-family:var(--mono); font-weight:950; font-size:12px}
  .pill{font-size:11px; padding:5px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted)}
  .meta{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.25}
  .divider{height:1px; background:var(--line); margin:12px 0}
  .hint{color:var(--muted); font-size:12px; line-height:1.35}
  .rightHead{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .statusLine{color:var(--muted); font-size:12px}
  .toast{
    position:fixed; left:14px; bottom:14px;
    background:rgba(0,0,0,.65); border:1px solid var(--line);
    padding:10px 12px; border-radius:14px; display:none;
  }

  /* Suffix / prefix inputs */
  .affix{
    display:flex; align-items:center;
    border:1px solid var(--line); border-radius:14px; overflow:hidden;
    background:rgba(0,0,0,.25);
  }
  .affix input{border:none; border-radius:0; background:transparent}
  .affix span{padding:0 10px; color:var(--muted); font-size:12px; border-left:1px solid var(--line)}

  /* Multi-select chips */
  .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:6px}
  .chipBox{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.20);
    cursor:pointer; user-select:none;
    font-size:12px; font-weight:900;
  }
  .chipBox input{accent-color: var(--accent); width:16px; height:16px}
  .chipBox.on{border-color: rgba(58,160,255,.55); box-shadow: 0 0 0 2px rgba(58,160,255,.12) inset}

  .tpCallout{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    padding:10px; border-radius:16px; border:1px solid var(--line);
    background:rgba(0,0,0,.22);
  }
  .tpCallout .big{font-family:var(--mono); font-weight:950;}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <div class="title">YardFlow Command Center</div>
      <div class="sub"><b>PROCESSING</b> • Diag + Spec Capture • Connectivity is multi-select ✅</div>
    </div>
  </div>

  <div class="nav">
    <a class="chipNav" href="./intake.html">Intake</a>
    <a class="chipNav active" href="./processing.html">Processing</a>
    <a class="chipNav" href="./staging.html">Staging</a>
    <a class="chipNav" href="./logistics.html">Logistics</a>
    <button class="miniBtn" onclick="openTpSettings()">TP Settings</button>
    <button class="primary" onclick="newItem()">+ New TP</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h3>PROCESSING Queue <span class="pill" id="queueCount">0</span></h3>
    <div class="body">
      <div class="lab">Search</div>
      <input id="q" placeholder="TP, CPU, series…" oninput="renderList()" />

      <div class="row">
        <div>
          <div class="lab">Filter: Condition</div>
          <select id="filtCondition" onchange="renderList()"></select>
        </div>
        <div>
          <div class="lab">Sort</div>
          <select id="sortBy" onchange="renderList()">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="tp">TP#</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>
      <div class="list" id="list"></div>

      <div class="divider"></div>
      <div class="hint">
        <b>Shortcuts:</b>
        <span class="kbd">Enter</span> save •
        <span class="kbd">Ctrl</span>+<span class="kbd">←</span> back •
        <span class="kbd">Ctrl</span>+<span class="kbd">→</span> next •
        <span class="kbd">Ctrl</span>+<span class="kbd">F</span> search
      </div>
    </div>
  </div>

  <div style="display:grid; gap:14px">
    <div class="card">
      <h3>Today’s Snapshot</h3>
      <div class="body">
        <div class="gridKpi">
          <div class="kpi"><div class="label">In Processing</div><div class="value" id="kpiQueue">0</div><div class="mini">items waiting</div></div>
          <div class="kpi"><div class="label">Missing CPU</div><div class="value" id="kpiCPU">0</div><div class="mini">quick fix</div></div>
          <div class="kpi"><div class="label">Missing RAM/SSD</div><div class="value" id="kpiMem">0</div><div class="mini">GB fields</div></div>
          <div class="kpi"><div class="label">Most Common</div><div class="value" id="kpiCommon">—</div><div class="mini">condition</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3><div class="rightHead"><span>Processing Form</span><span class="statusLine" id="statusLine">—</span></div></h3>
      <div class="body" id="detail"><div class="hint">Select an item from the queue.</div></div>
    </div>

    <div class="card">
      <h3>PROCESSING Checklist</h3>
      <div class="body">
        <div class="hint">
          Capture specs like you’re writing the listing:
          <br>• Screen size, CPU, RAM, Storage
          <br>• GPU/Series if relevant
          <br>• Features + <b>Connectivity (multi-select)</b> + condition
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===================== CONFIG ===================== */
const API_URL = "https://script.google.com/macros/s/AKfycbwRXMtWXFH35aPQbjnfeA3gvQXnaSgtTZ4tgMiI5Psc6fAFmwj9-WdYG4L04qf0Rj5J/exec"; // <-- REQUIRED
const API_KEY = ""; // optional: match backend API_KEY if you set one

const STAGE = "PROCESSING";
const NEXT_STAGE = "STAGING";
const PREV_STAGE = "INTAKE";

/* TP generator settings (random 9 default) */
const TP_SETTINGS_KEY = "yardflow_tp_settings_v1";
const DEFAULT_TP_SETTINGS = {
  prefix: "",
  includeDate: false,
  sep: "-",
  randLen: 9,
  charset: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
  case: "upper"
};

let dropdowns = {};
let db = [];          // listItems payloads
let currentTP = null; // active TP

/* ===================== UTIL ===================== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display="none", 1600);
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("'","&#39;"); }
function uniq(list){ return [...new Set(list.filter(Boolean))]; }

/* ===================== JSONP GET ===================== */
function apiGet(params){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const timeout = setTimeout(()=>{
      cleanup();
      reject(new Error("API timeout"));
    }, 12000);

    function cleanup(){
      clearTimeout(timeout);
      try{ delete window[cb]; }catch{}
      if (script && script.parentNode) script.parentNode.removeChild(script);
    }

    window[cb] = (data)=>{ cleanup(); resolve(data); };

    const q = new URLSearchParams({ ...params, callback: cb });
    if (API_KEY) q.set("key", API_KEY);

    const url = API_URL + (API_URL.includes("?") ? "&" : "?") + q.toString();
    const script = document.createElement("script");
    script.src = url;
    script.onerror = ()=>{ cleanup(); reject(new Error("API load error")); };
    document.head.appendChild(script);
  });
}

/* ===================== POST (best for larger payloads) ===================== */
async function apiPost(action, payload){
  const url = API_URL + (API_URL.includes("?") ? "&" : "?") + new URLSearchParams({
    action,
    ...(API_KEY ? { key: API_KEY } : {})
  }).toString();

  await fetch(url, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  // verify (JSONP readback)
  if (payload && payload.TP){
    return await apiGet({ action:"readItem", tp: payload.TP });
  }
  return { ok:true };
}

/* ===================== TP generator (same as staging) ===================== */
function loadTpSettings(){
  try{
    return { ...DEFAULT_TP_SETTINGS, ...(JSON.parse(localStorage.getItem(TP_SETTINGS_KEY) || "{}")) };
  }catch{
    return { ...DEFAULT_TP_SETTINGS };
  }
}
function saveTpSettings(s){ localStorage.setItem(TP_SETTINGS_KEY, JSON.stringify(s)); }
function formatDateYYYYMMDD(d=new Date()){
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`;
}
function randomBlock(len, charset){
  len = Math.max(3, Number(len)||9);
  charset = String(charset || DEFAULT_TP_SETTINGS.charset);
  try{
    const arr = new Uint32Array(len);
    crypto.getRandomValues(arr);
    let out = "";
    for (let i=0;i<len;i++) out += charset[arr[i] % charset.length];
    return out;
  }catch{
    let out = "";
    for (let i=0;i<len;i++) out += charset[Math.floor(Math.random()*charset.length)];
    return out;
  }
}
function normalizeTP(tp){
  return String(tp || "").trim().replace(/\s+/g,"").toUpperCase();
}
function generateTP(customOverrides = {}){
  const s = { ...loadTpSettings(), ...customOverrides };
  const parts = [];
  const prefix = String(s.prefix || "").trim();
  if (prefix) parts.push(prefix);
  if (s.includeDate) parts.push(formatDateYYYYMMDD());
  let block = randomBlock(s.randLen, s.charset);
  block = (s.case === "lower") ? block.toLowerCase() : block.toUpperCase();
  parts.push(block);
  const sep = (s.sep ?? "-");
  return parts.join(sep);
}
function tpExistsLocal(tp){ return db.some(x => String(x.TP||"").trim() === tp); }
function generateUniqueTP(){
  for (let i=0;i<100;i++){
    const tp = generateTP();
    if (!tpExistsLocal(tp)) return tp;
  }
  return generateTP({ randLen: (loadTpSettings().randLen || 9) + 2 }) + "-" + Date.now().toString(36).toUpperCase();
}

/* ===================== SHEET DATA ===================== */
async function refreshQueue(){
  const res = await apiGet({ action:"listItems", stage: STAGE, limit: 300 });
  if (!res || !res.ok) throw new Error(res?.error || "Failed listItems");
  db = res.items || [];
}
async function readItem(tp){
  const res = await apiGet({ action:"readItem", tp });
  if (!res || !res.ok) throw new Error(res?.error || "Failed readItem");
  return res.item;
}

/* ===================== DROPDOWNS ===================== */
function selectHTML(list, selected){
  list = list || [];
  return `<option value="">—</option>` + list.map(v=>`<option ${v===selected?'selected':''}>${escapeHtml(v)}</option>`).join("");
}

/* ===================== LIST + KPIs ===================== */
function setFilterOptions(){
  const sel = document.getElementById("filtCondition");
  const values = uniq(db.map(x=>x.Condition).filter(Boolean));
  sel.innerHTML = `<option value="">All</option>` + values.map(v=>`<option>${escapeHtml(v)}</option>`).join("");
}

function renderKPIs(){
  const queue = db;
  document.getElementById("kpiQueue").textContent = queue.length;
  document.getElementById("kpiCPU").textContent = queue.filter(x=>!(x.CPU||"").toString().trim()).length;
  document.getElementById("kpiMem").textContent = queue.filter(x=>!(x.MemoryGB||"").toString().trim() || !(x.StorageGB||"").toString().trim()).length;

  const conds = queue.map(x=>x.Condition).filter(Boolean);
  if (!conds.length) document.getElementById("kpiCommon").textContent = "—";
  else{
    const counts = conds.reduce((m,c)=>(m[c]=(m[c]||0)+1,m),{});
    const top = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
    document.getElementById("kpiCommon").textContent = top;
  }
}

function renderList(){
  const q = (document.getElementById("q").value || "").toLowerCase();
  const cond = document.getElementById("filtCondition").value || "";
  const sortBy = document.getElementById("sortBy").value;

  let list = [...db];
  if (cond) list = list.filter(x => (x.Condition||"") === cond);

  if (q){
    list = list.filter(x=>{
      const hay = [x.TP,x.CPU,x.Series,x.GPU,x.ScreenSizeIn,x.MemoryGB,x.StorageGB,x.Connectivity,x.Features].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  if (sortBy==="newest") list.sort((a,b)=>(Number(b.CreatedAt)||0)-(Number(a.CreatedAt)||0));
  if (sortBy==="oldest") list.sort((a,b)=>(Number(a.CreatedAt)||0)-(Number(b.CreatedAt)||0));
  if (sortBy==="tp") list.sort((a,b)=>(String(a.TP||"")).localeCompare(String(b.TP||"")));

  document.getElementById("queueCount").textContent = list.length;

  const el = document.getElementById("list");
  el.innerHTML = "";

  if (!list.length){
    el.innerHTML = `<div class="hint">No items in ${STAGE}. (Either you’re crushing it… or they’re all hiding.)</div>`;
    setFilterOptions();
    renderKPIs();
    return;
  }

  list.forEach(it=>{
    const d = document.createElement("div");
    d.className = "item";
    d.onclick = ()=> openItem(it.TP);

    const needs = (!it.CPU || !it.MemoryGB || !it.StorageGB)
      ? ` <span class="pill" style="border-color:rgba(255,209,102,.55)">Needs specs</span>` : "";
    const conn = (it.Connectivity||"").trim();

    d.innerHTML = `
      <div class="top">
        <div class="tp">${escapeHtml(it.TP)}</div>
        <div class="pill">${escapeHtml(it.Condition || "—")}</div>
      </div>
      <div class="meta">
        CPU: <b>${escapeHtml(it.CPU || "—")}</b>${needs}<br>
        ${it.ScreenSizeIn?`${escapeHtml(it.ScreenSizeIn)}in`:""}
        ${it.MemoryGB?` • ${escapeHtml(it.MemoryGB)}GB`:""}
        ${it.StorageGB?` • ${escapeHtml(it.StorageGB)}GB`:""}
        ${conn?`<br>Conn: ${escapeHtml(conn)}`:""}
      </div>
    `;
    el.appendChild(d);
  });

  setFilterOptions();
  renderKPIs();
}

/* ===================== FORM HELPERS ===================== */
function affix(id, value, placeholder, suffix){
  return `<div class="affix"><input id="${id}" value="${escapeAttr(value||"")}" placeholder="${escapeAttr(placeholder)}"/><span>${escapeHtml(suffix)}</span></div>`;
}

/* Multi-select Connectivity */
function parseMulti(value){
  return String(value||"")
    .split(",")
    .map(s=>s.trim())
    .filter(Boolean);
}
function renderConnectivityChips(selectedList){
  const selected = new Set(selectedList);
  const opts = (dropdowns.Connectivity && dropdowns.Connectivity.length)
    ? dropdowns.Connectivity
    : ["Wi-Fi","Bluetooth","Ethernet","LTE/5G","USB-C","Thunderbolt","HDMI","Other"];

  return `
    <div class="chips" id="connChips">
      ${opts.map(opt=>{
        const checked = selected.has(opt) ? "checked" : "";
        const on = selected.has(opt) ? "on" : "";
        return `
          <label class="chipBox ${on}">
            <input type="checkbox" value="${escapeAttr(opt)}" ${checked} onchange="syncChipStyles()" />
            <span>${escapeHtml(opt)}</span>
          </label>
        `;
      }).join("")}
    </div>
  `;
}
function syncChipStyles(){
  const wrap = document.getElementById("connChips");
  if(!wrap) return;
  wrap.querySelectorAll(".chipBox").forEach(lbl=>{
    const cb = lbl.querySelector('input[type="checkbox"]');
    lbl.classList.toggle("on", !!cb?.checked);
  });
}
function getConnectivityFromChips(){
  const wrap = document.getElementById("connChips");
  if(!wrap) return "";
  const checked = [...wrap.querySelectorAll('input[type="checkbox"]:checked')].map(i=>i.value);
  return checked.join(", ");
}

/* ===================== ACTIONS ===================== */
async function newItem(){
  const tp = generateUniqueTP();
  const payload = {
    TP: tp,
    Stage: STAGE,
    CreatedAt: Date.now(),
    UpdatedAt: Date.now()
  };
  await apiPost("upsertItem", payload);
  await boot(false);
  await openItem(tp);
  toast("New TP created (sheet)");
}

async function openItem(tp){
  currentTP = tp;
  const it = await readItem(tp);

  document.getElementById("statusLine").textContent = `${it.TP} • Stage: ${it.Stage}`;

  const condList = (dropdowns.Condition && dropdowns.Condition.length)
    ? dropdowns.Condition
    : ["A","B","C","Parts/Repair"];

  document.getElementById("detail").innerHTML = `
    <div class="tpCallout" style="align-items:flex-start;">
      <div style="width:100%;">
        <div style="color:var(--muted); font-size:12px; margin-bottom:6px;">TP Item Number (manual override allowed)</div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; width:100%;">
          <input id="f_TP" value="${escapeAttr(it.TP)}" style="flex:1; min-width:220px; font-family:var(--mono); font-weight:950;" />
          <button class="miniBtn" onclick="copyTP()">Copy</button>
          <button class="miniBtn warn" onclick="regenerateTP()">Regenerate</button>
          <button class="miniBtn good" onclick="applyTPChange()">Apply TP#</button>
        </div>
        <div class="hint" style="margin-top:6px;">Default TP = random 9 alphanumeric. Unique check becomes global via sheet.</div>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Screen Size</div>
        ${affix("f_ScreenSizeIn", it.ScreenSizeIn, "e.g., 15.6", "in")}
      </div>
      <div>
        <div class="lab">CPU</div>
        <input id="f_CPU" value="${escapeAttr(it.CPU||"")}" placeholder="e.g., i7-8650U" />
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Storage</div>
        ${affix("f_StorageGB", it.StorageGB, "e.g., 256", "GB")}
      </div>
      <div>
        <div class="lab">Memory</div>
        ${affix("f_MemoryGB", it.MemoryGB, "e.g., 16", "GB")}
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">GPU</div>
        <input id="f_GPU" value="${escapeAttr(it.GPU||"")}" placeholder="e.g., Intel UHD / RTX 3050" />
      </div>
      <div>
        <div class="lab">Series</div>
        <input id="f_Series" value="${escapeAttr(it.Series||"")}" placeholder="e.g., ThinkPad T / Latitude" />
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Connectivity (multi-select)</div>
        ${renderConnectivityChips(parseMulti(it.Connectivity))}
      </div>
      <div>
        <div class="lab">Condition</div>
        <select id="f_Condition">${selectHTML(condList, it.Condition)}</select>
      </div>
    </div>

    <div class="lab">Features</div>
    <textarea id="f_Features" placeholder="touchscreen, backlit keyboard, fingerprint…">${escapeHtml(it.Features||"")}</textarea>

    <div class="divider"></div>
    <div class="btns">
      <button class="good" onclick="save()">Save</button>
      <button class="warn" onclick="movePrev()">← Back</button>
      <button class="primary" onclick="moveNext()">Next → ${NEXT_STAGE}</button>
      <button class="miniBtn" onclick="refreshCurrent()">Refresh</button>
    </div>

    <div class="hint" style="margin-top:10px">
      Saves <b>Connectivity</b> as comma-separated values in one cell (e.g., <i>Wi-Fi, Bluetooth</i>).
    </div>
  `;

  setTimeout(syncChipStyles, 0);
}

function copyTP(){
  if (!currentTP) return;
  navigator.clipboard.writeText(currentTP);
  toast("TP# copied");
}

async function refreshCurrent(){
  if (!currentTP) return;
  await boot(false);
  await openItem(currentTP);
  toast("Refreshed from sheet");
}

async function applyTPChange(){
  if (!currentTP) return;
  const input = document.getElementById("f_TP");
  const desired = normalizeTP(input?.value);

  if (!desired) { input.value = currentTP; return toast("TP# can't be blank"); }
  if (desired === currentTP) return toast("TP# unchanged");

  const res = await apiGet({ action:"updateTP", oldTp: currentTP, newTp: desired });
  if (!res || !res.ok){
    input.value = currentTP;
    return toast(res?.error || "TP update failed");
  }

  currentTP = desired;
  await boot(false);
  await openItem(desired);
  toast("TP# updated");
}

async function regenerateTP(){
  const input = document.getElementById("f_TP");
  const newTP = generateUniqueTP();
  if (input) input.value = newTP;
  await applyTPChange();
}

async function save(){
  if (!currentTP) return;
  const payload = {
    TP: currentTP,
    Stage: STAGE,
    UpdatedAt: Date.now(),
    ScreenSizeIn: document.getElementById("f_ScreenSizeIn").value.trim(),
    CPU: document.getElementById("f_CPU").value.trim(),
    StorageGB: document.getElementById("f_StorageGB").value.trim(),
    MemoryGB: document.getElementById("f_MemoryGB").value.trim(),
    GPU: document.getElementById("f_GPU").value.trim(),
    Series: document.getElementById("f_Series").value.trim(),
    Condition: document.getElementById("f_Condition").value,
    Connectivity: getConnectivityFromChips(),
    Features: document.getElementById("f_Features").value
  };

  await apiPost("upsertItem", payload);
  await boot(false);
  toast("Saved to sheet");
}

async function moveNext(){
  if (!currentTP) return;
  await save();
  const res = await apiGet({ action:"moveStage", tp: currentTP, stage: NEXT_STAGE });
  if (!res || !res.ok) return toast(res?.error || "Move failed");

  currentTP = null;
  document.getElementById("detail").innerHTML = `<div class="hint">Moved to <b>${NEXT_STAGE}</b>.</div>`;
  document.getElementById("statusLine").textContent = "—";
  await boot(false);
  toast("Forwarded");
}

async function movePrev(){
  if (!currentTP) return;
  await save();
  const res = await apiGet({ action:"moveStage", tp: currentTP, stage: PREV_STAGE });
  if (!res || !res.ok) return toast(res?.error || "Move failed");

  currentTP = null;
  document.getElementById("detail").innerHTML = `<div class="hint">Moved back to <b>${PREV_STAGE}</b>.</div>`;
  document.getElementById("statusLine").textContent = "—";
  await boot(false);
  toast("Backed");
}

/* ===================== TP Settings UI (same style as staging) ===================== */
function openTpSettings(){
  const s = loadTpSettings();
  const preview = generateTP(s);

  document.getElementById("detail").innerHTML = `
    <div class="tpCallout" style="justify-content:space-between; width:100%;">
      <div>
        <div style="color:#666; font-size:12px;">TP Settings (saved to this PC)</div>
        <div class="big" style="margin-top:4px;">${escapeHtml(preview)}</div>
      </div>
      <button class="miniBtn" onclick="${currentTP ? "openItem(currentTP)" : "resetDetail()"}">Back</button>
    </div>

    <div class="row">
      <div>
        <div class="lab">Prefix (optional)</div>
        <input id="tp_prefix" value="${escapeAttr(s.prefix)}" placeholder="TP"/>
      </div>
      <div>
        <div class="lab">Separator</div>
        <input id="tp_sep" value="${escapeAttr(s.sep)}" placeholder="-"/>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Random Length</div>
        <input id="tp_len" type="number" min="3" max="20" value="${Number(s.randLen)||9}"/>
      </div>
      <div>
        <div class="lab">Case</div>
        <select id="tp_case">
          <option value="upper" ${s.case==="upper"?"selected":""}>UPPER</option>
          <option value="lower" ${s.case==="lower"?"selected":""}>lower</option>
        </select>
      </div>
    </div>

    <div class="lab">Include Date (YYYYMMDD)</div>
    <div class="chips">
      <label class="chipBox on" style="cursor:default;">
        <input type="checkbox" id="tp_date" ${s.includeDate ? "checked":""} />
        <span>Include date stamp</span>
      </label>
    </div>

    <div class="lab">Character Set (advanced)</div>
    <input id="tp_charset" value="${escapeAttr(s.charset)}"/>

    <div class="divider"></div>
    <div class="btns">
      <button class="good miniBtn" onclick="saveTpSettingsFromUI()">Save</button>
      <button class="primary miniBtn" onclick="previewTpSettings()">Preview</button>
      <button class="miniBtn warn" onclick="resetTpSettings()">Reset</button>
    </div>

    <div class="lab">Preview</div>
    <input id="tp_preview" readonly value="${escapeAttr(preview)}"/>
  `;
}

function resetDetail(){
  document.getElementById("detail").innerHTML = `<div class="hint">Select an item from the queue.</div>`;
}

function readTpSettingsFromUI(){
  return {
    prefix: String(document.getElementById("tp_prefix")?.value || "").trim(),
    sep: String(document.getElementById("tp_sep")?.value ?? "-"),
    randLen: Number(document.getElementById("tp_len")?.value || 9),
    case: String(document.getElementById("tp_case")?.value || "upper"),
    includeDate: !!document.getElementById("tp_date")?.checked,
    charset: String(document.getElementById("tp_charset")?.value || DEFAULT_TP_SETTINGS.charset).trim()
  };
}
function previewTpSettings(){
  const s = readTpSettingsFromUI();
  document.getElementById("tp_preview").value = generateTP(s);
}
function saveTpSettingsFromUI(){
  const s = readTpSettingsFromUI();
  saveTpSettings(s);
  document.getElementById("tp_preview").value = generateTP(s);
  toast("TP settings saved");
}
function resetTpSettings(){
  saveTpSettings(DEFAULT_TP_SETTINGS);
  toast("TP settings reset");
  openTpSettings();
}

/* ===================== Keyboard shortcuts ===================== */
document.addEventListener("keydown", (e)=>{
  if (e.ctrlKey && (e.key==="f" || e.key==="F")){ e.preventDefault(); document.getElementById("q").focus(); }
  if (e.key==="Enter" && currentTP && document.activeElement && document.activeElement.tagName!=="TEXTAREA"){ e.preventDefault(); save(); }
  if (e.ctrlKey && e.key==="ArrowRight"){ e.preventDefault(); if(currentTP) moveNext(); }
  if (e.ctrlKey && e.key==="ArrowLeft"){ e.preventDefault(); if(currentTP) movePrev(); }
});

/* ===================== Boot ===================== */
async function boot(showToast=true){
  if (!API_URL || API_URL === "PASTE_YOUR_WEB_APP_URL_HERE"){
    document.getElementById("list").innerHTML =
      `<div class="hint"><b>API_URL not set.</b><br>Paste your Apps Script Web App URL into processing.html.</div>`;
    return;
  }
  try{
    const dd = await apiGet({ action:"getDropdowns" });
    dropdowns = dd?.dropdowns || {};
    await refreshQueue();
    renderList();
    renderKPIs();
    if (showToast) toast("Connected to sheet");
  }catch(err){
    document.getElementById("list").innerHTML =
      `<div class="hint"><b>API error.</b><br>${escapeHtml(err.message || String(err))}</div>`;
  }
}
boot();
</script>
</body>
</html>
