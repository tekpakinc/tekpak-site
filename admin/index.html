<script>
/* =========================
   CONFIG
========================= */
const API_URL = "";

/* ========================= */
const $ = (id)=>document.getElementById(id);
const LS_KEY = "tekpak_admin_api_key_v1";

let apiKey = "";
let dropdowns = {};
let items = [];
let editing = null;

let _inFlight = 0;
let _saveLock = false;

function toast(msg, good=true){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  t.style.borderColor = good ? "rgba(61,255,141,.45)" : "rgba(255,77,109,.45)";
  setTimeout(()=> t.style.display="none", 2800);
}

function setApiStatus(ok, msg){
  const el = $("apiStatus");
  el.textContent = ok ? "API: OK" : ("API: " + msg);
  el.style.borderColor = ok ? "rgba(61,255,141,.45)" : "rgba(255,77,109,.45)";
}

async function fetchWithTimeout(url, opts={}, ms=15000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{
    const res = await fetch(url, { ...opts, signal: ctrl.signal, cache:"no-store", redirect:"follow" });
    return res;
  } finally {
    clearTimeout(t);
  }
}

async function api(action, payload={}, {allowOpaque=false} = {}){
  const bodyObj = { action, key: apiKey, ...payload };
  const body = JSON.stringify(bodyObj);

  _inFlight++;
  try{
    const res = await fetchWithTimeout(API_URL + "?t=" + Date.now(), {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body
    }, 20000);

    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); }
    catch(e){ throw new Error("Bad JSON from server:\n" + text.slice(0,220)); }

    if(!data.ok) throw new Error(data.error || "API error");
    return data;

  }catch(err){
    const msg = String(err && err.message ? err.message : err);

    if(allowOpaque){
      // fire-and-forget then refresh
      await fetchWithTimeout(API_URL + "?t=" + Date.now(), {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type":"text/plain;charset=utf-8" },
        body
      }, 20000);
      return { ok:true, opaque:true };
    }

    throw new Error(msg || "Failed to fetch");
  } finally {
    _inFlight--;
  }
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function formatMoney(v){
  const n = Number(String(v||"0").replace(/[^0-9.\-]/g,"") || 0);
  return n.toLocaleString(undefined, {style:"currency", currency:"USD"});
}

function optList(select, values, includeBlank=false, blankLabel="Any"){
  select.innerHTML = "";
  if(includeBlank){
    const o = document.createElement("option");
    o.value=""; o.textContent=blankLabel;
    select.appendChild(o);
  }
  (values||[]).forEach(v=>{
    const o = document.createElement("option");
    o.value=v; o.textContent=v;
    select.appendChild(o);
  });
}

/* ✅ NEW: if current value isn't in dropdown options, inject it so edits don't blank out */
function setSelectValueSafe(select, value){
  const v = String(value || "").trim();
  if(!v){ select.value = ""; return; }
  const exists = Array.from(select.options).some(o => o.value === v);
  if(!exists){
    const o = document.createElement("option");
    o.value = v; o.textContent = v + " (existing)";
    select.appendChild(o);
  }
  select.value = v;
}

function getImgs(item){
  return [item["img1"], item["img2"], item["img3"], item["img4"], item["img5"]].filter(Boolean);
}

function thumbsFor(item){
  const urls = getImgs(item);
  if(!urls.length) return `<span class="muted">—</span>`;
  return `<div class="thumbs">
    ${urls.slice(0,5).map(u=>`
      <div class="thumb" data-img="${escapeHtml(u)}" title="Click to preview">
        <img src="${escapeHtml(u)}" alt="">
      </div>`).join("")}
  </div>`;
}

function buyLinksFor(item){
  const ebay = (item["ebay item url"]||"").trim();
  const pp = (item["paypal button url"]||"").trim();

  let out = "";
  if(ebay) out += `<button class="btn primary ghost" data-open="${escapeHtml(ebay)}">eBay</button> `;
  if(pp) out += `<button class="btn primary ghost" data-open="${escapeHtml(pp)}">PayPal</button>`;
  return out || `<span class="muted">—</span>`;
}

function render(){
  const tb = $("tbody");

  const q = $("q").value.trim().toLowerCase();
  const status = $("fStatus").value;
  const category = $("fCategory").value;
  const location = $("fLocation").value;
  const manufacturer = $("fManufacturer").value;
  const condition = $("fCondition").value;

  const filtered = items.filter(it=>{
    if(status && it["status"]!==status) return false;
    if(category && it["category"]!==category) return false;
    if(location && it["location"]!==location) return false;
    if(manufacturer && it["manufacturer"]!==manufacturer) return false;
    if(condition && it["condition"]!==condition) return false;
    if(q){
      const hay = (
        (it["title"]||"") + " " +
        (it["notes"]||"") + " " +
        (it["serial"]||"") + " " +
        (it["model"]||"") + " " +
        (it["manufacturer"]||"") + " " +
        (it["item id"]||"")
      ).toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  $("countLabel").textContent = `${filtered.length} items`;

  if(!apiKey){
    tb.innerHTML = `<tr><td colspan="13" class="muted" style="padding:14px;">
      Paste your API key up top and click <b>Connect</b>.
    </td></tr>`;
    return;
  }

  if(!filtered.length){
    tb.innerHTML = `<tr><td colspan="13" class="muted" style="padding:14px;">No items match your filters.</td></tr>`;
    return;
  }

  tb.innerHTML = filtered.map(it=>{
    const title = it["title"] || "(untitled)";
    const notes = it["notes"] || "";
    const mm = ((it["manufacturer"]||"") + " " + (it["model"]||"")).trim();
    return `<tr>
      <td>
        <button class="btn" data-edit="${escapeHtml(it["item id"]||"")}">Edit</button>
      </td>
      <td>
        <div style="font-weight:900">${escapeHtml(title)}</div>
        <div class="muted">${escapeHtml(notes.slice(0,120))}${notes.length>120?"…":""}</div>
      </td>
      <td>${formatMoney(it["purchased price"])}</td>
      <td>${formatMoney(it["sold price"])}</td>
      <td>${escapeHtml(it["status"]||"")}</td>
      <td>${escapeHtml(it["category"]||"")}</td>
      <td>${escapeHtml(it["location"]||"")}</td>
      <td>${escapeHtml(mm||"")}</td>
      <td class="mini">${escapeHtml(it["serial"]||"")}</td>
      <td>${thumbsFor(it)}</td>
      <td>${buyLinksFor(it)}</td>
      <td class="muted">${escapeHtml((notes||"").slice(0,90))}${(notes||"").length>90?"…":""}</td>
      <td class="mini">${escapeHtml(it["item id"]||"")}</td>
    </tr>`;
  }).join("");

  tb.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-edit");
      const found = items.find(x => (x["item id"]||"") === id);
      openEditor(found);
    });
  });

  tb.querySelectorAll(".thumb").forEach(t=>{
    t.addEventListener("click", ()=>{
      const url = t.getAttribute("data-img");
      openLightbox(url);
    });
  });

  tb.querySelectorAll("[data-open]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const url = b.getAttribute("data-open");
      window.open(url, "_blank", "noopener");
    });
  });
}

function openLightbox(url){
  $("lightboxImg").src = url;
  $("lightbox").style.display = "flex";
}
$("lightbox").addEventListener("click", ()=> $("lightbox").style.display="none");

function openEditor(item){
  // ✅ NEW: store original id for reliable updates (even if user changes Item ID)
  const origId = item ? (item["item id"] || "") : "";

  editing = item ? {...item, _origId: origId} : {
    "item id": "",
    "location": "",
    "title": "",
    "purchased price": "0",
    "sold price": "0",
    "status": "",
    "category": "",
    "manufacturer": "",
    "model": "",
    "serial": "",
    "condition": "",
    "img1": "", "img2": "", "img3": "", "img4": "", "img5": "",
    "ebay item url": "",
    "paypal button url": "",
    "notes": "",
    _origId: ""
  };

  $("modalTitle").textContent = item ? "Edit Item" : "New Item";
  $("modalId").textContent = editing["item id"] ? editing["item id"] : "new";

  $("e_title").value = editing["title"] || "";
  $("e_purchased").value = editing["purchased price"] || "0";
  $("e_sold").value = editing["sold price"] || "0";

  // ✅ Safe select setting (won't blank if value isn't in dropdown list)
  setSelectValueSafe($("e_status"), editing["status"] || "");
  setSelectValueSafe($("e_category"), editing["category"] || "");
  setSelectValueSafe($("e_location"), editing["location"] || "");
  setSelectValueSafe($("e_manufacturer"), editing["manufacturer"] || "");
  setSelectValueSafe($("e_condition"), editing["condition"] || "");

  $("e_model").value = editing["model"] || "";
  $("e_serial").value = editing["serial"] || "";

  $("e_id").value = editing["item id"] || "";
  $("e_notes").value = editing["notes"] || "";

  $("e_img1").value = editing["img1"] || "";
  $("e_img2").value = editing["img2"] || "";
  $("e_img3").value = editing["img3"] || "";
  $("e_img4").value = editing["img4"] || "";
  $("e_img5").value = editing["img5"] || "";

  $("e_ebay").value = editing["ebay item url"] || "";
  $("e_paypal").value = editing["paypal button url"] || "";

  $("modal").style.display = "flex";
  updatePreviewButtons_();
}

function closeEditor(){
  $("modal").style.display = "none";
  editing = null;
}

function numClean(s){
  return String(s||"0").replace(/[^0-9.\-]/g,"") || "0";
}

function updatePreviewButtons_(){
  const ebay = $("e_ebay").value.trim();
  const pp = $("e_paypal").value.trim();
  $("btnOpenEbay").disabled = !ebay;
  $("btnOpenPaypal").disabled = !pp;
}

async function saveEditor(){
  if(!editing) return;
  if(_saveLock) return;
  _saveLock = true;

  const btn = $("btnSave");
  const prevText = btn.textContent;
  btn.textContent = "Saving…";
  btn.disabled = true;

  const title = $("e_title").value.trim();
  if(!title){
    toast("Title is required.", false);
    btn.textContent = prevText; btn.disabled = false;
    _saveLock = false;
    return;
  }

  const payload = {
    "item id": $("e_id").value.trim(),
    "location": $("e_location").value.trim(),
    "title": title,
    "purchased price": numClean($("e_purchased").value),
    "sold price": numClean($("e_sold").value),
    "status": $("e_status").value.trim(),
    "category": $("e_category").value.trim(),
    "manufacturer": $("e_manufacturer").value.trim(),
    "model": $("e_model").value.trim(),
    "serial": $("e_serial").value.trim(),
    "condition": $("e_condition").value.trim(),
    "img1": $("e_img1").value.trim(),
    "img2": $("e_img2").value.trim(),
    "img3": $("e_img3").value.trim(),
    "img4": $("e_img4").value.trim(),
    "img5": $("e_img5").value.trim(),
    "ebay item url": $("e_ebay").value.trim(),
    "paypal button url": $("e_paypal").value.trim(),
    "notes": $("e_notes").value.trim()
  };

  try{
    // ✅ NEW: match_id ensures update hits the original row even if Item ID changed
    const res = await api("upsertItem", {
      actor:"tekpak-admin",
      match_id: editing._origId || "",
      item: payload
    }, { allowOpaque:true });

    if(res && res.opaque){
      toast("Saved (confirmed by refresh) ✓");
      await refresh();
      closeEditor();
      render();
    } else {
      const saved = res.data;
      const id = saved["item id"];
      const idx = items.findIndex(x => (x["item id"]||"") === id);
      if(idx >= 0) items[idx] = saved;
      else items.unshift(saved);

      toast("Saved ✓");
      closeEditor();
      render();
    }

  }catch(err){
    toast(err.message || "Save failed", false);
  }finally{
    btn.textContent = prevText;
    btn.disabled = false;
    _saveLock = false;
  }
}

async function refresh(){
  if(!apiKey){ render(); return; }
  try{
    const res = await api("listItems", {});
    items = res.data || [];
    $("lastSync").textContent = "Last sync: " + new Date().toLocaleString();
    render();
  }catch(err){
    toast(err.message, false);
  }
}

async function loadDropdowns(){
  if(!apiKey) return;
  const res = await api("getDropdowns", {});
  dropdowns = res.data || {};

  optList($("fStatus"), dropdowns.status || [], true);
  optList($("fCategory"), dropdowns.category || [], true);
  optList($("fLocation"), dropdowns.location || [], true);
  optList($("fManufacturer"), dropdowns.manufacturer || [], true);
  optList($("fCondition"), dropdowns.condition || [], true);

  optList($("e_status"), dropdowns.status || [], false, "Select");
  optList($("e_category"), dropdowns.category || [], false, "Select");
  optList($("e_location"), dropdowns.location || [], false, "Select");
  optList($("e_manufacturer"), dropdowns.manufacturer || [], false, "Select");
  optList($("e_condition"), dropdowns.condition || [], false, "Select");
}

async function connect(){
  apiKey = $("apiKey").value.trim();
  if(!apiKey){
    toast("Paste API key first.", false);
    return;
  }
  localStorage.setItem(LS_KEY, apiKey);

  try{
    const r = await fetchWithTimeout(API_URL + "?action=ping&t=" + Date.now(), { method:"GET", mode:"cors" }, 15000);
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || "Ping failed");
    setApiStatus(true, "OK");

    await loadDropdowns();
    await refresh();
    toast("Connected ✓");
  }catch(err){
    setApiStatus(false, "FAIL");
    toast(err.message, false);
  }
}

/* Wire UI */
$("btnConnect").addEventListener("click", connect);
$("btnRefresh").addEventListener("click", refresh);
$("btnNew").addEventListener("click", ()=> openEditor(null));
$("btnClose").addEventListener("click", closeEditor);
$("btnSave").addEventListener("click", saveEditor);

$("btnApply").addEventListener("click", render);
$("btnClear").addEventListener("click", ()=>{
  $("q").value = "";
  $("fStatus").value = "";
  $("fCategory").value = "";
  $("fLocation").value = "";
  $("fManufacturer").value = "";
  $("fCondition").value = "";
  render();
});

$("q").addEventListener("input", render);

document.addEventListener("keydown", (e)=>{
  if(e.ctrlKey && e.key.toLowerCase() === "k"){
    e.preventDefault();
    $("q").focus();
  }
  if(e.key === "Escape"){
    if($("lightbox").style.display === "flex") $("lightbox").style.display = "none";
    if($("modal").style.display === "flex") closeEditor();
  }
});

$("modal").addEventListener("click", (e)=>{
  if(e.target === $("modal")) closeEditor();
});

$("btnPreviewImg").addEventListener("click", ()=>{
  const urls = [
    $("e_img1").value.trim(),
    $("e_img2").value.trim(),
    $("e_img3").value.trim(),
    $("e_img4").value.trim(),
    $("e_img5").value.trim()
  ].filter(Boolean);
  if(!urls.length){ toast("No image URLs yet.", false); return; }
  openLightbox(urls[0]);
});

$("btnOpenEbay").addEventListener("click", ()=>{
  const u = $("e_ebay").value.trim();
  if(u) window.open(u, "_blank", "noopener");
});
$("btnOpenPaypal").addEventListener("click", ()=>{
  const u = $("e_paypal").value.trim();
  if(u) window.open(u, "_blank", "noopener");
});

["e_ebay","e_paypal"].forEach(id=>{
  $(id).addEventListener("input", updatePreviewButtons_);
});

/* Export JSON */
$("btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(items, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "tekpak-inventory-export.json";
  a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
});

/* Boot */
(function boot(){
  const saved = localStorage.getItem(LS_KEY) || "";
  $("apiKey").value = saved;
  apiKey = saved.trim();

  fetch(API_URL + "?action=ping&t=" + Date.now())
    .then(r=>r.json())
    .then(j=> setApiStatus(!!j.ok, j.ok ? "OK" : "FAIL"))
    .catch(()=> setApiStatus(false, "FAIL"));

  render();
})();
</script>
