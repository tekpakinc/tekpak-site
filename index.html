<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Tek-Pak Surplus Store</title>
  <style>
    :root{
      --bg:#0b0f13;
      --panel:#101822;
      --panel2:#0e141d;
      --border:rgba(255,255,255,.10);
      --text:#e9f2ff;
      --muted:rgba(233,242,255,.65);

      --lime:#7CFF3A;
      --blue:#2b6cb0;
      --yellow:#f5c000;

      --shadow:0 18px 45px rgba(0,0,0,.55);
      --shadow2:0 12px 28px rgba(0,0,0,.45);

      --radius:18px;
      --radius2:24px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;

      --glass: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      --gloss: radial-gradient(900px 420px at 12% 0%, rgba(124,255,58,.18), transparent 55%),
               radial-gradient(800px 420px at 92% 8%, rgba(43,108,176,.20), transparent 60%),
               radial-gradient(900px 520px at 55% 105%, rgba(245,192,0,.10), transparent 65%);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        var(--gloss),
        radial-gradient(1200px 800px at 30% -10%, rgba(124,255,58,.10), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(43,108,176,.12), transparent 60%),
        radial-gradient(1100px 900px at 50% 120%, rgba(0,0,0,.65), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }

    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}

    /* Top Bar */
    .topbar{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(14px);
      background: rgba(11,15,19,.72);
      border-bottom:1px solid var(--border);
    }
    .topbar .wrap{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 18px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width:240px;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 25%, rgba(255,255,255,.55), transparent 55%),
        linear-gradient(145deg, rgba(124,255,58,.28), rgba(43,108,176,.24)),
        rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 28px rgba(0,0,0,.45);
      display:grid; place-items:center;
      font-weight:900;
      letter-spacing:.5px;
    }
    .brand h1{
      margin:0;
      font-size:14px;
      line-height:1.1;
      letter-spacing:.4px;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 4px rgba(255,255,255,.05);
    }
    .dot.ok{background: var(--lime); box-shadow:0 0 0 4px rgba(124,255,58,.12)}
    .dot.bad{background: #ff5a5a; box-shadow:0 0 0 4px rgba(255,90,90,.12)}

    /* Controls */
    .controls{
      margin:18px 0 14px;
      display:grid;
      grid-template-columns: 1.4fr .8fr .8fr .8fr .7fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .controls{grid-template-columns: 1fr; }
      .brand{min-width:unset}
    }

    .field{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow2);
      padding:10px 12px;
      display:flex; gap:10px; align-items:center;
      position:relative;
      overflow:hidden;
    }
    .field::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(124,255,58,.18), rgba(43,108,176,.14), rgba(245,192,0,.10));
      opacity:.25;
      filter: blur(18px);
      pointer-events:none;
    }
    .field > *{position:relative; z-index:1}

    .field input, .field select{
      width:100%;
      background: transparent;
      border:0;
      outline:none;
      color: var(--text);
      font-size:14px;
      appearance:none;
    }
    .field select{cursor:pointer}
    .field small{color:var(--muted); font-family:var(--mono); font-size:12px}

    .btn{
      cursor:pointer;
      user-select:none;
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      padding:10px 12px;
      background:
        radial-gradient(18px 18px at 25% 20%, rgba(255,255,255,.55), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      color: var(--text);
      font-weight:700;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.07)}
    .btn:active{transform: translateY(0px); filter: brightness(.98)}

    .toggle{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .switch{
      width:46px; height:26px; border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      position:relative;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      flex: 0 0 auto;
      cursor:pointer;
    }
    .knob{
      position:absolute; top:3px; left:3px;
      width:20px; height:20px; border-radius:999px;
      background:
        radial-gradient(10px 10px at 30% 25%, rgba(255,255,255,.55), transparent 60%),
        rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.14);
      transition: left .18s ease, background .18s ease;
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
    }
    .switch.on{
      background: rgba(124,255,58,.14);
      border-color: rgba(124,255,58,.22);
    }
    .switch.on .knob{left:23px; background: rgba(124,255,58,.35);}

    /* Grid */
    .meta{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin:10px 0 14px;
      flex-wrap:wrap;
    }
    .meta .count{color:var(--muted); font-size:13px}
    .meta .hint{color:var(--muted); font-size:12px}
    .meta .hint code{font-family:var(--mono); color:rgba(233,242,255,.9);}

    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:14px;
      padding-bottom:40px;
    }
    @media (max-width: 1100px){ .grid{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 820px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{grid-template-columns: 1fr;} }

    .card{
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
      min-height: 320px;
      transform: translateZ(0);
      transition: transform .14s ease, filter .14s ease;
    }
    .card:hover{transform: translateY(-2px); filter: brightness(1.03)}
    .img{
      height:170px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      position:relative;
      overflow:hidden;
    }
    .img img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .img .badge{
      position:absolute; top:10px; left:10px;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.92);
      font-size:12px;
      backdrop-filter: blur(8px);
    }
    .img .badge.lime{border-color: rgba(124,255,58,.25); background: rgba(124,255,58,.12)}
    .img .badge.blue{border-color: rgba(43,108,176,.25); background: rgba(43,108,176,.12)}
    .img .badge.yellow{border-color: rgba(245,192,0,.25); background: rgba(245,192,0,.12)}

    .body{
      padding:12px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
    }
    .title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:14px;
      margin:0;
      line-height:1.2;
    }
    .desc{
      margin:0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
      min-height: 48px;
    }
    .row{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-top:auto;
      padding-top:6px;
    }
    .price{
      font-weight:900;
      font-size:16px;
      letter-spacing:.2px;
    }
    .stock{
      font-size:12px; color:var(--muted);
      font-family: var(--mono);
    }
    .actions{
      padding:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .btn2{
      cursor:pointer;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      background: rgba(255,255,255,.05);
      color:var(--text);
      font-weight:800;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .btn2:hover{transform: translateY(-1px); filter:brightness(1.06)}
    .btn2.primary{
      border-color: rgba(124,255,58,.26);
      background: linear-gradient(180deg, rgba(124,255,58,.22), rgba(255,255,255,.04));
    }
    .btn2.disabled{
      opacity:.55; cursor:not-allowed;
      filter:saturate(.7);
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      padding:18px;
    }
    .modal.show{display:flex}
    .sheet{
      width:min(980px, 100%);
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(14,20,29,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .sheetHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .sheetHead .left{display:flex; flex-direction:column; gap:4px}
    .sheetHead h2{margin:0; font-size:15px; letter-spacing:.2px}
    .sheetHead .tiny{color:var(--muted); font-size:12px; font-family:var(--mono)}
    .close{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      user-select:none;
    }

    .sheetBody{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:0;
    }
    @media (max-width: 860px){
      .sheetBody{grid-template-columns: 1fr}
    }
    .gallery{
      padding:14px;
      border-right:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    @media (max-width: 860px){
      .gallery{border-right:0; border-bottom:1px solid rgba(255,255,255,.10)}
    }
    .hero{
      width:100%;
      height:360px;
      border-radius: 20px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .hero img{width:100%; height:100%; object-fit:cover; display:block}
    .thumbs{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:8px;
    }
    .thumb{
      height:58px;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      opacity:.92;
      transition: transform .1s ease, opacity .1s ease;
    }
    .thumb:hover{transform: translateY(-1px); opacity:1}
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}

    .details{
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kv .box{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      padding:10px 12px;
    }
    .kv .k{font-size:11px; color:var(--muted); font-family:var(--mono)}
    .kv .v{font-size:13px; margin-top:2px; font-weight:800}
    .long{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.04);
      padding:12px;
      color: rgba(233,242,255,.85);
      font-size:13px;
      line-height:1.45;
      white-space:pre-wrap;
      max-height: 220px;
      overflow:auto;
    }
    .buyRow{
      margin-top:auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .buyRow{grid-template-columns:1fr}
    }
    .note{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }

    /* Skeleton / Toast */
    .toast{
      position:fixed;
      right:16px; bottom:16px;
      z-index:120;
      display:none;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      padding:12px 14px;
      box-shadow: var(--shadow2);
      color:rgba(255,255,255,.92);
      font-size:13px;
      max-width: 340px;
    }
    .toast.show{display:block}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="wrap">
      <div class="brand">
        <div class="logo" title="Tek-Pak">TP</div>
        <div>
          <h1>Tek-Pak Surplus Store</h1>
          <div class="sub">Live inventory pulled from your spreadsheet</div>
        </div>
      </div>

      <div class="pill" id="apiStatus">
        <span class="dot" id="apiDot"></span>
        <span id="apiText">Connecting‚Ä¶</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="controls">
      <div class="field" title="Search by name, SKU, description, etc.">
        <small>Search</small>
        <input id="q" placeholder="Try: dell, i7, ThinkPad, monitor, etc‚Ä¶" autocomplete="off" />
      </div>

      <div class="field">
        <small>Category</small>
        <select id="cat"><option value="">All</option></select>
      </div>

      <div class="field">
        <small>Manufacturer</small>
        <select id="mfg"><option value="">All</option></select>
      </div>

      <div class="field">
        <small>Condition</small>
        <select id="cond"><option value="">All</option></select>
      </div>

      <div class="field toggle" title="Hide anything that isn't Listed/Live">
        <div>
          <small>Listed only</small>
          <div style="font-size:12px;color:var(--muted);margin-top:2px;">Hide Hold / Draft</div>
        </div>
        <div class="switch on" id="listedSwitch" role="switch" aria-checked="true">
          <div class="knob"></div>
        </div>
      </div>

      <div class="field">
        <small>Sort</small>
        <select id="sort">
          <option value="new">Newest (best guess)</option>
          <option value="priceAsc">Price: low ‚Üí high</option>
          <option value="priceDesc">Price: high ‚Üí low</option>
          <option value="nameAsc">Name: A ‚Üí Z</option>
        </select>
      </div>

      <div class="btn" id="refreshBtn">‚ü≤ Refresh</div>
    </div>

    <div class="meta">
      <div class="count" id="count">Loading inventory‚Ä¶</div>
      <div class="hint">Tip: put your PayPal link in a column like <code>paypal</code> or <code>buyLink</code> for instant ‚ÄúBuy Now‚Äù.</div>
    </div>

    <div class="grid" id="grid"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHead">
        <div class="left">
          <h2 id="mTitle">Item</h2>
          <div class="tiny" id="mSub">‚Äî</div>
        </div>
        <div class="close" id="closeBtn">‚úï Close</div>
      </div>
      <div class="sheetBody">
        <div class="gallery">
          <div class="hero"><img id="mHero" alt="" /></div>
          <div class="thumbs" id="thumbs"></div>
        </div>
        <div class="details">
          <div class="kv">
            <div class="box"><div class="k">Price</div><div class="v" id="mPrice">$‚Äî</div></div>
            <div class="box"><div class="k">Stock</div><div class="v" id="mStock">‚Äî</div></div>
            <div class="box"><div class="k">Category</div><div class="v" id="mCat">‚Äî</div></div>
            <div class="box"><div class="k">Condition</div><div class="v" id="mCond">‚Äî</div></div>
          </div>

          <div class="long" id="mDesc">‚Äî</div>

          <div class="buyRow">
            <div class="btn2" id="copyBtn">üìã Copy details</div>
            <a class="btn2 primary" id="buyBtn" href="#" target="_blank" rel="noopener">üí≥ Buy Now</a>
          </div>
          <div class="note" id="mNote"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================================================
  TEK-PAK STOREFRONT (GitHub Pages)
  - Pulls inventory JSON from your Apps Script web app
  - Flexible column mapping
========================================================= */

/* 1) SET THIS */
const API_BASE = "https://script.google.com/macros/s/AKfycbyLMf07vAWn1qdtL_FMVvCRf6GytYvXAtbzTLgqZRHurZisb7Qba4gYtsTwkhL-8vJu/exec";

/* 2) If your API uses a specific action for storefront, set it here.
   We'll try these in order until one works:
   - ?action=public
   - ?action=list
   - (no action)
*/
const ACTION_CANDIDATES = ["public", "list", ""];

/* 3) Hide items if ANY field contains this keyword (helps keep internal ‚Äúassets‚Äù off the store) */
const HIDE_IF_CONTAINS = ["asset"];

/* =========================
   DOM
========================= */
const el = (id)=>document.getElementById(id);
const grid = el("grid");
const countEl = el("count");
const apiText = el("apiText");
const apiDot  = el("apiDot");

const qEl = el("q");
const catEl = el("cat");
const mfgEl = el("mfg");
const condEl = el("cond");
const sortEl = el("sort");
const refreshBtn = el("refreshBtn");

const listedSwitch = el("listedSwitch");

/* Modal */
const modal = el("modal");
const closeBtn = el("closeBtn");
const mTitle = el("mTitle");
const mSub = el("mSub");
const mHero = el("mHero");
const thumbs = el("thumbs");
const mPrice = el("mPrice");
const mStock = el("mStock");
const mCat = el("mCat");
const mCond = el("mCond");
const mDesc = el("mDesc");
const buyBtn = el("buyBtn");
const copyBtn = el("copyBtn");
const mNote = el("mNote");

const toast = el("toast");

/* =========================
   State
========================= */
let raw = [];      // normalized items
let view = [];     // filtered/sorted items
let listedOnly = true;

const money = new Intl.NumberFormat(undefined, { style:"currency", currency:"USD" });

/* =========================
   Helpers
========================= */
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.classList.remove("show"), 2200);
}

function safeStr(v){
  if(v === null || v === undefined) return "";
  return String(v).trim();
}
function lower(v){ return safeStr(v).toLowerCase(); }

function pick(obj, keys){
  // finds first matching key (case-insensitive)
  const map = new Map(Object.keys(obj).map(k=>[k.toLowerCase(), k]));
  for(const k of keys){
    const hit = map.get(k.toLowerCase());
    if(hit) return obj[hit];
  }
  return undefined;
}

function parsePrice(v){
  const s = safeStr(v).replace(/[^0-9.]/g,"");
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

function parseQty(v){
  const n = Number(String(v).replace(/[^0-9.-]/g,""));
  return Number.isFinite(n) ? n : null;
}

function firstNonEmpty(arr){
  for(const v of arr){
    const s = safeStr(v);
    if(s) return s;
  }
  return "";
}

function splitImages(v){
  // accept:
  // - comma-separated list
  // - newline list
  // - single url
  const s = safeStr(v);
  if(!s) return [];
  const parts = s
    .split(/[\n,]/g)
    .map(x=>x.trim())
    .filter(Boolean);
  // de-dupe
  return [...new Set(parts)];
}

function looksHidden(item){
  const blob = JSON.stringify(item).toLowerCase();
  return HIDE_IF_CONTAINS.some(k => blob.includes(k));
}

function normalizeRow(row){
  // Try to map your sheet columns into standard fields
  const name = firstNonEmpty([
    pick(row, ["name","title","item","product","listing","item name","product name","inventory item"]),
    row.Name, row.Title
  ]);

  const sku = firstNonEmpty([
    pick(row, ["sku","id","itemid","item id","asset tag","assettag","serial","serial number","tag"]),
  ]);

  const desc = firstNonEmpty([
    pick(row, ["description","desc","details","notes","note"]),
  ]);

  const category = firstNonEmpty([
    pick(row, ["category","type","cat"]),
  ]);

  const manufacturer = firstNonEmpty([
    pick(row, ["manufacturer","brand","make","mfg"]),
  ]);

  const condition = firstNonEmpty([
    pick(row, ["condition","grade","state"]),
  ]);

  const status = firstNonEmpty([
    pick(row, ["status","listing status","state"]),
  ]);

  const location = firstNonEmpty([
    pick(row, ["location","bin","shelf","where","warehouse location"]),
  ]);

  const priceNum = parsePrice(firstNonEmpty([
    pick(row, ["price","cost","sale price","list price","amount"]),
  ]));

  const qtyNum = parseQty(firstNonEmpty([
    pick(row, ["qty","quantity","stock","on hand","onhand","inventory","count"]),
  ]));

  const paypal = firstNonEmpty([
    pick(row, ["paypal","paypal link","buy","buy link","buylink","purchase","checkout","url","link"]),
  ]);

  // images can be: Images (csv), Image, Image 1..6, Photo 1..6, etc
  const imagesCsv = pick(row, ["images","image urls","photos","photo urls"]);
  const img1 = pick(row, ["image","img","image 1","img 1","photo 1","pic 1","picture 1"]);
  const img2 = pick(row, ["image 2","img 2","photo 2","pic 2","picture 2"]);
  const img3 = pick(row, ["image 3","img 3","photo 3","pic 3","picture 3"]);
  const img4 = pick(row, ["image 4","img 4","photo 4","pic 4","picture 4"]);
  const img5 = pick(row, ["image 5","img 5","photo 5","pic 5","picture 5"]);
  const img6 = pick(row, ["image 6","img 6","photo 6","pic 6","picture 6"]);

  const images = [
    ...splitImages(imagesCsv),
    ...splitImages(img1),
    ...splitImages(img2),
    ...splitImages(img3),
    ...splitImages(img4),
    ...splitImages(img5),
    ...splitImages(img6),
  ].filter(Boolean);

  // best-guess created/updated date for "newest"
  const dateGuess = firstNonEmpty([
    pick(row, ["created","created at","date","date added","timestamp","updated","updated at"]),
  ]);

  return {
    _raw: row,
    name: name || "(Unnamed item)",
    sku,
    desc,
    category,
    manufacturer,
    condition,
    status,
    location,
    price: priceNum,
    qty: qtyNum,
    paypal,
    images,
    dateGuess
  };
}

function isListed(item){
  // show if status contains "listed", "live", "active", or status is blank (some sheets don't have status)
  const s = lower(item.status);
  if(!s) return true;
  if(s.includes("hold")) return false;
  return (s.includes("listed") || s.includes("live") || s.includes("active") || s.includes("yes"));
}

function searchBlob(item){
  return [
    item.name, item.sku, item.desc, item.category, item.manufacturer, item.condition, item.status, item.location
  ].map(safeStr).join(" ").toLowerCase();
}

function sortItems(arr){
  const mode = sortEl.value;
  const copy = [...arr];

  if(mode === "priceAsc"){
    copy.sort((a,b)=>(a.price ?? 1e18) - (b.price ?? 1e18));
  } else if(mode === "priceDesc"){
    copy.sort((a,b)=>(b.price ?? -1) - (a.price ?? -1));
  } else if(mode === "nameAsc"){
    copy.sort((a,b)=>a.name.localeCompare(b.name));
  } else {
    // "newest" best guess:
    // try dateGuess parse; fallback to original order (already returned order)
    copy.sort((a,b)=>{
      const da = Date.parse(a.dateGuess || "");
      const db = Date.parse(b.dateGuess || "");
      if(Number.isFinite(db) && Number.isFinite(da)) return db-da;
      if(Number.isFinite(db)) return 1;
      if(Number.isFinite(da)) return -1;
      return 0;
    });
  }
  return copy;
}

function buildSelectOptions(items){
  const uniq = (vals)=>[...new Set(vals.filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  const cats = uniq(items.map(x=>x.category));
  const mfgs = uniq(items.map(x=>x.manufacturer));
  const conds = uniq(items.map(x=>x.condition));

  const fill = (select, list)=>{
    const keep = select.value;
    select.innerHTML = `<option value="">All</option>` + list.map(v=>`<option>${escapeHtml(v)}</option>`).join("");
    select.value = keep;
  };

  fill(catEl, cats);
  fill(mfgEl, mfgs);
  fill(condEl, conds);
}

function escapeHtml(s){
  return safeStr(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function cardTemplate(item){
  const img = item.images[0] || "";
  const priceText = item.price != null ? money.format(item.price) : "Call / Message";
  const qtyText = item.qty != null ? `QTY: ${item.qty}` : (item.status ? `Status: ${item.status}` : "‚Äî");

  const badge = item.category || item.manufacturer || "Surplus";
  const badgeClass = item.category ? "lime" : (item.manufacturer ? "blue" : "yellow");

  const canBuy = !!safeStr(item.paypal);

  return `
    <div class="card">
      <div class="img">
        ${img ? `<img loading="lazy" src="${escapeHtml(img)}" alt="${escapeHtml(item.name)}">` : ``}
        <div class="badge ${badgeClass}">${escapeHtml(badge)}</div>
      </div>
      <div class="body">
        <h3 class="title">${escapeHtml(item.name)}</h3>
        <p class="desc">${escapeHtml(item.desc || "No description yet. (If you add a Description column in your sheet, it will show here.)")}</p>
        <div class="row">
          <div class="price">${escapeHtml(priceText)}</div>
          <div class="stock">${escapeHtml(qtyText)}</div>
        </div>
      </div>
      <div class="actions">
        <div class="btn2" data-act="view">üëÄ View</div>
        <div class="btn2 primary ${canBuy ? "" : "disabled"}" data-act="buy">${canBuy ? "üí≥ Buy Now" : "üí¨ Inquire"}</div>
      </div>
    </div>
  `;
}

function render(){
  const q = lower(qEl.value);
  const cat = safeStr(catEl.value);
  const mfg = safeStr(mfgEl.value);
  const cond = safeStr(condEl.value);

  view = raw
    .filter(item => !looksHidden(item))
    .filter(item => !listedOnly || isListed(item))
    .filter(item => !cat || item.category === cat)
    .filter(item => !mfg || item.manufacturer === mfg)
    .filter(item => !cond || item.condition === cond)
    .filter(item => !q || searchBlob(item).includes(q));

  view = sortItems(view);

  countEl.textContent = `${view.length} item(s) shown${listedOnly ? " (Listed only)" : ""}`;

  grid.innerHTML = view.map(cardTemplate).join("");

  // Bind actions
  [...grid.querySelectorAll(".card")].forEach((card, idx)=>{
    card.querySelector('[data-act="view"]').addEventListener("click", ()=>openModal(view[idx]));
    card.querySelector('[data-act="buy"]').addEventListener("click", ()=>{
      const item = view[idx];
      if(safeStr(item.paypal)){
        window.open(item.paypal, "_blank", "noopener");
      } else {
        openModal(item);
        showToast("No buy link found. Add a PayPal link column to enable Buy Now.");
      }
    });
  });
}

function openModal(item){
  mTitle.textContent = item.name || "Item";
  const bits = [];
  if(item.sku) bits.push(`SKU: ${item.sku}`);
  if(item.manufacturer) bits.push(item.manufacturer);
  if(item.location) bits.push(`Loc: ${item.location}`);
  mSub.textContent = bits.join(" ‚Ä¢ ") || "‚Äî";

  const imgs = item.images.length ? item.images : [""];
  mHero.src = imgs[0] || "";
  mHero.alt = item.name || "";

  thumbs.innerHTML = imgs.slice(0,6).map((u,i)=>`
    <div class="thumb" data-i="${i}">
      ${u ? `<img src="${escapeHtml(u)}" alt="">` : ``}
    </div>
  `).join("");

  [...thumbs.querySelectorAll(".thumb")].forEach(t=>{
    t.addEventListener("click", ()=>{
      const i = Number(t.dataset.i);
      mHero.src = imgs[i] || imgs[0] || "";
    });
  });

  mPrice.textContent = item.price != null ? money.format(item.price) : "‚Äî";
  mStock.textContent = item.qty != null ? String(item.qty) : (item.status || "‚Äî");
  mCat.textContent = item.category || "‚Äî";
  mCond.textContent = item.condition || "‚Äî";
  mDesc.textContent = item.desc || "No description provided yet.";

  const buy = safeStr(item.paypal);
  buyBtn.href = buy || "#";
  buyBtn.classList.toggle("disabled", !buy);
  buyBtn.textContent = buy ? "üí≥ Buy Now" : "üí¨ No Buy Link";

  mNote.textContent = buy
    ? "Opens your PayPal checkout link in a new tab."
    : "To enable Buy Now, add a column like PayPal / Buy Link in your sheet.";

  copyBtn.onclick = async ()=>{
    const text =
`Tek-Pak Surplus Item
Name: ${item.name || ""}
SKU: ${item.sku || ""}
Price: ${item.price != null ? money.format(item.price) : ""}
Category: ${item.category || ""}
Manufacturer: ${item.manufacturer || ""}
Condition: ${item.condition || ""}
Status: ${item.status || ""}
Location: ${item.location || ""}

Details:
${item.desc || ""}

Buy:
${item.paypal || ""}`.trim();

    try{
      await navigator.clipboard.writeText(text);
      showToast("Copied item details üìã");
    }catch{
      showToast("Couldn‚Äôt copy (browser blocked).");
    }
  };

  modal.classList.add("show");
}
function closeModal(){
  modal.classList.remove("show");
}
closeBtn.addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });
window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

/* =========================
   API Fetch
========================= */
function setApiStatus(ok, msg){
  apiDot.className = "dot " + (ok ? "ok" : "bad");
  apiText.textContent = msg;
}

async function fetchAny(){
  // Try candidates in order
  const tries = [];
  for(const act of ACTION_CANDIDATES){
    const url = act ? `${API_BASE}?action=${encodeURIComponent(act)}&t=${Date.now()}` : `${API_BASE}?t=${Date.now()}`;
    tries.push(url);
  }

  let lastErr = null;

  for(const url of tries){
    try{
      setApiStatus(true, "Loading inventory‚Ä¶");
      const res = await fetch(url, { cache:"no-store" });
      const text = await res.text();

      // Attempt to parse JSON
      let data;
      try { data = JSON.parse(text); }
      catch { throw new Error("Response was not JSON (check your Apps Script doGet)."); }

      // Accept multiple shapes:
      // - {ok:true, items:[...]}
      // - {ok:true, data:[...]}   (some versions)
      // - [...]
      let rows = [];
      if(Array.isArray(data)) rows = data;
      else if(Array.isArray(data.items)) rows = data.items;
      else if(Array.isArray(data.data)) rows = data.data;
      else if(data.ok && Array.isArray(data.rows)) rows = data.rows;

      if(!rows.length) {
        // might still be ok but empty
        raw = [];
        buildSelectOptions(raw);
        render();
        setApiStatus(true, "Connected (0 items)");
        return;
      }

      raw = rows.map(normalizeRow);
      buildSelectOptions(raw);
      render();
      setApiStatus(true, `Connected (${raw.length} items)`);
      return;

    }catch(err){
      lastErr = err;
      // try next candidate
    }
  }

  setApiStatus(false, "API error");
  countEl.textContent = "Could not load inventory (fetch failed).";
  grid.innerHTML = "";
  console.error(lastErr);

  showToast("Fetch failed. If this is CORS, we‚Äôll fix it in your Apps Script response.");
}

/* =========================
   Events
========================= */
[qEl, catEl, mfgEl, condEl, sortEl].forEach(x=>x.addEventListener("input", render));
refreshBtn.addEventListener("click", fetchAny);

listedSwitch.addEventListener("click", ()=>{
  listedOnly = !listedOnly;
  listedSwitch.classList.toggle("on", listedOnly);
  listedSwitch.setAttribute("aria-checked", String(listedOnly));
  render();
});

/* Boot */
fetchAny();
</script>
</body>
</html>
