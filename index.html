<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tek-Pak Store</title>
  <link rel="stylesheet" href="./styles.css"/>
  <style>
    .emptyState{
      border:1px dashed var(--line);
      border-radius: 16px;
      padding: 14px;
      background: rgba(255,255,255,.04);
      color: var(--muted);
      line-height: 1.35;
    }
    .toggleRow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
    }
    .toggle input{ width:auto; }
    .priceBig{ font-weight:950; font-size: 16px; }
  </style>
</head>
<body>
<header class="topbar">
  <div class="wrap">
    <div class="brand">
      <img id="logo" alt="Tek-Pak" />
      <span class="badge">Surplus Store</span>
    </div>

    <nav class="nav">
      <a class="active" href="./index.html">Shop</a>
      <a href="./portal.html">Employee Portal</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="grid cols-2">
    <div class="card">
      <div class="hd">
        <div>
          <h2>Browse Inventory</h2>
          <div class="sub">If it’s listed here, it’s available. (AVAILABLE + LISTED only)</div>
        </div>
      </div>
      <div class="bd">
        <div class="controls">
          <input class="input" id="q" placeholder="Search (SKU, title, brand, model…)" />
          <select class="select" id="cat">
            <option value="">All categories</option>
          </select>
          <select class="select" id="sort">
            <option value="newest">Sort: Newest</option>
            <option value="priceLow">Sort: Price (Low)</option>
            <option value="priceHigh">Sort: Price (High)</option>
            <option value="titleAZ">Sort: Title (A–Z)</option>
          </select>
          <button class="btn primary" id="btnLoad">Search</button>
        </div>

        <div style="height:10px"></div>

        <div class="toggleRow">
          <label class="toggle">
            <input type="checkbox" id="listedOnly"/>
            <span class="small"><b>Show LISTED only</b> (hide AVAILABLE not-yet-posted)</span>
          </label>
          <div class="small" id="meta">Loading…</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <h2>Quick Notes</h2>
          <div class="sub">Public-facing info only</div>
        </div>
      </div>
      <div class="bd">
        <ul class="small" style="margin:0; padding-left:18px;">
          <li>Read the full item description and photos before purchase.</li>
          <li>Items may have known issues; those will be listed clearly.</li>
          <li>Questions? Message through the platform listing.</li>
        </ul>
      </div>
    </div>
  </div>

  <div style="height:14px"></div>

  <div class="card">
    <div class="hd">
      <div>
        <h2>Items</h2>
        <div class="sub">Click an item card for details</div>
      </div>
    </div>
    <div class="bd">
      <div class="grid cols-3" id="grid"></div>
      <div id="empty" class="emptyState" style="display:none;"></div>
    </div>
  </div>
</main>

<!-- Public item modal -->
<div class="drawerBack" id="drawerBack">
  <div class="drawer" role="dialog" aria-modal="true">
    <div class="dhd">
      <div>
        <h3 id="dTitle">Item</h3>
        <div class="small" id="dSub"></div>
      </div>
      <div class="controls">
        <button class="btn" id="btnClose">Close</button>
      </div>
    </div>
    <div class="dbd">
      <div class="small"><strong>SKU:</strong> <span class="mono" id="dSku"></span></div>
      <div style="height:10px"></div>

      <div class="small"><strong>Specs:</strong> <span id="dSpecs"></span></div>
      <div style="height:10px"></div>

      <div class="small"><strong>Condition:</strong> <span id="dCond"></span></div>
      <div style="height:10px"></div>

      <div class="small"><strong>Included:</strong></div>
      <div class="small" id="dIncluded" style="white-space:pre-wrap;"></div>
      <div style="height:10px"></div>

      <div class="small"><strong>Known issues (if any):</strong></div>
      <div class="small" id="dIssues" style="white-space:pre-wrap;"></div>

      <hr class="sep">

      <div class="controls">
        <a class="btn primary" id="btnEbay" target="_blank" rel="noopener">View Listing</a>
        <button class="btn" id="btnCopySku">Copy SKU</button>
      </div>

      <div style="height:12px"></div>
      <div class="small">
        Want internal info (bin location, internal notes, etc.)? Use the Employee Portal.
      </div>
    </div>
  </div>
</div>

<script src="./app.js"></script>
<script>
let CONFIG = { companyName:"Tek-Pak Inc.", logoUrl:"" };
let ALL_SELLABLE = []; // unfiltered sellable list
let ITEMS = [];        // rendered list
let _debounce = null;

function openDrawer(){ qs("#drawerBack").classList.add("show"); }
function closeDrawer(){ qs("#drawerBack").classList.remove("show"); }

function toNumPrice(v){
  const s = String(v ?? "").trim();
  if (!s) return NaN;
  const cleaned = s.replace(/[^0-9.]/g,"");
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : NaN;
}

function publicFilter(items){
  const listedOnly = qs("#listedOnly").checked;
  return items.filter(it => {
    const st = String(it.Status||"").toUpperCase();
    if (listedOnly) return st === "LISTED";
    return (st === "AVAILABLE" || st === "LISTED");
  });
}

function safeText(v){ return String(v ?? "").trim(); }

function cardHtml(it){
  const title = safeText(it.Title) || "Item";
  const sku = safeText(it.TP_SKU);
  const brand = safeText(it.Brand);
  const model = safeText(it.Model);
  const priceRaw = it.List_Price || it.Price || "";
  const priceNum = toNumPrice(priceRaw);
  const status = String(it.Status||"").toUpperCase();

  const specs = [brand, model].filter(Boolean).join(" • ") || "See details";

  const pill = (status === "AVAILABLE" || status === "LISTED")
    ? `<span class="pill good">${escHtml(status)}</span>`
    : `<span class="pill warn">${escHtml(status||"—")}</span>`;

  const priceLine = Number.isFinite(priceNum)
    ? `<div class="small priceBig">$${priceNum.toFixed(2)}</div>`
    : (priceRaw ? `<div class="small"><strong>Price:</strong> ${escHtml(priceRaw)}</div>` : ``);

  return `
    <div class="card" data-open="${escHtml(sku)}" style="cursor:pointer;">
      <div class="hd">
        <div>
          <h2>${escHtml(title)}</h2>
          <div class="sub">${escHtml(specs)}</div>
        </div>
        <div>${pill}</div>
      </div>
      <div class="bd">
        <div class="small mono">${escHtml(sku)}</div>
        <div style="height:8px"></div>
        ${priceLine}
        <div style="height:10px"></div>
        <div class="controls">
          <button class="btn primary" data-open-btn="${escHtml(sku)}">View</button>
        </div>
      </div>
    </div>
  `;
}

function renderGrid(){
  const grid = qs("#grid");
  const empty = qs("#empty");

  grid.innerHTML = ITEMS.map(cardHtml).join("");

  if (!ITEMS.length){
    empty.style.display = "block";
    empty.innerHTML = `
      <b>No matching items.</b><br>
      Try a different search, clear the category filter, or turn off “LISTED only”.
    `;
  } else {
    empty.style.display = "none";
  }

  qs("#meta").textContent = `Showing ${ITEMS.length} item(s).`;
}

function fillCategoryDropdownFromAllSellable(){
  const cats = new Set(ALL_SELLABLE.map(x => String(x.Category||"").trim()).filter(Boolean));
  const sel = qs("#cat");
  const keep = sel.value;
  sel.innerHTML = `<option value="">All categories</option>` + Array.from(cats).sort()
    .map(c => `<option value="${escHtml(c)}">${escHtml(c)}</option>`).join("");
  sel.value = keep;
}

function pickItemBySku(sku){
  return ITEMS.find(x => String(x.TP_SKU||"") === String(sku));
}

function ebayUrlFor(it){
  const itemId = String(it.eBay_ItemID || it.Ebay_ItemID || it.ebay_itemid || "").trim();
  if (itemId) return `https://www.ebay.com/itm/${encodeURIComponent(itemId)}`;
  const direct = String(it.eBay_URL || it.Ebay_URL || "").trim();
  return direct || "";
}

function showItem(it){
  qs("#dTitle").textContent = it.Title || "Item";
  qs("#dSub").textContent = CONFIG.companyName;

  qs("#dSku").textContent = it.TP_SKU || "";
  qs("#dSpecs").textContent = [it.Brand, it.Model, it.Part_Number].filter(Boolean).join(" • ") || "See listing";
  qs("#dCond").textContent = it.Condition_Grade || it.Condition || "See listing";

  qs("#dIncluded").textContent = it.Included || "See listing/photos.";
  qs("#dIssues").textContent = it.Known_Issues || "None listed beyond photos/description.";

  const url = ebayUrlFor(it);
  const btn = qs("#btnEbay");
  if (url){
    btn.href = url;
    btn.textContent = "View Listing";
    btn.classList.remove("warn");
  } else {
    btn.href = "https://www.ebay.com/";
    btn.textContent = "Listing not linked";
  }

  openDrawer();
}

function sortItems(items){
  const mode = qs("#sort").value;
  const copy = [...items];

  if (mode === "titleAZ"){
    copy.sort((a,b)=> safeText(a.Title).localeCompare(safeText(b.Title)));
  } else if (mode === "priceLow" || mode === "priceHigh"){
    copy.sort((a,b)=>{
      const ap = toNumPrice(a.List_Price || a.Price);
      const bp = toNumPrice(b.List_Price || b.Price);
      const an = Number.isFinite(ap) ? ap : 1e18;
      const bn = Number.isFinite(bp) ? bp : 1e18;
      return mode === "priceLow" ? (an-bn) : (bn-an);
    });
  } else {
    // newest
    copy.sort((a,b)=>{
      const aa = Number(a.UpdatedAt || a.Intake_Date || a._row || 0);
      const bb = Number(b.UpdatedAt || b.Intake_Date || b._row || 0);
      return (bb - aa);
    });
  }
  return copy;
}

async function loadStore(){
  const q = qs("#q").value.trim();
  const cat = qs("#cat").value.trim();

  try{
    const res = await apiGet({ action:"listInventory", tab:"Inventory_Retail", q });
    const raw = res.items || [];

    // 1) Store full sellable list for dropdown fill
    ALL_SELLABLE = publicFilter(raw);

    // 2) Apply category filter + sorting
    let items = ALL_SELLABLE;
    if (cat) items = items.filter(x => String(x.Category||"") === cat);
    items = sortItems(items);

    // IMPORTANT: strip internal-only fields (just in case)
    ITEMS = items.map(it => {
      const clean = { ...it };
      delete clean.Notes_Internal;
      delete clean.Yard_Location;
      delete clean.Cost;
      delete clean.Internal_Notes;
      delete clean.Password;
      return clean;
    });

    fillCategoryDropdownFromAllSellable();
    renderGrid();
    toast("Loaded store items.");
  }catch(err){
    toast(err.message, "bad");
    qs("#meta").textContent = "Error loading store.";
    qs("#grid").innerHTML = "";
    qs("#empty").style.display = "block";
    qs("#empty").innerHTML = `<b>Couldn’t load items.</b><br>${escHtml(err.message || "Unknown error")}`;
  }
}

// events
qs("#btnLoad").addEventListener("click", loadStore);

qs("#q").addEventListener("input", ()=>{
  clearTimeout(_debounce);
  _debounce = setTimeout(loadStore, 350);
});
qs("#q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadStore(); });

qs("#cat").addEventListener("change", loadStore);
qs("#sort").addEventListener("change", loadStore);
qs("#listedOnly").addEventListener("change", loadStore);

qs("#grid").addEventListener("click", (e)=>{
  const openBtn = e.target.closest("[data-open-btn]");
  const card = e.target.closest("[data-open]");
  const sku = openBtn?.getAttribute("data-open-btn") || card?.getAttribute("data-open");
  if (!sku) return;
  const it = pickItemBySku(sku);
  if (it) showItem(it);
});

qs("#btnClose").addEventListener("click", closeDrawer);
qs("#drawerBack").addEventListener("click", (e)=>{ if(e.target.id==="drawerBack") closeDrawer(); });

qs("#btnCopySku").addEventListener("click", async ()=>{
  const sku = qs("#dSku").textContent.trim();
  await navigator.clipboard.writeText(sku);
  toast("Copied SKU.");
});

// init
(async function init(){
  CONFIG = await loadConfig();
  setLogo(qs("#logo"), CONFIG.logoUrl);
  await loadStore();
})();
</script>
</body>
</html>
