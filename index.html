<script>
/* =========================================================
  TEK-PAK STOREFRONT (GitHub Pages)
  FIXED: Uses JSONP (no CORS headaches)
========================================================= */

/* 1) SET THIS */
const API_BASE = "https://script.google.com/macros/s/AKfycbyco3RAra8KoIOxbr8VLzlBG0YwRLZ4J6pNmf7LcEx_yf6nA8BB20H_lAlejQ30hg39/exec";

/* 2) If your API uses a specific action for storefront, set it here.
   We'll try these in order until one works.
*/
const ACTION_CANDIDATES = ["public", "list", "storefront", "inventory", ""];

/* 3) Hide items if ANY field contains this keyword */
const HIDE_IF_CONTAINS = ["asset"];

/* =========================
   DOM
========================= */
const el = (id)=>document.getElementById(id);
const grid = el("grid");
const countEl = el("count");
const apiText = el("apiText");
const apiDot  = el("apiDot");

const qEl = el("q");
const catEl = el("cat");
const mfgEl = el("mfg");
const condEl = el("cond");
const sortEl = el("sort");
const refreshBtn = el("refreshBtn");
const listedSwitch = el("listedSwitch");

/* Modal */
const modal = el("modal");
const closeBtn = el("closeBtn");
const mTitle = el("mTitle");
const mSub = el("mSub");
const mHero = el("mHero");
const thumbs = el("thumbs");
const mPrice = el("mPrice");
const mStock = el("mStock");
const mCat = el("mCat");
const mCond = el("mCond");
const mDesc = el("mDesc");
const buyBtn = el("buyBtn");
const copyBtn = el("copyBtn");
const mNote = el("mNote");

const toast = el("toast");

/* =========================
   State
========================= */
let raw = [];
let view = [];
let listedOnly = true;

const money = new Intl.NumberFormat(undefined, { style:"currency", currency:"USD" });

/* =========================
   Helpers
========================= */
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.classList.remove("show"), 2200);
}
function safeStr(v){ return (v===null||v===undefined) ? "" : String(v).trim(); }
function lower(v){ return safeStr(v).toLowerCase(); }

function pick(obj, keys){
  const map = new Map(Object.keys(obj).map(k=>[k.toLowerCase(), k]));
  for(const k of keys){
    const hit = map.get(k.toLowerCase());
    if(hit) return obj[hit];
  }
  return undefined;
}
function parsePrice(v){
  const s = safeStr(v).replace(/[^0-9.]/g,"");
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function parseQty(v){
  const n = Number(String(v).replace(/[^0-9.-]/g,""));
  return Number.isFinite(n) ? n : null;
}
function firstNonEmpty(arr){
  for(const v of arr){
    const s = safeStr(v);
    if(s) return s;
  }
  return "";
}
function splitImages(v){
  const s = safeStr(v);
  if(!s) return [];
  const parts = s.split(/[\n,]/g).map(x=>x.trim()).filter(Boolean);
  return [...new Set(parts)];
}
function looksHidden(item){
  const blob = JSON.stringify(item).toLowerCase();
  return HIDE_IF_CONTAINS.some(k => blob.includes(k));
}
function normalizeRow(row){
  const name = firstNonEmpty([ pick(row, ["name","title","item","product","listing","item name","product name","inventory item"]) ]);
  const sku  = firstNonEmpty([ pick(row, ["sku","id","itemid","item id","asset tag","assettag","serial","serial number","tag"]) ]);
  const desc = firstNonEmpty([ pick(row, ["description","desc","details","notes","note"]) ]);
  const category = firstNonEmpty([ pick(row, ["category","type","cat"]) ]);
  const manufacturer = firstNonEmpty([ pick(row, ["manufacturer","brand","make","mfg"]) ]);
  const condition = firstNonEmpty([ pick(row, ["condition","grade","state"]) ]);
  const status = firstNonEmpty([ pick(row, ["status","listing status","state"]) ]);
  const location = firstNonEmpty([ pick(row, ["location","bin","shelf","where","warehouse location"]) ]);

  const priceNum = parsePrice(firstNonEmpty([ pick(row, ["price","cost","sale price","list price","amount"]) ]));
  const qtyNum   = parseQty(firstNonEmpty([ pick(row, ["qty","quantity","stock","on hand","onhand","inventory","count"]) ]));

  const paypal = firstNonEmpty([ pick(row, ["paypal","paypal link","buy","buy link","buylink","purchase","checkout","url","link"]) ]);

  const imagesCsv = pick(row, ["images","image urls","photos","photo urls"]);
  const imgs = [
    ...splitImages(imagesCsv),
    ...splitImages(pick(row, ["image","img","image 1","img 1","photo 1","pic 1","picture 1"])),
    ...splitImages(pick(row, ["image 2","img 2","photo 2","pic 2","picture 2"])),
    ...splitImages(pick(row, ["image 3","img 3","photo 3","pic 3","picture 3"])),
    ...splitImages(pick(row, ["image 4","img 4","photo 4","pic 4","picture 4"])),
    ...splitImages(pick(row, ["image 5","img 5","photo 5","pic 5","picture 5"])),
    ...splitImages(pick(row, ["image 6","img 6","photo 6","pic 6","picture 6"])),
  ].filter(Boolean);

  const dateGuess = firstNonEmpty([ pick(row, ["created","created at","date","date added","timestamp","updated","updated at"]) ]);

  return {
    _raw: row,
    name: name || "(Unnamed item)",
    sku,
    desc,
    category,
    manufacturer,
    condition,
    status,
    location,
    price: priceNum,
    qty: qtyNum,
    paypal,
    images: imgs,
    dateGuess
  };
}
function isListed(item){
  const s = lower(item.status);
  if(!s) return true;
  if(s.includes("hold")) return false;
  return (s.includes("listed") || s.includes("live") || s.includes("active") || s.includes("yes"));
}
function searchBlob(item){
  return [item.name,item.sku,item.desc,item.category,item.manufacturer,item.condition,item.status,item.location]
    .map(safeStr).join(" ").toLowerCase();
}
function sortItems(arr){
  const mode = sortEl.value;
  const copy = [...arr];
  if(mode === "priceAsc") copy.sort((a,b)=>(a.price ?? 1e18) - (b.price ?? 1e18));
  else if(mode === "priceDesc") copy.sort((a,b)=>(b.price ?? -1) - (a.price ?? -1));
  else if(mode === "nameAsc") copy.sort((a,b)=>a.name.localeCompare(b.name));
  else {
    copy.sort((a,b)=>{
      const da = Date.parse(a.dateGuess || "");
      const db = Date.parse(b.dateGuess || "");
      if(Number.isFinite(db) && Number.isFinite(da)) return db-da;
      if(Number.isFinite(db)) return 1;
      if(Number.isFinite(da)) return -1;
      return 0;
    });
  }
  return copy;
}
function escapeHtml(s){
  return safeStr(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function buildSelectOptions(items){
  const uniq = (vals)=>[...new Set(vals.filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  const fill = (select, list)=>{
    const keep = select.value;
    select.innerHTML = `<option value="">All</option>` + list.map(v=>`<option>${escapeHtml(v)}</option>`).join("");
    select.value = keep;
  };
  fill(catEl, uniq(items.map(x=>x.category)));
  fill(mfgEl, uniq(items.map(x=>x.manufacturer)));
  fill(condEl, uniq(items.map(x=>x.condition)));
}

function cardTemplate(item){
  const img = item.images[0] || "";
  const priceText = item.price != null ? money.format(item.price) : "Call / Message";
  const qtyText = item.qty != null ? `QTY: ${item.qty}` : (item.status ? `Status: ${item.status}` : "â€”");
  const badge = item.category || item.manufacturer || "Surplus";
  const badgeClass = item.category ? "lime" : (item.manufacturer ? "blue" : "yellow");
  const canBuy = !!safeStr(item.paypal);

  return `
    <div class="card">
      <div class="img">
        ${img ? `<img loading="lazy" src="${escapeHtml(img)}" alt="${escapeHtml(item.name)}">` : ``}
        <div class="badge ${badgeClass}">${escapeHtml(badge)}</div>
      </div>
      <div class="body">
        <h3 class="title">${escapeHtml(item.name)}</h3>
        <p class="desc">${escapeHtml(item.desc || "No description yet. (Add a Description column in your sheet.)")}</p>
        <div class="row">
          <div class="price">${escapeHtml(priceText)}</div>
          <div class="stock">${escapeHtml(qtyText)}</div>
        </div>
      </div>
      <div class="actions">
        <div class="btn2" data-act="view">ðŸ‘€ View</div>
        <div class="btn2 primary ${canBuy ? "" : "disabled"}" data-act="buy">${canBuy ? "ðŸ’³ Buy Now" : "ðŸ’¬ Inquire"}</div>
      </div>
    </div>
  `;
}

function render(){
  const q = lower(qEl.value);
  const cat = safeStr(catEl.value);
  const mfg = safeStr(mfgEl.value);
  const cond = safeStr(condEl.value);

  view = raw
    .filter(item => !looksHidden(item))
    .filter(item => !listedOnly || isListed(item))
    .filter(item => !cat || item.category === cat)
    .filter(item => !mfg || item.manufacturer === mfg)
    .filter(item => !cond || item.condition === cond)
    .filter(item => !q || searchBlob(item).includes(q));

  view = sortItems(view);
  countEl.textContent = `${view.length} item(s) shown${listedOnly ? " (Listed only)" : ""}`;
  grid.innerHTML = view.map(cardTemplate).join("");

  [...grid.querySelectorAll(".card")].forEach((card, idx)=>{
    card.querySelector('[data-act="view"]').addEventListener("click", ()=>openModal(view[idx]));
    card.querySelector('[data-act="buy"]').addEventListener("click", ()=>{
      const item = view[idx];
      if(safeStr(item.paypal)) window.open(item.paypal, "_blank", "noopener");
      else { openModal(item); showToast("No buy link found. Add a PayPal link column."); }
    });
  });
}

function openModal(item){
  mTitle.textContent = item.name || "Item";
  const bits = [];
  if(item.sku) bits.push(`SKU: ${item.sku}`);
  if(item.manufacturer) bits.push(item.manufacturer);
  if(item.location) bits.push(`Loc: ${item.location}`);
  mSub.textContent = bits.join(" â€¢ ") || "â€”";

  const imgs = item.images.length ? item.images : [""];
  mHero.src = imgs[0] || "";
  mHero.alt = item.name || "";

  thumbs.innerHTML = imgs.slice(0,6).map((u,i)=>`
    <div class="thumb" data-i="${i}">
      ${u ? `<img src="${escapeHtml(u)}" alt="">` : ``}
    </div>
  `).join("");

  [...thumbs.querySelectorAll(".thumb")].forEach(t=>{
    t.addEventListener("click", ()=>{
      const i = Number(t.dataset.i);
      mHero.src = imgs[i] || imgs[0] || "";
    });
  });

  mPrice.textContent = item.price != null ? money.format(item.price) : "â€”";
  mStock.textContent = item.qty != null ? String(item.qty) : (item.status || "â€”");
  mCat.textContent = item.category || "â€”";
  mCond.textContent = item.condition || "â€”";
  mDesc.textContent = item.desc || "No description provided yet.";

  const buy = safeStr(item.paypal);
  buyBtn.href = buy || "#";
  buyBtn.classList.toggle("disabled", !buy);
  buyBtn.textContent = buy ? "ðŸ’³ Buy Now" : "ðŸ’¬ No Buy Link";

  mNote.textContent = buy
    ? "Opens your PayPal checkout link in a new tab."
    : "To enable Buy Now, add a column like PayPal / Buy Link in your sheet.";

  copyBtn.onclick = async ()=>{
    const text =
`Tek-Pak Surplus Item
Name: ${item.name || ""}
SKU: ${item.sku || ""}
Price: ${item.price != null ? money.format(item.price) : ""}
Category: ${item.category || ""}
Manufacturer: ${item.manufacturer || ""}
Condition: ${item.condition || ""}
Status: ${item.status || ""}
Location: ${item.location || ""}

Details:
${item.desc || ""}

Buy:
${item.paypal || ""}`.trim();

    try{ await navigator.clipboard.writeText(text); showToast("Copied item details ðŸ“‹"); }
    catch{ showToast("Couldnâ€™t copy (browser blocked)."); }
  };

  modal.classList.add("show");
}
function closeModal(){ modal.classList.remove("show"); }
closeBtn.addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });
window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

/* =========================
   JSONP Loader (NO CORS)
========================= */
function setApiStatus(ok, msg){
  apiDot.className = "dot " + (ok ? "ok" : "bad");
  apiText.textContent = msg;
}

function jsonp(url, timeoutMs=12000){
  return new Promise((resolve, reject)=>{
    const cbName = "cb_" + Math.random().toString(36).slice(2);
    const sep = url.includes("?") ? "&" : "?";
    const src = `${url}${sep}callback=${encodeURIComponent(cbName)}`;

    let done = false;
    const script = document.createElement("script");
    script.src = src;
    script.async = true;

    const cleanup = ()=>{
      if(script && script.parentNode) script.parentNode.removeChild(script);
      try{ delete window[cbName]; }catch{}
    };

    const t = setTimeout(()=>{
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("JSONP timeout"));
    }, timeoutMs);

    window[cbName] = (data)=>{
      if(done) return;
      done = true;
      clearTimeout(t);
      cleanup();
      resolve(data);
    };

    script.onerror = ()=>{
      if(done) return;
      done = true;
      clearTimeout(t);
      cleanup();
      reject(new Error("JSONP network error"));
    };

    document.head.appendChild(script);
  });
}

async function fetchAny(){
  const tries = ACTION_CANDIDATES.map(act =>
    act ? `${API_BASE}?action=${encodeURIComponent(act)}&t=${Date.now()}` : `${API_BASE}?t=${Date.now()}`
  );

  let lastErr = null;

  for(const url of tries){
    try{
      setApiStatus(true, "Loading inventoryâ€¦");
      const data = await jsonp(url);

      // Accept multiple shapes:
      // - {ok:true, items:[...]}
      // - {ok:true, data:[...]}
      // - [...]
      let rows = [];
      if(Array.isArray(data)) rows = data;
      else if(Array.isArray(data.items)) rows = data.items;
      else if(Array.isArray(data.data)) rows = data.data;
      else if(data && data.ok && Array.isArray(data.rows)) rows = data.rows;

      // If API returns ok:false and error, surface it
      if(data && data.ok === false){
        throw new Error(data.error || "API returned ok:false");
      }

      raw = rows.map(normalizeRow);
      buildSelectOptions(raw);
      render();
      setApiStatus(true, `Connected (${raw.length} items)`);
      return;

    }catch(err){
      lastErr = err;
      // try next action
    }
  }

  setApiStatus(false, "API error");
  countEl.textContent = "Could not load inventory (API call failed).";
  grid.innerHTML = "";
  console.error(lastErr);
  showToast(lastErr?.message || "API call failed");
}

/* =========================
   Events
========================= */
[qEl, catEl, mfgEl, condEl, sortEl].forEach(x=>x.addEventListener("input", render));
refreshBtn.addEventListener("click", fetchAny);

listedSwitch.addEventListener("click", ()=>{
  listedOnly = !listedOnly;
  listedSwitch.classList.toggle("on", listedOnly);
  listedSwitch.setAttribute("aria-checked", String(listedOnly));
  render();
});

/* Boot */
fetchAny();
</script>
