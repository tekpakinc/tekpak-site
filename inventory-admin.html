<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tek-Pak Inventory Admin</title>
  <style>
    :root {
      --bg: #f8fafc;
      --panel: #ffffff;
      --steel: #e2e8f0;
      --border: #cbd5e1;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --good: #10b981;
      --bad: #ef4444;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: 'Inter', system-ui, -apple-system, sans-serif;
      color-scheme: light;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --panel: #1e293b;
      --steel: #334155;
      --border: #475569;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --accent: #3b82f6;
      --accent-hover: #60a5fa;
      --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.5);
      color-scheme: dark;
    }

    /* Strict layout control */
    *, *::before, *::after { box-sizing: border-box; }
    
    body { 
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      font-family: var(--sans);
      line-height: 1.5;
    }

    /* Fixed Dark Scrollbars */
    html {
      scrollbar-width: thin;
      scrollbar-color: var(--border) var(--bg);
    }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { 
      background: var(--border); 
      border-radius: 10px; 
      border: 2px solid var(--bg); 
    }

    header {
      position: sticky; top: 0; z-index: 50;
      background: var(--panel);
      border-bottom: 1px solid var(--steel);
      backdrop-filter: blur(8px);
    }

    .wrap { max-width: 1600px; margin: 0 auto; padding: 12px 20px; }
    .top { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    
    h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--accent); }
    .sub { color: var(--muted); font-size: 12px; }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    /* Inputs - Max-width fix to prevent going "off" */
    input, select, textarea {
      font-family: var(--sans);
      width: 100%;
      padding: 10px 12px; border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent), transparent 85%);
    }

    .btn {
      font-weight: 600; font-size: 13px;
      border: 1px solid var(--border);
      background: var(--panel); color: var(--text);
      padding: 8px 16px; border-radius: 8px;
      cursor: pointer; white-space: nowrap;
      transition: all 0.15s;
    }
    .btn:hover { border-color: var(--muted); background: var(--bg); }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn.good { background: var(--good); border-color: var(--good); color: #fff; }
    .btn.bad { background: var(--bad); border-color: var(--bad); color: #fff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .grid {
      display: grid; gap: 20px;
      grid-template-columns: 380px 1fr;
      padding: 20px; max-width: 1600px; margin: 0 auto;
    }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--panel);
      border: 1px solid var(--steel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: relative; overflow: hidden;
    }

    .cardHead {
      padding: 12px 16px;
      border-bottom: 1px solid var(--steel);
      display: flex; align-items: center; justify-content: space-between;
    }
    .cardHead h2 { margin: 0; font-size: 14px; font-weight: 700; }

    .cardBody { padding: 16px; }

    .formGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .formGrid .full { grid-column: 1 / -1; }
    
    label { display: block; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
    .field { min-width: 0; }
    .hint { font-size: 10px; color: var(--muted); margin-top: 4px; }

    .tableWrap { overflow: auto; max-height: calc(100vh - 180px); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
    thead th {
      position: sticky; top: 0; background: var(--panel);
      z-index: 10; border-bottom: 2px solid var(--steel);
      text-align: left; padding: 12px; color: var(--muted); font-size: 11px;
    }
    tbody td { border-bottom: 1px solid var(--steel); padding: 10px 12px; vertical-align: top; }
    tbody tr:hover { background: color-mix(in srgb, var(--accent), transparent 96%); }

    .pill {
      font-family: var(--mono); font-size: 11px;
      padding: 3px 10px; border: 1px solid var(--border);
      border-radius: 20px; background: var(--bg);
    }

    .modalOverlay {
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7);
      display: none; align-items: center; justify-content: center;
      z-index: 1000; padding: 20px; backdrop-filter: blur(4px);
    }
    .modal {
      width: min(800px, 100%); max-height: 85vh; 
      background: var(--panel); border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      display: flex; flex-direction: column;
    }
    .modalBody { padding: 20px; overflow-y: auto; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Tek-Pak Admin</h1>
        <div class="sub">Inventory Control</div>
      </div>
      <div class="row">
        <input id="q" placeholder="Quick Search..." style="width:200px">
        <select id="cat" style="width:150px"><option value="">Categories</option></select>
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn" id="themeToggle" style="width:40px; padding:0">ðŸŒ“</button>
        <span class="pill" id="countPill">â€”</span>
      </div>
    </div>
  </div>
</header>

<div class="grid">
  <aside>
    <section class="card">
      <div class="cardHead">
        <h2>Add New Item</h2>
        <button class="btn primary" id="addBtn">Add Item</button>
      </div>
      <div class="cardBody">
        <div class="formGrid">
          <div class="field full"><label>Title</label><input id="f_title"></div>
          <div class="field"><label>SKU</label><input id="f_sku"></div>
          <div class="field"><label>Category</label><input id="f_category"></div>
          <div class="field"><label>Condition</label><input id="f_condition"></div>
          <div class="field"><label>Price</label><input id="f_price"></div>
          <div class="field full"><label>Description</label><textarea id="f_description" style="height:60px"></textarea></div>
          <div class="field full">
            <label>Images (URLs)</label>
            <input id="f_img1" placeholder="Img 1" style="margin-bottom:5px">
            <input id="f_img2" placeholder="Img 2" style="margin-bottom:5px">
            <input id="f_img3" placeholder="Img 3">
            <div class="hint">Top 3 images for preview.</div>
          </div>
          <div class="field full"><label>Buy URL</label><input id="f_buy_url"></div>
          <div class="field full"><label>Bid URL</label><input id="f_bid_url"></div>
        </div>
      </div>
    </section>
  </aside>

  <main class="card">
    <div class="cardHead">
      <h2>Live Inventory</h2>
      <span class="pill" id="updatedPill">Updated: â€”</span>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>SKU</th>
            <th>Cat</th>
            <th>Price</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>
</div>

<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="cardHead">
      <h3>Edit Item Details</h3>
      <div class="row">
        <button class="btn" id="closeModal">Cancel</button>
        <button class="btn good" id="saveModal">Save</button>
        <button class="btn bad" id="deleteModal">Del</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field full"><label>ID</label><input id="m_id" readonly style="opacity:0.5"></div>
        <div class="field full"><label>Title</label><input id="m_title"></div>
        <div class="field"><label>SKU</label><input id="m_sku"></div>
        <div class="field"><label>Category</label><input id="m_category"></div>
        <div class="field"><label>Condition</label><input id="m_condition"></div>
        <div class="field"><label>Price</label><input id="m_price"></div>
        <div class="field full"><label>Description</label><textarea id="m_description" style="height:80px"></textarea></div>
        <div class="field full"><label>All Images (Comma separated)</label><textarea id="m_images" style="height:60px"></textarea></div>
        <div class="field full"><label>Buy URL</label><input id="m_buy_url"></div>
        <div class="field full"><label>Bid URL</label><input id="m_bid_url"></div>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyLMf07vAWn1qdtL_FMVvCRf6GytYvXAtbzTLgqZRHurZisb7Qba4gYtsTwkhL-8vJu/exec";

const els = {
  q: document.getElementById('q'),
  cat: document.getElementById('cat'),
  refresh: document.getElementById('refresh'),
  countPill: document.getElementById('countPill'),
  updatedPill: document.getElementById('updatedPill'),
  tbody: document.getElementById('tbody'),
  addBtn: document.getElementById('addBtn'),
  themeToggle: document.getElementById('themeToggle'),
  f: {
    title: document.getElementById('f_title'),
    sku: document.getElementById('f_sku'),
    category: document.getElementById('f_category'),
    condition: document.getElementById('f_condition'),
    price: document.getElementById('f_price'),
    description: document.getElementById('f_description'),
    buy_url: document.getElementById('f_buy_url'),
    bid_url: document.getElementById('f_bid_url'),
    img: [document.getElementById('f_img1'), document.getElementById('f_img2'), document.getElementById('f_img3')]
  },
  modalOverlay: document.getElementById('modalOverlay'),
  closeModal: document.getElementById('closeModal'),
  saveModal: document.getElementById('saveModal'),
  deleteModal: document.getElementById('deleteModal'),
  m: {
    id: document.getElementById('m_id'),
    title: document.getElementById('m_title'),
    sku: document.getElementById('m_sku'),
    category: document.getElementById('m_category'),
    condition: document.getElementById('m_condition'),
    price: document.getElementById('m_price'),
    description: document.getElementById('m_description'),
    images: document.getElementById('m_images'),
    buy_url: document.getElementById('m_buy_url'),
    bid_url: document.getElementById('m_bid_url'),
  }
};

/* THEME */
const toggleTheme = () => {
  const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('tekpak-theme', t);
};
document.documentElement.setAttribute('data-theme', localStorage.getItem('tekpak-theme') || 'light');
els.themeToggle.addEventListener('click', toggleTheme);

/* DATA */
let ALL = [];
const money = v => isFinite(Number(v)) ? Number(v).toLocaleString(undefined,{style:'currency',currency:'USD'}) : 'â€”';
const clean = s => (s||'').toString().toLowerCase().trim();

async function api(p) { 
  const res = await fetch(API_URL + (API_URL.includes('?') ? '&' : '?') + new URLSearchParams(p));
  return res.json();
}

async function load() {
  els.refresh.disabled = true;
  try {
    const json = await api({ action:'list' });
    ALL = (Array.isArray(json) ? json : (json.data || [])).map(r => ({
      id: r.id || r.ID || r.rowId || '',
      title: r.title || r.item || r.name || '',
      sku: r.sku || r.SKU || '',
      category: r.category || r.Category || '',
      condition: r.condition || '',
      price: r.price || '',
      description: r.description || '',
      images: r.images || r.image || '',
      buy_url: r.buy_url || '',
      bid_url: r.bid_url || ''
    }));
    populate(); apply();
    els.updatedPill.textContent = new Date().toLocaleTimeString();
  } catch(e) { console.error(e); }
  finally { els.refresh.disabled = false; }
}

function populate() {
  const cats = [...new Set(ALL.map(x=>x.category).filter(Boolean))].sort();
  els.cat.innerHTML = `<option value="">All Categories</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
}

function apply() {
  const q = clean(els.q.value);
  const cat = els.cat.value;
  const filtered = ALL.filter(i => {
    const matchQ = !q || [i.title, i.sku, i.category].some(s => clean(s).includes(q));
    const matchC = !cat || i.category === cat;
    return matchQ && matchC;
  });
  els.countPill.textContent = filtered.length;
  els.tbody.innerHTML = filtered.map(i => `
    <tr>
      <td><b>${i.title}</b></td>
      <td>${i.sku}</td>
      <td>${i.category}</td>
      <td>${money(i.price)}</td>
      <td style="opacity:0.7; font-size:11px">${i.description.substring(0,40)}...</td>
      <td><button class="btn" style="padding:4px 8px" onclick="openEdit('${i.id}')">Edit</button></td>
    </tr>`).join('');
}

async function addItem() {
  const payload = { action:'add', ...Object.fromEntries(Object.entries(els.f).filter(([k])=>k!=='img').map(([k,v])=>[k,v.value.trim()])) };
  payload.images = els.f.img.map(x=>x.value.trim()).filter(Boolean).join(',');
  if(!payload.title) return alert("Title required");
  els.addBtn.disabled = true;
  await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams(payload) });
  load(); els.addBtn.disabled = false;
}

window.openEdit = id => {
  const i = ALL.find(x => String(x.id) === String(id));
  if(!i) return;
  Object.keys(els.m).forEach(k => els.m[k].value = i[k]);
  els.modalOverlay.style.display = 'flex';
};

els.closeModal.onclick = () => els.modalOverlay.style.display = 'none';
els.saveModal.onclick = async () => {
  await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({action:'update', ...Object.fromEntries(Object.entries(els.m).map(([k,v])=>[k,v.value]))}) });
  els.modalOverlay.style.display = 'none'; load();
};
els.deleteModal.onclick = async () => {
  if(confirm("Delete item?")) { await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({action:'delete', id:els.m.id.value}) }); els.modalOverlay.style.display = 'none'; load(); }
};

els.q.oninput = apply;
els.cat.onchange = apply;
els.refresh.onclick = load;
els.addBtn.onclick = addItem;

load();
</script>
</body>
</html>
