<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tek-Pak Inventory Admin</title>
  <style>
    :root {
      /* Light Mode Colors */
      --bg: #f8fafc;
      --panel: #ffffff;
      --steel: #e2e8f0;
      --border: #cbd5e1;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: 'Inter', system-ui, -apple-system, sans-serif;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --panel: #1e293b;
      --steel: #334155;
      --border: #475569;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --accent: #3b82f6;
      --accent-hover: #60a5fa;
      --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.5);
    }

    * { box-sizing: border-box; transition: background-color 0.2s, border-color 0.2s; }
    
    body { 
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      font-family: var(--sans);
      line-height: 1.5;
    }

    header {
      position: sticky; top: 0; z-index: 100;
      background: var(--panel);
      border-bottom: 1px solid var(--steel);
      backdrop-filter: blur(8px);
      background: color-mix(in srgb, var(--panel), transparent 10%);
    }

    .wrap { max-width: 1600px; margin: 0 auto; padding: 12px 24px; }
    
    .top { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    
    h1 { margin: 0; font-size: 20px; font-weight: 800; letter-spacing: -0.025em; color: var(--accent); }
    .sub { color: var(--muted); font-size: 13px; margin-top: 2px; }

    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }

    /* Modern Pill / Tags */
    .pill {
      font-family: var(--mono);
      font-size: 11px; font-weight: 600;
      color: var(--muted);
      padding: 4px 12px; border: 1px solid var(--border);
      border-radius: 999px; background: var(--bg);
    }

    /* Modern Inputs */
    input, select, textarea {
      font-family: var(--sans);
      padding: 10px 14px; border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent), transparent 80%);
    }

    textarea { min-height: 100px; resize: vertical; }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 14px;
      border: 1px solid var(--border);
      background: var(--panel); color: var(--text);
      padding: 10px 16px; border-radius: var(--radius);
      cursor: pointer; gap: 8px;
    }
    .btn:hover { background: var(--bg); border-color: var(--muted); }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn.primary:hover { background: var(--accent-hover); }
    .btn.good { background: var(--good); border-color: var(--good); color: #fff; }
    .btn.bad { background: var(--bad); border-color: var(--bad); color: #fff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Theme Toggle Button */
    #themeToggle {
      padding: 8px; border-radius: 50%; width: 40px; height: 40px;
    }

    .grid {
      display: grid; gap: 24px;
      grid-template-columns: 400px 1fr;
      padding: 24px; max-width: 1600px; margin: 0 auto;
    }

    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--panel);
      border: 1px solid var(--steel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex; flex-direction: column;
    }

    .cardHead {
      padding: 16px 20px;
      border-bottom: 1px solid var(--steel);
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .cardHead h2 { margin: 0; font-size: 16px; font-weight: 700; }

    .cardBody { padding: 20px; }

    .formGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .formGrid .full { grid-column: 1 / -1; }
    
    label { display: block; font-size: 12px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
    
    .field { display: flex; flex-direction: column; }
    .hint { font-size: 11px; color: var(--muted); margin-top: 6px; font-style: italic; }

    /* Table Styles */
    .tableContainer {
      overflow: auto; max-height: calc(100vh - 200px);
      border-radius: 0 0 var(--radius) var(--radius);
    }
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
    
    thead th {
      position: sticky; top: 0;
      background: var(--bg);
      z-index: 10;
      border-bottom: 2px solid var(--steel);
      text-align: left; padding: 14px 12px;
      color: var(--muted); font-weight: 700; text-transform: uppercase; font-size: 11px;
    }

    tbody td { border-bottom: 1px solid var(--steel); padding: 14px 12px; vertical-align: top; }
    tbody tr:hover { background: color-mix(in srgb, var(--bg), transparent 20%); }

    .sku { font-family: var(--mono); font-size: 12px; color: var(--accent); font-weight: 600; }
    .nowrap { white-space: nowrap; }
    
    .mini {
      display: inline-block; padding: 2px 8px; border-radius: 6px;
      border: 1px solid var(--border); background: var(--bg);
      color: var(--muted); font-size: 11px; font-weight: 600;
    }

    .link { color: var(--accent); text-decoration: none; font-weight: 600; }
    .link:hover { text-decoration: underline; }

    /* Modal */
    .modalOverlay {
      position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7);
      display: none; align-items: center; justify-content: center;
      z-index: 9999; padding: 20px; backdrop-filter: blur(4px);
    }
    .modal {
      width: min(900px, 100%); max-height: 90vh; overflow: hidden;
      background: var(--panel); border-radius: 16px;
      border: 1px solid var(--steel); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
      display: flex; flex-direction: column;
    }
    .modalBody { padding: 24px; overflow-y: auto; }

    /* Checkbox Styling */
    .checkbox-row {
      cursor: pointer; user-select: none;
    }
    .checkbox-row input { width: 16px; height: 16px; cursor: pointer; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Tek-Pak Admin</h1>
        <div class="sub">Inventory Management System</div>
      </div>
      <div class="row">
        <input id="q" placeholder="Search inventory..." style="min-width:300px">
        <select id="cat" style="min-width:180px">
          <option value="">All categories</option>
        </select>
        <label class="row checkbox-row" style="font-size:13px; font-weight: normal; color:var(--muted); text-transform: none;">
          <input type="checkbox" id="showAssets"> Show Assets
        </label>
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn" id="themeToggle" title="Toggle Dark Mode">ðŸŒ“</button>
        <span class="pill" id="countPill">â€”</span>
      </div>
    </div>
  </div>
</header>

<div class="grid">
  <aside>
    <section class="card">
      <div class="cardHead">
        <h2>Add Item</h2>
        <button class="btn primary" id="addBtn">Add to Sheet</button>
      </div>
      <div class="cardBody">
        <div class="formGrid">
          <div class="field full">
            <label>Title</label>
            <input id="f_title" placeholder="e.g., Dell Latitude 7420" />
          </div>

          <div class="field">
            <label>SKU</label>
            <input id="f_sku" placeholder="DL7420" />
          </div>

          <div class="field">
            <label>Category</label>
            <input id="f_category" placeholder="Laptops" />
          </div>

          <div class="field">
            <label>Condition</label>
            <input id="f_condition" placeholder="Refurbished" />
          </div>

          <div class="field">
            <label>Price</label>
            <input id="f_price" placeholder="449.99" />
          </div>

          <div class="field full">
            <label>Description</label>
            <textarea id="f_description" placeholder="Specs, notes..."></textarea>
            <div class="hint">Includes 'asset' to hide from public.</div>
          </div>

          <div class="field full">
            <label>Image URLs</label>
            <input id="f_img1" placeholder="URL #1" />
            <input id="f_img2" placeholder="URL #2" style="margin-top:8px" />
            <input id="f_img3" placeholder="URL #3" style="margin-top:8px" />
          </div>

          <div class="field full">
            <label>Buy Now URL</label>
            <input id="f_buy_url" placeholder="Checkout link" />
          </div>

          <div class="field full">
            <label>Bid URL</label>
            <input id="f_bid_url" placeholder="eBay link" />
          </div>
        </div>
      </div>
    </section>
  </aside>

  <main class="card">
    <div class="cardHead">
      <h2>Current Inventory</h2>
      <span class="pill" id="updatedPill">Last updated: â€”</span>
    </div>
    <div class="tableContainer">
      <table>
        <thead>
          <tr>
            <th class="nowrap">Title</th>
            <th>SKU</th>
            <th>Category</th>
            <th>Condition</th>
            <th class="nowrap">Price</th>
            <th>Description</th>
            <th>Images</th>
            <th>Links</th>
            <th class="nowrap">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>
</div>

<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="modalHead">
      <h3>Edit Inventory Item</h3>
      <div class="row">
        <button class="btn" id="closeModal">Close</button>
        <button class="btn good" id="saveModal">Save Changes</button>
        <button class="btn bad" id="deleteModal">Delete</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field full">
          <label>Item ID (Read-only)</label>
          <input id="m_id" readonly style="opacity: 0.6; font-family:var(--mono)" />
        </div>

        <div class="field full">
          <label>Title</label>
          <input id="m_title" />
        </div>

        <div class="field">
          <label>SKU</label>
          <input id="m_sku" />
        </div>

        <div class="field">
          <label>Category</label>
          <input id="m_category" />
        </div>

        <div class="field">
          <label>Condition</label>
          <input id="m_condition" />
        </div>

        <div class="field">
          <label>Price</label>
          <input id="m_price" />
        </div>

        <div class="field full">
          <label>Description</label>
          <textarea id="m_description"></textarea>
        </div>

        <div class="field full">
          <label>Images (Comma separated)</label>
          <textarea id="m_images" placeholder="URL1, URL2..."></textarea>
        </div>

        <div class="field full">
          <label>Buy Now URL</label>
          <input id="m_buy_url" />
        </div>

        <div class="field full">
          <label>Bid URL</label>
          <input id="m_bid_url" />
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   CONFIG & CORE LOGIC
   =========================== */
const API_URL = "https://script.google.com/macros/s/AKfycbyLMf07vAWn1qdtL_FMVvCRf6GytYvXAtbzTLgqZRHurZisb7Qba4gYtsTwkhL-8vJu/exec";

// Element references (kept original names)
const els = {
  q: document.getElementById('q'),
  cat: document.getElementById('cat'),
  showAssets: document.getElementById('showAssets'),
  refresh: document.getElementById('refresh'),
  countPill: document.getElementById('countPill'),
  updatedPill: document.getElementById('updatedPill'),
  tbody: document.getElementById('tbody'),
  addBtn: document.getElementById('addBtn'),
  themeToggle: document.getElementById('themeToggle'),
  f: {
    title: document.getElementById('f_title'),
    sku: document.getElementById('f_sku'),
    category: document.getElementById('f_category'),
    condition: document.getElementById('f_condition'),
    price: document.getElementById('f_price'),
    description: document.getElementById('f_description'),
    buy_url: document.getElementById('f_buy_url'),
    bid_url: document.getElementById('f_bid_url'),
    img: [
      document.getElementById('f_img1'),
      document.getElementById('f_img2'),
      document.getElementById('f_img3'),
      document.getElementById('f_img1'), // fallback mapping
      document.getElementById('f_img1'),
      document.getElementById('f_img1'),
    ]
  },
  modalOverlay: document.getElementById('modalOverlay'),
  closeModal: document.getElementById('closeModal'),
  saveModal: document.getElementById('saveModal'),
  deleteModal: document.getElementById('deleteModal'),
  m: {
    id: document.getElementById('m_id'),
    title: document.getElementById('m_title'),
    sku: document.getElementById('m_sku'),
    category: document.getElementById('m_category'),
    condition: document.getElementById('m_condition'),
    price: document.getElementById('m_price'),
    description: document.getElementById('m_description'),
    images: document.getElementById('m_images'),
    buy_url: document.getElementById('m_buy_url'),
    bid_url: document.getElementById('m_bid_url'),
  }
};

/* --- DARK MODE LOGIC --- */
const toggleTheme = () => {
  const current = document.documentElement.getAttribute('data-theme');
  const target = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', target);
  localStorage.setItem('tekpak-theme', target);
};

// Init theme
const savedTheme = localStorage.getItem('tekpak-theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
document.documentElement.setAttribute('data-theme', savedTheme);
els.themeToggle.addEventListener('click', toggleTheme);

/* --- DATA HANDLING (UNTOUCHED) --- */
let ALL = [];
let EDITING = null;

const txt = v => (v ?? '').toString().toLowerCase().trim();
const money = v => {
  const n = Number(v);
  return isFinite(n) ? n.toLocaleString(undefined,{style:'currency',currency:'USD'}) : 'â€”';
};

function normalize(raw){
  return {
    id: raw.id ?? raw.ID ?? raw.rowId ?? raw.row_id ?? raw.RowID ?? raw.row ?? raw.Row ?? '',
    title: raw.title ?? raw.name ?? raw.item ?? raw.Item ?? '',
    sku: raw.sku ?? raw.SKU ?? '',
    category: raw.category ?? raw.Category ?? '',
    condition: raw.condition ?? raw.Condition ?? '',
    price: raw.price ?? raw.Price ?? '',
    description: raw.description ?? raw.Description ?? raw.notes ?? raw.Notes ?? '',
    image: raw.image ?? raw.Image ?? '',
    images: raw.images ?? raw.Images ?? '',
    buy_url: raw.buy_url ?? raw.BuyURL ?? raw.checkout ?? '',
    bid_url: raw.bid_url ?? raw.BidURL ?? raw.ebay ?? '',
  };
}

function extractImages(item){
  let list = [];
  const images = (item.images ?? '').toString().trim();
  const image = (item.image ?? '').toString().trim();
  if(images){
    list = images.split(',').map(s=>s.trim()).filter(Boolean);
  } else if(image){
    list = [image];
  }
  return list.slice(0,6);
}

async function apiGet(params){
  const url = API_URL + (API_URL.includes('?') ? '&' : '?') + new URLSearchParams(params).toString();
  const res = await fetch(url, { method:'GET' });
  return res.json();
}

async function apiPost(body){
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
    body: new URLSearchParams(body).toString()
  });
  return res.json();
}

async function load(){
  els.refresh.disabled = true;
  els.refresh.textContent = "Updating...";
  try{
    const json = await apiGet({ action:'list' });
    const rows = Array.isArray(json) ? json : (json.data || []);
    ALL = rows.map(normalize);
    populateCategories();
    applyFilters();
    els.updatedPill.textContent = "Updated: " + new Date().toLocaleTimeString();
  } catch(err){
    console.error(err);
    alert("Load failed. Check console.");
  } finally {
    els.refresh.disabled = false;
    els.refresh.textContent = "Refresh";
  }
}

function populateCategories(){
  const cats = [...new Set(ALL.map(x=>x.category).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  els.cat.innerHTML = `<option value="">All categories</option>` + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
}

function shouldHideAsset(item){
  return txt(item.description).includes('asset');
}

function applyFilters(){
  const q = txt(els.q.value);
  const cat = els.cat.value;
  const showAssets = els.showAssets.checked;

  const filtered = ALL.filter(i=>{
    if(!showAssets && shouldHideAsset(i)) return false;
    const matchesQ = !q ||
      txt(i.title).includes(q) ||
      txt(i.sku).includes(q) ||
      txt(i.category).includes(q) ||
      txt(i.description).includes(q);
    const matchesCat = !cat || i.category === cat;
    return matchesQ && matchesCat;
  });

  els.countPill.textContent = `${filtered.length} Items`;
  render(filtered);
}

function render(list){
  els.tbody.innerHTML = list.map(i=>{
    const imgs = extractImages(i);
    const buy = i.buy_url ? `<a class="link" href="${escapeAttr(i.buy_url)}" target="_blank">Buy</a>` : `â€”`;
    const bid = i.bid_url ? `<a class="link" href="${escapeAttr(i.bid_url)}" target="_blank">Bid</a>` : `â€”`;

    return `
      <tr>
        <td><div style="font-weight:700">${escapeHtml(i.title || 'Untitled')}</div></td>
        <td class="sku">${escapeHtml(i.sku || '')}</td>
        <td>${escapeHtml(i.category || '')}</td>
        <td><span class="mini">${escapeHtml(i.condition || 'New')}</span></td>
        <td class="nowrap" style="font-family:var(--mono); font-weight:700">${money(i.price)}</td>
        <td style="max-width:300px; color:var(--muted); font-size:12px">${escapeHtml(i.description || '')}</td>
        <td class="nowrap"><span class="mini">${imgs.length}</span></td>
        <td class="nowrap">${buy} Â· ${bid}</td>
        <td class="nowrap">
          <button class="btn" style="padding: 5px 12px; font-size: 12px" onclick="openEdit('${escapeAttr(i.id)}')">Edit</button>
        </td>
      </tr>
    `;
  }).join('');
}

/* --- ADD / EDIT / DELETE ACTIONS (UNTOUCHED) --- */
function collectAddPayload(){
  const imgs = els.f.img.map(x=>x.value?.trim()).filter(Boolean).slice(0,6);
  return {
    title: els.f.title.value.trim(),
    sku: els.f.sku.value.trim(),
    category: els.f.category.value.trim(),
    condition: els.f.condition.value.trim(),
    price: els.f.price.value.trim(),
    description: els.f.description.value.trim(),
    images: imgs.join(','),
    buy_url: els.f.buy_url.value.trim(),
    bid_url: els.f.bid_url.value.trim(),
  };
}

async function addItem(){
  const payload = collectAddPayload();
  if(!payload.title){ alert("Title required."); return; }
  els.addBtn.disabled = true;
  els.addBtn.textContent = "Working...";
  try {
    const res = await apiPost({ action:'add', ...payload });
    if(res.ok === false) throw new Error(res.error);
    Object.values(els.f).forEach(v => { if(v.tagName) v.value=''; if(Array.isArray(v)) v.forEach(x=>x.value='') });
    await load();
  } catch(err) { alert(err.message); }
  finally { els.addBtn.disabled = false; els.addBtn.textContent = "Add to Sheet"; }
}

window.openEdit = function(id){
  const item = ALL.find(x => String(x.id) === String(id));
  if(!item) return;
  EDITING = item;
  els.m.id.value = item.id;
  els.m.title.value = item.title || '';
  els.m.sku.value = item.sku || '';
  els.m.category.value = item.category || '';
  els.m.condition.value = item.condition || '';
  els.m.price.value = item.price || '';
  els.m.description.value = item.description || '';
  els.m.images.value = extractImages(item).join(', ');
  els.m.buy_url.value = item.buy_url || '';
  els.m.bid_url.value = item.bid_url || '';
  els.modalOverlay.style.display = 'flex';
};

function closeModal(){ els.modalOverlay.style.display = 'none'; EDITING = null; }

async function saveEdit(){
  if(!EDITING) return;
  const payload = {
    id: els.m.id.value,
    title: els.m.title.value.trim(),
    sku: els.m.sku.value.trim(),
    category: els.m.category.value.trim(),
    condition: els.m.condition.value.trim(),
    price: els.m.price.value.trim(),
    description: els.m.description.value.trim(),
    images: els.m.images.value.split(',').map(s=>s.trim()).filter(Boolean).slice(0,6).join(','),
    buy_url: els.m.buy_url.value.trim(),
    bid_url: els.m.bid_url.value.trim(),
  };
  els.saveModal.disabled = true;
  try {
    await apiPost({ action:'update', ...payload });
    closeModal();
    await load();
  } catch(err) { alert(err.message); }
  finally { els.saveModal.disabled = false; }
}

async function deleteItem(){
  if(!EDITING || !confirm("Delete this item permanently?")) return;
  els.deleteModal.disabled = true;
  try {
    await apiPost({ action:'delete', id: els.m.id.value });
    closeModal();
    await load();
  } catch(err) { alert(err.message); }
  finally { els.deleteModal.disabled = false; }
}

function escapeHtml(str){
  return (str ?? '').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
}
function escapeAttr(str){ return escapeHtml(str).replaceAll('`','&#096;'); }

/* EVENTS */
els.q.addEventListener('input', applyFilters);
els.cat.addEventListener('change', applyFilters);
els.showAssets.addEventListener('change', applyFilters);
els.refresh.addEventListener('click', load);
els.addBtn.addEventListener('click', addItem);
els.closeModal.addEventListener('click', closeModal);
els.saveModal.addEventListener('click', saveEdit);
els.deleteModal.addEventListener('click', deleteItem);
els.modalOverlay.addEventListener('click', (e)=> { if(e.target === els.modalOverlay) closeModal(); });
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeModal(); });

/* INIT */
load();
</script>
</body>
</html>
