<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tek-Pak Inventory Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Light Mode */
      --bg: #f8fafc;
      --panel: #ffffff;
      --steel: #f1f5f9;
      --border: #e2e8f0;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --font: 'Inter', system-ui, sans-serif;
      --mono: 'JetBrains Mono', monospace;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --panel: #1e293b;
      --steel: #334155;
      --border: #334155;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --accent: #3b82f6;
      --accent-hover: #60a5fa;
      --good: #34d399;
      --bad: #f87171;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
    }

    * { box-sizing: border-box; transition: background-color 0.2s, border-color 0.2s; }
    
    body { 
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      font-family: var(--font);
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    header {
      position: sticky; top: 0; z-index: 50;
      background: var(--panel); border-bottom: 1px solid var(--border);
      backdrop-filter: blur(8px);
      background-color: rgba(var(--panel), 0.8);
    }

    .wrap { max-width: 1440px; margin: 0 auto; padding: 16px 24px; }
    
    .top { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    
    h1 { margin: 0; font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em; }
    .sub { color: var(--muted); font-size: 0.85rem; margin-top: 2px; }

    .header-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    /* Inputs & Selects */
    input, select, textarea {
      font-family: var(--font);
      padding: 10px 14px; border-radius: 8px;
      border: 1px solid var(--border); 
      background: var(--panel);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 0.85rem;
      padding: 10px 16px; border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--panel); color: var(--text);
      cursor: pointer; transition: all 0.2s;
    }
    .btn:hover { background: var(--steel); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn.primary:hover { background: var(--accent-hover); }
    .btn.good { background: var(--good); border-color: var(--good); color: #fff; }
    .btn.bad { background: var(--bad); border-color: var(--bad); color: #fff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* Layout Grid */
    .grid {
      display: grid; gap: 24px;
      grid-template-columns: 400px 1fr;
      padding: 24px; max-width: 1440px; margin: 0 auto;
      animation: fadeIn 0.5s ease-out;
    }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow);
      display: flex; flex-direction: column;
    }
    .cardHead {
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .cardHead h2 { margin: 0; font-size: 1rem; font-weight: 600; }

    .cardBody { padding: 20px; }

    .formGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .full { grid-column: 1 / -1; }
    label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; }

    /* Table Styling */
    .table-container { 
      overflow: auto; 
      max-height: calc(100vh - 220px); 
      border-radius: 0 0 var(--radius) var(--radius);
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    thead th {
      position: sticky; top: 0; z-index: 10;
      background: var(--steel); padding: 12px 16px;
      text-align: left; color: var(--muted); font-weight: 600;
      border-bottom: 1px solid var(--border);
    }
    tbody tr { border-bottom: 1px solid var(--border); }
    tbody tr:hover { background: var(--steel); }
    tbody td { padding: 14px 16px; vertical-align: middle; }

    /* Custom UI Elements */
    .pill {
      font-family: var(--mono); font-size: 0.7rem; color: var(--muted);
      padding: 4px 10px; border: 1px solid var(--border);
      border-radius: 20px; background: var(--steel);
    }
    .sku { font-family: var(--mono); color: var(--accent); font-weight: 600; }
    .mini-badge {
      display: inline-block; padding: 2px 6px; border-radius: 4px;
      background: var(--steel); font-size: 0.75rem; color: var(--muted);
    }

    /* Theme Toggle Switch */
    .theme-toggle {
      width: 40px; height: 40px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      background: var(--steel); cursor: pointer; border: 1px solid var(--border);
    }

    /* Modal */
    .modalOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center;
      z-index: 1000; padding: 20px;
    }
    .modal {
      width: min(900px, 100%); max-height: 90vh;
      background: var(--panel); border-radius: 16px;
      box-shadow: var(--shadow); overflow: hidden;
      animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex; flex-direction: column;
    }
    .modalBody { overflow-y: auto; padding: 24px; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Tek-Pak <span style="font-weight:400; opacity:0.6">Inventory Admin</span></h1>
        <div class="sub">Backend management dashboard</div>
      </div>
      <div class="header-actions">
        <input id="q" placeholder="Search anything..." style="min-width:240px">
        <select id="cat" style="min-width:180px">
          <option value="">All Categories</option>
        </select>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:0.85rem">
          <input type="checkbox" id="showAssets"> 
          Assets
        </label>
        <div class="theme-toggle" id="themeBtn" title="Toggle Theme">ðŸŒ“</div>
        <button class="btn" id="refresh">Refresh</button>
        <span class="pill" id="countPill">0 Items</span>
      </div>
    </div>
  </div>
</header>

<div class="grid">
  <section class="card">
    <div class="cardHead">
      <h2>Add New Item</h2>
      <button class="btn primary" id="addBtn">Add to Inventory</button>
    </div>
    <div class="cardBody">
      <div class="formGrid">
        <div class="field full">
          <label>Title</label>
          <input id="f_title" placeholder="e.g., Dell Latitude 7420" />
        </div>

        <div class="field">
          <label>SKU</label>
          <input id="f_sku" placeholder="DL7420" />
        </div>

        <div class="field">
          <label>Category</label>
          <input id="f_category" placeholder="Laptops" />
        </div>

        <div class="field">
          <label>Condition</label>
          <input id="f_condition" placeholder="Refurbished" />
        </div>

        <div class="field">
          <label>Price</label>
          <input id="f_price" placeholder="449.99" />
        </div>

        <div class="field full">
          <label>Description</label>
          <textarea id="f_description" placeholder="Specs, notes..."></textarea>
          <div style="font-size:0.7rem; color:var(--muted); margin-top:5px">Tip: include "asset" to hide from public.</div>
        </div>

        <div class="field full">
          <label>Image URLs (Up to 6)</label>
          <div style="display:grid; gap:8px">
             <input id="f_img1" placeholder="URL 1" />
             <input id="f_img2" placeholder="URL 2" />
             <input id="f_img3" placeholder="URL 3" />
          </div>
          <input id="f_img4" type="hidden" /><input id="f_img5" type="hidden" /><input id="f_img6" type="hidden" />
        </div>

        <div class="field full">
          <label>Buy Now URL</label>
          <input id="f_buy_url" placeholder="Stripe/PayPal link" />
        </div>

        <div class="field full">
          <label>Bid URL</label>
          <input id="f_bid_url" placeholder="eBay link" />
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="cardHead">
      <h2>Live Inventory</h2>
      <span class="pill" id="updatedPill">Never synced</span>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>SKU</th>
            <th>Category</th>
            <th>Condition</th>
            <th>Price</th>
            <th>Media</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</div>

<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="cardHead">
      <h3>Edit Product</h3>
      <div style="display:flex; gap:8px">
        <button class="btn bad" id="deleteModal">Delete</button>
        <button class="btn good" id="saveModal">Save Changes</button>
        <button class="btn" id="closeModal">Close</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field">
          <label>Row ID (Read-only)</label>
          <input id="m_id" readonly style="opacity:0.6" />
        </div>
        <div class="field">
          <label>Title</label>
          <input id="m_title" />
        </div>
        <div class="field">
          <label>SKU</label>
          <input id="m_sku" />
        </div>
        <div class="field">
          <label>Category</label>
          <input id="m_category" />
        </div>
        <div class="field">
          <label>Condition</label>
          <input id="m_condition" />
        </div>
        <div class="field">
          <label>Price</label>
          <input id="m_price" />
        </div>
        <div class="field full">
          <label>Description</label>
          <textarea id="m_description"></textarea>
        </div>
        <div class="field full">
          <label>Images (Comma-separated)</label>
          <textarea id="m_images"></textarea>
        </div>
        <div class="field full">
          <label>Buy URL</label>
          <input id="m_buy_url" />
        </div>
        <div class="field full">
          <label>Bid URL</label>
          <input id="m_bid_url" />
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
    CONFIG & STATE
   =========================== */
const API_URL = "https://script.google.com/macros/s/AKfycbyLMf07vAWn1qdtL_FMVvCRf6GytYvXAtbzTLgqZRHurZisb7Qba4gYtsTwkhL-8vJu/exec";

const els = {
  q: document.getElementById('q'),
  cat: document.getElementById('cat'),
  showAssets: document.getElementById('showAssets'),
  refresh: document.getElementById('refresh'),
  countPill: document.getElementById('countPill'),
  updatedPill: document.getElementById('updatedPill'),
  tbody: document.getElementById('tbody'),
  addBtn: document.getElementById('addBtn'),
  themeBtn: document.getElementById('themeBtn'),
  modalOverlay: document.getElementById('modalOverlay'),
  closeModal: document.getElementById('closeModal'),
  saveModal: document.getElementById('saveModal'),
  deleteModal: document.getElementById('deleteModal'),
  f: {
    title: document.getElementById('f_title'),
    sku: document.getElementById('f_sku'),
    category: document.getElementById('f_category'),
    condition: document.getElementById('f_condition'),
    price: document.getElementById('f_price'),
    description: document.getElementById('f_description'),
    buy_url: document.getElementById('f_buy_url'),
    bid_url: document.getElementById('f_bid_url'),
    img: [
      document.getElementById('f_img1'), document.getElementById('f_img2'),
      document.getElementById('f_img3'), document.getElementById('f_img4'),
      document.getElementById('f_img5'), document.getElementById('f_img6'),
    ]
  },
  m: {
    id: document.getElementById('m_id'),
    title: document.getElementById('m_title'),
    sku: document.getElementById('m_sku'),
    category: document.getElementById('m_category'),
    condition: document.getElementById('m_condition'),
    price: document.getElementById('m_price'),
    description: document.getElementById('m_description'),
    images: document.getElementById('m_images'),
    buy_url: document.getElementById('m_buy_url'),
    bid_url: document.getElementById('m_bid_url'),
  }
};

let ALL = [];
let EDITING = null;

/* ===========================
    THEME ENGINE
   =========================== */
function initTheme() {
  const saved = localStorage.getItem('tekpak-theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved);
}
els.themeBtn.addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('tekpak-theme', next);
});

/* ===========================
    CORE LOGIC (Unchanged)
   =========================== */
const txt = v => (v ?? '').toString().toLowerCase().trim();
const money = v => {
  const n = Number(v);
  return isFinite(n) ? n.toLocaleString(undefined,{style:'currency',currency:'USD'}) : 'â€”';
};

function normalize(raw){
  return {
    id: raw.id ?? raw.ID ?? raw.rowId ?? raw.row_id ?? raw.RowID ?? raw.row ?? raw.Row ?? '',
    title: raw.title ?? raw.name ?? raw.item ?? raw.Item ?? '',
    sku: raw.sku ?? raw.SKU ?? '',
    category: raw.category ?? raw.Category ?? '',
    condition: raw.condition ?? raw.Condition ?? '',
    price: raw.price ?? raw.Price ?? '',
    description: raw.description ?? raw.Description ?? raw.notes ?? raw.Notes ?? '',
    image: raw.image ?? raw.Image ?? '',
    images: raw.images ?? raw.Images ?? '',
    buy_url: raw.buy_url ?? raw.BuyURL ?? raw.checkout ?? '',
    bid_url: raw.bid_url ?? raw.BidURL ?? raw.ebay ?? '',
  };
}

function extractImages(item){
  let list = [];
  const images = (item.images ?? '').toString().trim();
  const image = (item.image ?? '').toString().trim();
  if(images){
    list = images.split(',').map(s=>s.trim()).filter(Boolean);
  } else if(image){
    list = [image];
  }
  return list.slice(0,6);
}

async function apiGet(params){
  const url = API_URL + (API_URL.includes('?') ? '&' : '?') + new URLSearchParams(params).toString();
  const res = await fetch(url, { method:'GET' });
  return res.json();
}

async function apiPost(body){
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
    body: new URLSearchParams(body).toString()
  });
  return res.json();
}

async function load(){
  els.refresh.disabled = true;
  els.refresh.textContent = "Syncing...";
  try{
    const json = await apiGet({ action:'list' });
    const rows = Array.isArray(json) ? json : (json.data || []);
    ALL = rows.map(normalize);
    populateCategories();
    applyFilters();
    els.updatedPill.textContent = "Updated: " + new Date().toLocaleTimeString();
  } catch(err){
    console.error(err);
    alert("Load failed. Check console.");
  } finally {
    els.refresh.disabled = false;
    els.refresh.textContent = "Refresh";
  }
}

function populateCategories(){
  const cats = [...new Set(ALL.map(x=>x.category).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  els.cat.innerHTML = `<option value="">All Categories</option>` + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
}

function shouldHideAsset(item){
  return txt(item.description).includes('asset');
}

function applyFilters(){
  const q = txt(els.q.value);
  const cat = els.cat.value;
  const showAssets = els.showAssets.checked;

  const filtered = ALL.filter(i=>{
    if(!showAssets && shouldHideAsset(i)) return false;
    const matchesQ = !q || 
      txt(i.title).includes(q) || 
      txt(i.sku).includes(q) || 
      txt(i.description).includes(q);
    const matchesCat = !cat || i.category === cat;
    return matchesQ && matchesCat;
  });

  els.countPill.textContent = `${filtered.length} Items`;
  render(filtered);
}

function render(list){
  els.tbody.innerHTML = list.map(i=>{
    const imgs = extractImages(i);
    const buy = i.buy_url ? `<a class="mini-badge" style="color:var(--accent)" href="${escapeAttr(i.buy_url)}" target="_blank">Buy</a>` : '';
    const bid = i.bid_url ? `<a class="mini-badge" style="color:var(--accent)" href="${escapeAttr(i.bid_url)}" target="_blank">Bid</a>` : '';

    return `
      <tr>
        <td>
          <div style="font-weight:600">${escapeHtml(i.title || 'Untitled')}</div>
          <div style="font-size:0.75rem; color:var(--muted); max-width:250px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${escapeHtml(i.description)}</div>
        </td>
        <td class="sku">${escapeHtml(i.sku)}</td>
        <td>${escapeHtml(i.category)}</td>
        <td><span class="mini-badge">${escapeHtml(i.condition)}</span></td>
        <td style="font-family:var(--mono); font-weight:600">${money(i.price)}</td>
        <td><span class="pill">${imgs.length}</span></td>
        <td>
          <div style="display:flex; gap:8px">
            <button class="btn" onclick="openEdit('${escapeAttr(i.id)}')">Edit</button>
            ${buy} ${bid}
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

/* ACTIONS */
async function addItem(){
  const imgs = els.f.img.map(x=>x.value.trim()).filter(Boolean).slice(0,6);
  const payload = {
    title: els.f.title.value.trim(),
    sku: els.f.sku.value.trim(),
    category: els.f.category.value.trim(),
    condition: els.f.condition.value.trim(),
    price: els.f.price.value.trim(),
    description: els.f.description.value.trim(),
    images: imgs.join(','),
    buy_url: els.f.buy_url.value.trim(),
    bid_url: els.f.bid_url.value.trim(),
  };

  if(!payload.title) return alert("Title required");

  els.addBtn.disabled = true;
  els.addBtn.textContent = "Processing...";
  try {
    const res = await apiPost({ action:'add', ...payload });
    if(res.ok !== false) {
      Object.values(els.f).forEach(v => { if(v.tagName) v.value = ''; });
      els.f.img.forEach(i => i.value = '');
      await load();
    }
  } finally {
    els.addBtn.disabled = false;
    els.addBtn.textContent = "Add to Inventory";
  }
}

window.openEdit = function(id){
  const item = ALL.find(x => String(x.id) === String(id));
  if(!item) return;
  EDITING = item;
  els.m.id.value = item.id;
  els.m.title.value = item.title || '';
  els.m.sku.value = item.sku || '';
  els.m.category.value = item.category || '';
  els.m.condition.value = item.condition || '';
  els.m.price.value = item.price || '';
  els.m.description.value = item.description || '';
  els.m.images.value = extractImages(item).join(', ');
  els.m.buy_url.value = item.buy_url || '';
  els.m.bid_url.value = item.bid_url || '';
  els.modalOverlay.style.display = 'flex';
};

function closeModal(){
  els.modalOverlay.style.display = 'none';
  EDITING = null;
}

async function saveEdit(){
  if(!EDITING) return;
  const payload = {
    id: els.m.id.value,
    title: els.m.title.value.trim(),
    sku: els.m.sku.value.trim(),
    category: els.m.category.value.trim(),
    condition: els.m.condition.value.trim(),
    price: els.m.price.value.trim(),
    description: els.m.description.value.trim(),
    images: els.m.images.value.split(',').map(s=>s.trim()).filter(Boolean).join(','),
    buy_url: els.m.buy_url.value.trim(),
    bid_url: els.m.bid_url.value.trim(),
  };

  els.saveModal.disabled = true;
  try {
    const res = await apiPost({ action:'update', ...payload });
    if(res.ok !== false) { closeModal(); await load(); }
  } finally { els.saveModal.disabled = false; }
}

async function deleteItem(){
  if(!EDITING || !confirm("Delete item permanently?")) return;
  els.deleteModal.disabled = true;
  try {
    const res = await apiPost({ action:'delete', id: els.m.id.value });
    if(res.ok !== false) { closeModal(); await load(); }
  } finally { els.deleteModal.disabled = false; }
}

function escapeHtml(str){
  return (str ?? '').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
}
function escapeAttr(str){ return escapeHtml(str).replaceAll('`','&#096;'); }

/* EVENTS */
els.q.addEventListener('input', applyFilters);
els.cat.addEventListener('change', applyFilters);
els.showAssets.addEventListener('change', applyFilters);
els.refresh.addEventListener('click', load);
els.addBtn.addEventListener('click', addItem);
els.closeModal.addEventListener('click', closeModal);
els.saveModal.addEventListener('click', saveEdit);
els.deleteModal.addEventListener('click', deleteItem);
els.modalOverlay.addEventListener('click', (e) => { if(e.target === els.modalOverlay) closeModal(); });

initTheme();
load();
</script>
</body>
</html>
