<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tek-Pak Inventory Admin</title>
  <style>
    :root {
      --bg: #f8fafc;
      --panel: #ffffff;
      --steel: #e2e8f0;
      --border: #cbd5e1;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --good: #10b981;
      --bad: #ef4444;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: 'Inter', system-ui, -apple-system, sans-serif;
      color-scheme: light;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --panel: #1e293b;
      --steel: #334155;
      --border: #475569;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --accent: #3b82f6;
      --accent-hover: #60a5fa;
      --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.5);
      color-scheme: dark;
    }

    *, *::before, *::after { box-sizing: border-box; }
    
    body { 
      margin: 0; background: var(--bg); color: var(--text); 
      font-family: var(--sans); line-height: 1.5;
    }

    /* Dark Mode Scrollbar */
    html { scrollbar-width: thin; scrollbar-color: var(--border) var(--bg); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { 
      background: var(--border); border-radius: 10px; border: 2px solid var(--bg); 
    }

    header {
      position: sticky; top: 0; z-index: 50;
      background: var(--panel); border-bottom: 1px solid var(--steel);
      backdrop-filter: blur(8px);
    }

    .wrap { max-width: 1600px; margin: 0 auto; padding: 12px 20px; }
    .top { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    
    h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--accent); }
    .sub { color: var(--muted); font-size: 12px; }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    input, select, textarea {
      font-family: var(--sans); width: 100%;
      padding: 10px 12px; border-radius: 8px;
      border: 1px solid var(--border); background: var(--panel);
      color: var(--text); font-size: 14px; outline: none;
    }
    input:focus, textarea:focus { border-color: var(--accent); }

    .btn {
      font-weight: 600; font-size: 13px; border: 1px solid var(--border);
      background: var(--panel); color: var(--text); padding: 8px 16px; 
      border-radius: 8px; cursor: pointer; white-space: nowrap;
    }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .grid {
      display: grid; gap: 20px; grid-template-columns: 380px 1fr;
      padding: 20px; max-width: 1600px; margin: 0 auto;
    }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--panel); border: 1px solid var(--steel);
      border-radius: var(--radius); box-shadow: var(--shadow);
      position: relative; overflow: hidden;
    }

    .cardHead {
      padding: 12px 16px; border-bottom: 1px solid var(--steel);
      display: flex; align-items: center; justify-content: space-between;
    }

    .cardBody { padding: 16px; }
    .formGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .formGrid .full { grid-column: 1 / -1; }
    
    label { display: block; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }

    .tableWrap { overflow: auto; max-height: calc(100vh - 180px); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
    thead th {
      position: sticky; top: 0; background: var(--panel);
      z-index: 10; border-bottom: 2px solid var(--steel);
      text-align: left; padding: 12px; color: var(--muted);
    }
    tbody td { border-bottom: 1px solid var(--steel); padding: 10px 12px; }

    .modalOverlay {
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7);
      display: none; align-items: center; justify-content: center;
      z-index: 1000; padding: 20px; backdrop-filter: blur(4px);
    }
    .modal {
      width: min(800px, 100%); max-height: 85vh; 
      background: var(--panel); border-radius: 16px;
      display: flex; flex-direction: column;
    }
    .modalBody { padding: 20px; overflow-y: auto; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Tek-Pak Admin</h1>
        <div class="sub">Inventory Control Panel</div>
      </div>
      <div class="row">
        <input id="q" placeholder="Search..." style="width:200px">
        <select id="cat" style="width:150px"><option value="">Categories</option></select>
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn" id="themeToggle" style="width:40px; padding:0">ðŸŒ“</button>
      </div>
    </div>
  </div>
</header>

<div class="grid">
  <aside>
    <section class="card">
      <div class="cardHead">
        <h2 style="font-size:14px; margin:0">Add New Item</h2>
        <button class="btn primary" id="addBtn">Add to Sheet</button>
      </div>
      <div class="cardBody">
        <div class="formGrid">
          <div class="field full"><label>Title</label><input id="f_title"></div>
          <div class="field"><label>SKU</label><input id="f_sku"></div>
          <div class="field"><label>Category</label><input id="f_category"></div>
          <div class="field"><label>Condition</label><input id="f_condition"></div>
          <div class="field"><label>Price</label><input id="f_price"></div>
          <div class="field full"><label>Description</label><textarea id="f_description" style="height:60px"></textarea></div>
          <div class="field full">
            <label>Images (Comma separated)</label>
            <textarea id="f_images" placeholder="URL 1, URL 2..." style="height:50px"></textarea>
          </div>
          <div class="field full"><label>Buy URL</label><input id="f_buy_url"></div>
          <div class="field full"><label>Bid URL</label><input id="f_bid_url"></div>
        </div>
      </div>
    </section>
  </aside>

  <main class="card">
    <div class="cardHead">
      <h2 style="font-size:14px; margin:0">Current Inventory</h2>
      <span id="countPill" style="font-size:11px; opacity:0.6">0 Items</span>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>SKU</th>
            <th>Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>
</div>

<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="cardHead">
      <h3>Edit Item</h3>
      <div class="row">
        <button class="btn" id="closeModal">Cancel</button>
        <button class="btn primary" id="saveModal" style="background:var(--good); border-color:var(--good)">Save Changes</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="formGrid" id="modalFields">
        </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyLMf07vAWn1qdtL_FMVvCRf6GytYvXAtbzTLgqZRHurZisb7Qba4gYtsTwkhL-8vJu/exec";

const els = {
  q: document.getElementById('q'),
  cat: document.getElementById('cat'),
  refresh: document.getElementById('refresh'),
  tbody: document.getElementById('tbody'),
  addBtn: document.getElementById('addBtn'),
  themeToggle: document.getElementById('themeToggle'),
  modalOverlay: document.getElementById('modalOverlay'),
  closeModal: document.getElementById('closeModal'),
  saveModal: document.getElementById('saveModal'),
  // Form inputs
  f_title: document.getElementById('f_title'),
  f_sku: document.getElementById('f_sku'),
  f_category: document.getElementById('f_category'),
  f_condition: document.getElementById('f_condition'),
  f_price: document.getElementById('f_price'),
  f_description: document.getElementById('f_description'),
  f_images: document.getElementById('f_images'),
  f_buy_url: document.getElementById('f_buy_url'),
  f_bid_url: document.getElementById('f_bid_url'),
};

let ALL_DATA = [];

// --- THEME ---
const setTheme = (t) => {
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('tekpak-theme', t);
};
setTheme(localStorage.getItem('tekpak-theme') || 'light');
els.themeToggle.onclick = () => setTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');

// --- API HANDLING ---
async function loadData() {
  els.refresh.disabled = true;
  els.refresh.textContent = "Loading...";
  try {
    const res = await fetch(`${API_URL}?action=list`);
    const json = await res.json();
    ALL_DATA = Array.isArray(json) ? json : (json.data || []);
    render();
  } catch (e) {
    console.error("Load failed", e);
  } finally {
    els.refresh.disabled = false;
    els.refresh.textContent = "Refresh";
  }
}

function render() {
  const q = els.q.value.toLowerCase();
  const filtered = ALL_DATA.filter(i => 
    (i.title || i.item || '').toLowerCase().includes(q) || 
    (i.sku || '').toLowerCase().includes(q)
  );
  
  document.getElementById('countPill').textContent = `${filtered.length} Items`;
  els.tbody.innerHTML = filtered.map(i => `
    <tr>
      <td><b>${i.title || i.item || 'N/A'}</b></td>
      <td>${i.sku || '-'}</td>
      <td>$${i.price || '0'}</td>
      <td><button class="btn" onclick="openEdit('${i.id || i.ID}')">Edit</button></td>
    </tr>
  `).join('');
}

async function addItem() {
  const title = els.f_title.value.trim();
  if (!title) return alert("Please enter a title");

  const payload = {
    action: 'add',
    title: title,
    sku: els.f_sku.value.trim(),
    category: els.f_category.value.trim(),
    condition: els.f_condition.value.trim(),
    price: els.f_price.value.trim(),
    description: els.f_description.value.trim(),
    images: els.f_images.value.trim(),
    buy_url: els.f_buy_url.value.trim(),
    bid_url: els.f_bid_url.value.trim()
  };

  els.addBtn.disabled = true;
  els.addBtn.textContent = "Sending...";

  try {
    // Mode 'no-cors' prevents the browser from hanging on Google's redirect
    await fetch(API_URL, {
      method: 'POST',
      mode: 'no-cors', 
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams(payload)
    });

    // We can't read the response in 'no-cors', so we just wait a moment and reload
    setTimeout(() => {
      alert("Item submitted successfully!");
      clearForm();
      loadData();
      els.addBtn.disabled = false;
      els.addBtn.textContent = "Add to Sheet";
    }, 1000);

  } catch (err) {
    alert("Error adding item. See console.");
    console.error(err);
    els.addBtn.disabled = false;
    els.addBtn.textContent = "Add to Sheet";
  }
}

function clearForm() {
  [els.f_title, els.f_sku, els.f_category, els.f_condition, els.f_price, els.f_description, els.f_images, els.f_buy_url, els.f_bid_url].forEach(i => i.value = '');
}

// Global scope for button clicks
window.openEdit = (id) => {
  const item = ALL_DATA.find(x => String(x.id || x.ID) === String(id));
  if(!item) return;
  // Simplified for brevity - you can expand this modal logic
  alert("Editing: " + (item.title || item.item));
};

els.q.oninput = render;
els.refresh.onclick = loadData;
els.addBtn.onclick = addItem;
els.closeModal.onclick = () => els.modalOverlay.style.display = 'none';

loadData();
</script>
</body>
</html>
