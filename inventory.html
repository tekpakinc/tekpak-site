<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YardOS — Inventory</title>
  <link rel="stylesheet" href="./styles.css"/>
  <style>
    /* Modal editor */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(10,20,40,.30);
      display:none;
      z-index: 9999;
    }
    .modalBack.show{ display:block; }

    .modal{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width: min(1100px, 96vw);
      height: min(86vh, 920px);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal .mhd{
      padding: 14px 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
    }
    .modal .mhd h3{ margin:0; font-size:15px; }
    .modal .mhd .sub{ margin-top:4px; font-size:12px; color:var(--muted); }
    .modal .mbd{
      padding: 14px;
      overflow:auto;
      flex:1;
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .tabBtn{
      padding:8px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      cursor:pointer;
    }
    .tabBtn.active{
      background: rgba(11,79,179,.12);
      border-color: rgba(11,79,179,.25);
    }
    .section{ display:none; }
    .section.show{ display:block; }

    .fieldGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 980px){ .fieldGrid{ grid-template-columns: 1fr; } }
    .field{
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.88);
      padding:10px;
    }
    .field .lbl{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:900;
    }
    .field input, .field textarea, .field select{
      width:100%;
    }
    .field textarea{ min-height: 96px; }
    .monoIn{ font-family: var(--mono); }
    .stickyBar{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(255,255,255,.90);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      margin-bottom: 12px;
      backdrop-filter: blur(8px);
    }
  </style>
</head>
<body>
<header class="topbar">
  <div class="wrap">
    <div class="brand">
      <img id="logo" alt="Tek-Pak" />
      <span class="badge">Inventory</span>
    </div>
    <nav class="nav">
      <a href="./index.html">Shop</a>
      <a class="active" href="./inventory.html">Inventory</a>
      <a href="./portal.html">Employee Portal</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="card">
    <div class="hd">
      <div>
        <h2>Inventory Manager</h2>
        <div class="sub">Click a row to open the full editor window.</div>
      </div>
      <div class="controls">
        <button class="btn" id="btnAdmin">Admin: <span id="adminState">LOCKED</span></button>
        <button class="btn bad" id="btnLock">Lock</button>
      </div>
    </div>

    <div class="bd">
      <div class="controls">
        <select class="select" id="tabSel">
          <option value="Inventory_Retail">Inventory_Retail</option>
          <option value="Inventory_Parts">Inventory_Parts</option>
        </select>

        <input class="input" id="q" placeholder="Search SKU / title / serial / notes…" />

        <select class="select" id="statusSel">
          <option value="">All statuses</option>
          <option>AVAILABLE</option>
          <option>LISTED</option>
          <option>SOLD</option>
          <option>HOLD</option>
          <option>PARTS_ONLY</option>
          <option>SCRAP</option>
          <option>INTAKE</option>
          <option>TRIAGE</option>
        </select>

        <button class="btn primary" id="btnLoad">Load</button>
        <button class="btn good" id="btnAdd">Add Item</button>
      </div>

      <div style="height:12px"></div>
      <div class="small" id="meta">Loading…</div>

      <div style="height:12px"></div>
      <div class="tableWrap">
        <table class="table" id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<!-- Modal -->
<div class="modalBack" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="mhd">
      <div>
        <h3 id="mTitle">Edit Item</h3>
        <div class="sub" id="mSub"></div>
      </div>
      <div class="controls">
        <button class="btn" id="btnClose">Close</button>
      </div>
    </div>

    <div class="mbd">
      <div class="stickyBar">
        <div class="controls">
          <button class="btn" id="btnRefresh">Refresh</button>
          <button class="btn primary" id="btnSave">Save</button>
          <button class="btn" id="btnGenHtml">Generate eBay HTML</button>
          <button class="btn" id="btnCopyHtml">Copy eBay HTML</button>
        </div>
        <div style="height:8px"></div>
        <div class="controls">
          <button class="btn good" data-status="AVAILABLE">AVAILABLE</button>
          <button class="btn good" data-status="LISTED">LISTED</button>
          <button class="btn" data-status="HOLD">HOLD</button>
          <button class="btn bad" data-status="SOLD">SOLD</button>
          <button class="btn bad" data-status="SCRAP">SCRAP</button>
          <button class="btn" data-status="PARTS_ONLY">PARTS_ONLY</button>
        </div>
        <div style="height:8px"></div>
        <div class="small">Admin PIN required for Save / Generate / Status edits.</div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" data-tab="ess">Essentials</button>
        <button class="tabBtn" data-tab="cond">Condition / Issues</button>
        <button class="tabBtn" data-tab="pricing">Pricing / eBay</button>
        <button class="tabBtn" data-tab="logistics">Logistics</button>
        <button class="tabBtn" data-tab="all">All Fields</button>
      </div>

      <div class="section show" id="sec-ess"></div>
      <div class="section" id="sec-cond"></div>
      <div class="section" id="sec-pricing"></div>
      <div class="section" id="sec-logistics"></div>
      <div class="section" id="sec-all"></div>
    </div>
  </div>
</div>

<script src="./app.js"></script>
<script>
let CONFIG = { companyName:"Tek-Pak Inc.", logoUrl:"" };
let HEADERS = [];
let ITEMS = [];
let ACTIVE = { tab:"Inventory_Retail", row:0, item:null };

const FIELD_UI = {}; // header -> input element

function adminUiRefresh(){
  qs("#adminState").textContent = adminIsUnlocked() ? "UNLOCKED" : "LOCKED";
}

function statusPill(status){
  const st = String(status||"").toUpperCase();
  const cls = isSellableStatus(st) ? "good" : (st==="SCRAP"||st==="SOLD" ? "bad" : "warn");
  return `<span class="pill ${cls}">${escHtml(st || "—")}</span>`;
}

function renderTable(headers, items){
  const showCols = ["_row","TP_SKU","Title","Category","Brand","Model","Status","Yard_Location","Qty","List_Price","eBay_ItemID"];
  qs("#thead").innerHTML = `<tr>${showCols.map(h => `<th>${escHtml(h)}</th>`).join("")}</tr>`;
  qs("#tbody").innerHTML = items.map(it => `
    <tr data-row="${it._row}">
      ${showCols.map(h => {
        const v = (h === "_row") ? it._row : (it[h] ?? "");
        if (h === "Status") return `<td>${statusPill(v)}</td>`;
        if (h === "TP_SKU" || h === "Yard_Location") return `<td class="mono">${escHtml(v)}</td>`;
        return `<td>${escHtml(v)}</td>`;
      }).join("")}
    </tr>
  `).join("");

  qs("#meta").textContent = `Loaded ${items.length} item(s) from ${ACTIVE.tab}. Click a row to edit.`;
}

async function apiRow(tab, row){
  const res = await apiGet({ action:"getRow", tab, row });
  return res.item;
}

async function loadInventory(){
  ACTIVE.tab = qs("#tabSel").value;
  const q = qs("#q").value.trim();
  const status = qs("#statusSel").value.trim();

  try{
    const data = await apiGet({ action:"listInventory", tab: ACTIVE.tab, q, status });
    HEADERS = data.headers || [];
    ITEMS = data.items || [];
    renderTable(HEADERS, ITEMS);
    toast("Inventory loaded.");
  }catch(err){
    toast(err.message, "bad");
  }
}

function openModal(){
  qs("#modalBack").classList.add("show");
}
function closeModal(){
  qs("#modalBack").classList.remove("show");
  ACTIVE.row = 0;
  ACTIVE.item = null;
}

function fieldBox(label, inputHtml){
  return `
    <div class="field">
      <div class="lbl">${escHtml(label)}</div>
      ${inputHtml}
    </div>
  `;
}

function makeInputForHeader(h, value){
  const key = String(h||"").trim();
  const v = value ?? "";

  const isLong = /Notes|Known_Issues|Included|Description|eBay_HTML/i.test(key);
  const isMono = /SKU|Serial|IMEI|IP|MAC|ItemID|Location|Part_Number/i.test(key);

  if (isLong){
    return `<textarea class="input ${isMono ? "mono monoIn" : ""}" data-field="${escHtml(key)}">${escHtml(v)}</textarea>`;
  }
  return `<input class="input ${isMono ? "mono monoIn" : ""}" data-field="${escHtml(key)}" value="${escHtml(v)}" />`;
}

function buildEditor(item){
  // Clear maps
  Object.keys(FIELD_UI).forEach(k => delete FIELD_UI[k]);

  qs("#mTitle").textContent = item.Title || "Edit Item";
  qs("#mSub").textContent = `Row ${item._row} • ${item.TP_SKU || "N/A"} • ${CONFIG.companyName}`;

  const get = (k)=> item[k] ?? "";

  const essentials = ["TP_SKU","Status","Title","Category","Brand","Model","Part_Number","Serial_Number","Qty","Yard_Location"];
  const condition = ["Condition_Grade","Testing_Status","Cosmetic_Notes","Known_Issues","Included"];
  const pricing = ["List_Price","eBay_Listing_Title","eBay_ItemID","eBay_HTML"];
  const logistics = ["Shipping_Profile","Returns_Profile","Weight","Dimensions","Power_Adapter","Accessories","Intake_Date"];

  function sectionMarkup(list){
    return `<div class="fieldGrid">` + list
      .filter(h => HEADERS.includes(h))
      .map(h => fieldBox(h, makeInputForHeader(h, get(h))))
      .join("") + `</div>`;
  }

  qs("#sec-ess").innerHTML = sectionMarkup(essentials);
  qs("#sec-cond").innerHTML = sectionMarkup(condition);
  qs("#sec-pricing").innerHTML = sectionMarkup(pricing);
  qs("#sec-logistics").innerHTML = sectionMarkup(logistics);

  // All fields (everything from header row)
  qs("#sec-all").innerHTML = `<div class="fieldGrid">` + HEADERS
    .filter(h => h && h !== "_row")
    .map(h => fieldBox(h, makeInputForHeader(h, get(h))))
    .join("") + `</div>`;

  // Map inputs
  qsa("[data-field]").forEach(el => {
    const f = el.getAttribute("data-field");
    FIELD_UI[f] = el;
  });
}

function collectPayload(){
  const payload = { _row: ACTIVE.row };
  HEADERS.forEach(h => {
    if (!h || h === "_row") return;
    const el = FIELD_UI[h];
    if (!el) return;
    payload[h] = el.value;
  });
  return payload;
}

async function saveItem(){
  if (!requireAdmin()) return;
  const payload = collectPayload();

  try{
    const res = await apiGet({
      action:"upsertInventory",
      tab: ACTIVE.tab,
      user: "yardos-web",
      payload: JSON.stringify(payload)
    });
    toast(`Saved ${res.TP_SKU || ""}.`);
    await loadInventory();
    const fresh = await apiRow(ACTIVE.tab, ACTIVE.row);
    ACTIVE.item = fresh;
    buildEditor(fresh);
  }catch(err){
    toast(err.message, "bad");
  }
}

async function genHtml(){
  if (!requireAdmin()) return;
  try{
    const res = await apiGet({ action:"generateEbayHtml", tab: ACTIVE.tab, row: ACTIVE.row, user:"yardos-web" });
    toast(`Generated eBay HTML (${res.bytes} bytes).`);
    const fresh = await apiRow(ACTIVE.tab, ACTIVE.row);
    ACTIVE.item = fresh;
    buildEditor(fresh);
  }catch(err){
    toast(err.message, "bad");
  }
}

async function addItemWizard(){
  if (!requireAdmin()) return;
  const title = prompt("Title for new item?");
  if (!title) return;

  const payload = { Title:title, Status:"INTAKE", Qty:1 };

  try{
    const res = await apiGet({
      action:"upsertInventory",
      tab: ACTIVE.tab,
      user:"yardos-web",
      payload: JSON.stringify(payload)
    });
    toast(`Created ${res.TP_SKU}.`);
    await loadInventory();
    const found = await apiGet({ action:"findBySku", tab: ACTIVE.tab, sku: res.TP_SKU });
    if (found.found){
      ACTIVE.row = found.row;
      ACTIVE.item = found.item;
      buildEditor(found.item);
      openModal();
    }
  }catch(err){ toast(err.message,"bad"); }
}

// Tab switching
qsa(".tabBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    qsa(".tabBtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const id = btn.getAttribute("data-tab");
    qsa(".section").forEach(s=>s.classList.remove("show"));
    qs(`#sec-${id}`).classList.add("show");
  });
});

// events
qs("#btnLoad").addEventListener("click", loadInventory);
qs("#q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadInventory(); });

qs("#btnAdmin").addEventListener("click", ()=>{ adminUnlock(); adminUiRefresh(); });
qs("#btnLock").addEventListener("click", ()=>{ adminLock(); adminUiRefresh(); });

qs("#btnAdd").addEventListener("click", addItemWizard);

qs("#tbody").addEventListener("click", async (e)=>{
  const tr = e.target.closest("tr");
  if (!tr) return;
  const row = Number(tr.getAttribute("data-row") || "0");
  if (!row) return;

  try{
    ACTIVE.row = row;
    const item = await apiRow(ACTIVE.tab, row);
    ACTIVE.item = item;
    buildEditor(item);
    openModal();
  }catch(err){ toast(err.message,"bad"); }
});

qs("#btnClose").addEventListener("click", closeModal);
qs("#modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

qs("#btnRefresh").addEventListener("click", async ()=>{
  try{
    const item = await apiRow(ACTIVE.tab, ACTIVE.row);
    ACTIVE.item = item;
    buildEditor(item);
    toast("Refreshed.");
  }catch(err){ toast(err.message,"bad"); }
});

qs("#btnSave").addEventListener("click", saveItem);
qs("#btnGenHtml").addEventListener("click", genHtml);

qs("#btnCopyHtml").addEventListener("click", async ()=>{
  const el = FIELD_UI["eBay_HTML"];
  const txt = el ? el.value.trim() : "";
  if (!txt) return toast("No eBay HTML to copy.", "bad");
  await navigator.clipboard.writeText(txt);
  toast("Copied eBay HTML.");
});

// Status buttons
qsa("button[data-status]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    if (!requireAdmin()) return;
    const st = btn.getAttribute("data-status");
    const el = FIELD_UI["Status"];
    if (el) el.value = st;
    toast(`Status set: ${st}`);
  });
});

// init
(async function init(){
  CONFIG = await loadConfig();
  setLogo(qs("#logo"), CONFIG.logoUrl);
  adminUiRefresh();
  await loadInventory();
})();
</script>
</body>
</html>
