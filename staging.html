<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YardFlow Command Center ‚Äî STAGING</title>
<style>
  :root{
    --bg:#070b14; --panel:#0f1727; --panel2:#0b1220; --text:#eaf1ff; --muted:#9fb3d1;
    --line:rgba(255,255,255,.10); --accent:#3aa0ff; --good:#3dff8d; --warn:#ffd166; --bad:#ff4d6d;
    --r:18px; --r2:22px; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    --sans: system-ui,-apple-system, Segoe UI, Roboto, Arial;
    --shadow: 0 22px 60px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text); font-family:var(--sans);
    background:
      radial-gradient(900px 600px at 15% -10%, rgba(58,160,255,.20), transparent 60%),
      radial-gradient(900px 600px at 95% 10%, rgba(255,77,109,.10), transparent 55%),
      var(--bg);
  }
  header{
    position:sticky; top:0; z-index:10;
    padding:14px 16px; border-bottom:1px solid var(--line);
    background:linear-gradient(180deg, rgba(15,23,39,.92), rgba(7,11,20,.70));
    backdrop-filter: blur(10px);
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }
  .brand{display:flex; gap:12px; align-items:center}
  .logo{
    width:38px; height:38px; border-radius:14px;
    background:linear-gradient(135deg, rgba(255,77,109,.85), rgba(58,160,255,.55));
    box-shadow:0 14px 40px rgba(0,0,0,.45);
  }
  .title{font-weight:900; letter-spacing:.2px}
  .sub{color:var(--muted); font-size:12px; line-height:1.2}
  .nav{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
  .chipNav{
    font-size:12px; padding:7px 10px; border-radius:999px; border:1px solid var(--line);
    background:rgba(255,255,255,.04); color:var(--text); text-decoration:none; font-weight:800;
  }
  .chipNav.active{border-color:rgba(255,77,109,.65); box-shadow:0 0 0 2px rgba(255,77,109,.12) inset}
  .wrap{
    display:grid; grid-template-columns: 360px 1fr; gap:14px;
    padding:14px; max-width:1500px; margin:0 auto;
  }
  @media (max-width: 1040px){ .wrap{grid-template-columns:1fr} }
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--line);
    border-radius:var(--r2);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card h3{
    margin:0; padding:12px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-size:14px; letter-spacing:.2px;
  }
  .card .body{padding:12px}
  .gridKpi{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
  @media (max-width: 1040px){ .gridKpi{grid-template-columns: repeat(2, 1fr)} }
  .kpi{
    border:1px solid var(--line); border-radius:18px; padding:10px;
    background:rgba(0,0,0,.20);
  }
  .kpi .label{color:var(--muted); font-size:11px}
  .kpi .value{font-weight:950; font-size:18px; margin-top:4px}
  .kpi .mini{color:var(--muted); font-size:11px; margin-top:2px}

  .lab{font-size:12px; color:var(--muted); margin:10px 0 6px}
  input, select, textarea{
    width:100%; padding:10px 10px; border-radius:14px;
    border:1px solid var(--line); background:rgba(0,0,0,.25); color:var(--text);
    outline:none;
  }
  textarea{min-height:110px; resize:vertical; font-family: var(--sans);}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width: 700px){ .row{grid-template-columns:1fr} }
  .btns{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  button{
    border:none; border-radius:14px; padding:10px 12px; cursor:pointer;
    background:rgba(255,255,255,.06); color:var(--text); font-weight:900;
    border:1px solid var(--line);
  }
  button.primary{background:linear-gradient(135deg, rgba(58,160,255,.95), rgba(58,160,255,.55)); border-color:rgba(58,160,255,.55)}
  button.good{background:linear-gradient(135deg, rgba(61,255,141,.85), rgba(61,255,141,.35)); border-color:rgba(61,255,141,.55); color:#06210f}
  button.warn{background:linear-gradient(135deg, rgba(255,209,102,.9), rgba(255,209,102,.35)); border-color:rgba(255,209,102,.55); color:#241600}
  button.danger{background:linear-gradient(135deg, rgba(255,77,109,.9), rgba(255,77,109,.35)); border-color:rgba(255,77,109,.55); color:#2a0010}
  .list{display:flex; flex-direction:column; gap:8px; max-height:62vh; overflow:auto; padding-right:6px}
  .item{
    padding:10px; border-radius:18px; border:1px solid var(--line);
    background:rgba(255,255,255,.03); cursor:pointer;
  }
  .item .top{display:flex; justify-content:space-between; gap:10px; align-items:center}
  .tp{font-family:var(--mono); font-weight:950; font-size:12px}
  .pill{font-size:11px; padding:5px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted)}
  .meta{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.25}
  .divider{height:1px; background:var(--line); margin:12px 0}
  .hint{color:var(--muted); font-size:12px; line-height:1.35}
  .rightHead{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .statusLine{color:var(--muted); font-size:12px}
  .toast{
    position:fixed; left:14px; bottom:14px;
    background:rgba(0,0,0,.65); border:1px solid var(--line);
    padding:10px 12px; border-radius:14px; display:none;
  }
  .kbd{font-family:var(--mono); font-size:11px; color:var(--muted)}
  .miniBtn{padding:8px 10px; border-radius:12px; font-size:12px}

  /* Photos */
  .photoBar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .photoGrid{
    display:grid;
    grid-template-columns: repeat(6, minmax(120px, 1fr));
    gap:10px;
  }
  @media (max-width: 1200px){ .photoGrid{grid-template-columns: repeat(3, minmax(120px, 1fr));} }
  @media (max-width: 650px){ .photoGrid{grid-template-columns: repeat(2, minmax(120px, 1fr));} }
  .thumb{
    border:1px solid var(--line); border-radius:18px; overflow:hidden;
    background:rgba(0,0,0,.25);
  }
  .thumb img{
    width:100%; height:120px; object-fit:cover; display:block;
    background:rgba(255,255,255,.04);
  }
  .thumb .cap{
    padding:8px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
    color:var(--muted); font-size:12px;
  }
  .cap .left{display:flex; gap:8px; align-items:center}
  .badge{font-family:var(--mono); font-size:11px; color:var(--muted); border:1px solid var(--line); padding:3px 7px; border-radius:999px}
  .urlBox{font-family:var(--mono); font-size:12px; min-height:84px}
  .outBox{font-family:var(--mono); font-size:12px; min-height:280px; white-space:pre; }

  .checkRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .checkRow label{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px}
  .checkRow input[type="checkbox"]{width:16px; height:16px; accent-color: var(--accent);}

  .tpCallout{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    padding:10px; border-radius:16px; border:1px solid var(--line);
    background:rgba(0,0,0,.22);
  }
  .tpCallout .big{font-family:var(--mono); font-weight:950;}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <div class="title">YardFlow Command Center</div>
      <div class="sub"><b>STAGING</b> ‚Ä¢ Sheet-backed ‚Ä¢ Photos + Tek-Pak eBay HTML Generator</div>
    </div>
  </div>

  <div class="nav">
    <a class="chipNav" href="./intake.html">Intake</a>
    <a class="chipNav" href="./processing.html">Processing</a>
    <a class="chipNav active" href="./staging.html">Staging</a>
    <a class="chipNav" href="./logistics.html">Logistics</a>
    <button class="miniBtn" onclick="openTpSettings()">TP Settings</button>
    <button class="primary" onclick="newItem()">+ New TP</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h3>STAGING Queue <span class="pill" id="queueCount">0</span></h3>
    <div class="body">
      <div class="lab">Search</div>
      <input id="q" placeholder="TP, title, OS‚Ä¶" oninput="renderList()" />

      <div class="row">
        <div>
          <div class="lab">Filter: Sale Type</div>
          <select id="filtSaleType" onchange="renderList()"></select>
        </div>
        <div>
          <div class="lab">Sort</div>
          <select id="sortBy" onchange="renderList()">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="tp">TP#</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>
      <div class="list" id="list"></div>

      <div class="divider"></div>
      <div class="hint">
        <b>Shortcuts:</b>
        <span class="kbd">Enter</span> save ‚Ä¢
        <span class="kbd">Ctrl</span>+<span class="kbd">G</span> generate eBay HTML ‚Ä¢
        <span class="kbd">Ctrl</span>+<span class="kbd">F</span> search
      </div>
    </div>
  </div>

  <div style="display:grid; gap:14px">
    <div class="card">
      <h3>Today‚Äôs Snapshot</h3>
      <div class="body">
        <div class="gridKpi">
          <div class="kpi"><div class="label">In Staging</div><div class="value" id="kpiQueue">0</div><div class="mini">items waiting</div></div>
          <div class="kpi"><div class="label">Missing Title</div><div class="value" id="kpiTitle">0</div><div class="mini">quick fix</div></div>
          <div class="kpi"><div class="label">Missing Price</div><div class="value" id="kpiPrice">0</div><div class="mini">USD</div></div>
          <div class="kpi"><div class="label">Photos Attached</div><div class="value" id="kpiPhotos">0</div><div class="mini">local per TP</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3><div class="rightHead"><span>Staging Form</span><span class="statusLine" id="statusLine">‚Äî</span></div></h3>
      <div class="body" id="detail">
        <div class="hint">Select an item from the queue.</div>
      </div>
    </div>

    <div class="card">
      <h3>Tek-Pak eBay HTML Generator</h3>
      <div class="body" id="generator">
        <div class="hint">Select an item to generate eBay HTML.</div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===================== CONFIG ===================== */
const API_URL = "PASTE_YOUR_WEB_APP_URL_HERE"; // <-- REQUIRED
const API_KEY = ""; // optional: match backend API_KEY if you set one

const STAGE = "STAGING";
const NEXT_STAGE = "LOGISTICS";
const PREV_STAGE = "PROCESSING";

/* Logo support */
const DEFAULT_LOGO_URL = "assets/tekpak-logo.png";

/* TP generator settings (random 9 default) */
const TP_SETTINGS_KEY = "yardflow_tp_settings_v1";
const DEFAULT_TP_SETTINGS = {
  prefix: "",
  includeDate: false,
  sep: "-",
  randLen: 9,
  charset: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
  case: "upper"
};

const PHOTO_KEY = "yardflow_photos_v1"; // local-only: { [TP]: [{name,dataUrl,ts}] }
let photosDB = {};
let dropdowns = {};

/* Queue cache (from sheet) */
let db = []; // listItems payloads
let currentTP = null;

/* ===================== UTIL ===================== */
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display="none", 1700);
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("'","&#39;"); }
function uniq(list){ return [...new Set(list.filter(Boolean))]; }

function loadPhotos(){ photosDB = JSON.parse(localStorage.getItem(PHOTO_KEY) || "{}"); }
function savePhotos(){ localStorage.setItem(PHOTO_KEY, JSON.stringify(photosDB)); }

/* ===================== JSONP GET ===================== */
function apiGet(params){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const timeout = setTimeout(()=>{
      cleanup();
      reject(new Error("API timeout"));
    }, 12000);

    function cleanup(){
      clearTimeout(timeout);
      try{ delete window[cb]; }catch{}
      if (script && script.parentNode) script.parentNode.removeChild(script);
    }

    window[cb] = (data)=>{
      cleanup();
      resolve(data);
    };

    const q = new URLSearchParams({ ...params, callback: cb });
    if (API_KEY) q.set("key", API_KEY);

    const url = API_URL + (API_URL.includes("?") ? "&" : "?") + q.toString();
    const script = document.createElement("script");
    script.src = url;
    script.onerror = ()=>{ cleanup(); reject(new Error("API load error")); };
    document.head.appendChild(script);
  });
}

/* ===================== POST (best for large text) ===================== */
async function apiPost(action, payload){
  const url = API_URL + (API_URL.includes("?") ? "&" : "?") + new URLSearchParams({
    action,
    ...(API_KEY ? { key: API_KEY } : {})
  }).toString();

  // CORS is limited on Apps Script; use no-cors and then verify with a read.
  await fetch(url, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  // Verify by pulling the item back via JSONP
  if (payload && payload.TP){
    const res = await apiGet({ action:"readItem", tp: payload.TP });
    return res;
  }
  return { ok:true };
}

/* ===================== TP generator ===================== */
function loadTpSettings(){
  try{
    return { ...DEFAULT_TP_SETTINGS, ...(JSON.parse(localStorage.getItem(TP_SETTINGS_KEY) || "{}")) };
  }catch{
    return { ...DEFAULT_TP_SETTINGS };
  }
}
function saveTpSettings(s){ localStorage.setItem(TP_SETTINGS_KEY, JSON.stringify(s)); }
function formatDateYYYYMMDD(d=new Date()){
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`;
}
function randomBlock(len, charset){
  len = Math.max(3, Number(len)||9);
  charset = String(charset || DEFAULT_TP_SETTINGS.charset);
  try{
    const arr = new Uint32Array(len);
    crypto.getRandomValues(arr);
    let out = "";
    for (let i=0;i<len;i++) out += charset[arr[i] % charset.length];
    return out;
  }catch{
    let out = "";
    for (let i=0;i<len;i++) out += charset[Math.floor(Math.random()*charset.length)];
    return out;
  }
}
function normalizeTP(tp){
  return String(tp || "").trim().replace(/\s+/g,"").toUpperCase();
}
function generateTP(customOverrides = {}){
  const s = { ...loadTpSettings(), ...customOverrides };
  const parts = [];
  const prefix = String(s.prefix || "").trim();
  if (prefix) parts.push(prefix);
  if (s.includeDate) parts.push(formatDateYYYYMMDD());
  let block = randomBlock(s.randLen, s.charset);
  block = (s.case === "lower") ? block.toLowerCase() : block.toUpperCase();
  parts.push(block);
  const sep = (s.sep ?? "-");
  return parts.join(sep);
}
function tpExistsLocal(tp){ return db.some(x => String(x.TP||"").trim() === tp); }
function generateUniqueTP(){
  for (let i=0;i<100;i++){
    const tp = generateTP();
    if (!tpExistsLocal(tp)) return tp;
  }
  return generateTP({ randLen: (loadTpSettings().randLen || 9) + 2 }) + "-" + Date.now().toString(36).toUpperCase();
}

/* ===================== DROPDOWNS ===================== */
function selectHTML(list, selected){
  list = list || [];
  return `<option value="">‚Äî</option>` + list.map(v=>`<option ${v===selected?'selected':''}>${escapeHtml(v)}</option>`).join("");
}

/* ===================== SHEET DATA ===================== */
async function refreshQueue(){
  const res = await apiGet({ action:"listItems", stage: STAGE, limit: 300 });
  if (!res || !res.ok) throw new Error(res?.error || "Failed listItems");
  db = res.items || [];
}

async function readItem(tp){
  const res = await apiGet({ action:"readItem", tp });
  if (!res || !res.ok) throw new Error(res?.error || "Failed readItem");
  return res.item;
}

/* ===================== UI ===================== */
function setFilterOptions(){
  const sel = document.getElementById("filtSaleType");
  const values = uniq(db.map(x=>x.SaleType).filter(Boolean));
  sel.innerHTML = `<option value="">All</option>` + values.map(v=>`<option>${escapeHtml(v)}</option>`).join("");
}

function renderKPIs(){
  const queue = db;
  document.getElementById("kpiQueue").textContent = queue.length;
  document.getElementById("kpiTitle").textContent = queue.filter(x=>!(x.Title||"").toString().trim()).length;
  document.getElementById("kpiPrice").textContent = queue.filter(x=>!(x.PriceUSD||"").toString().trim()).length;

  let photoCount = 0;
  queue.forEach(it=>{
    const arr = (photosDB[it.TP] || []);
    if (arr.length) photoCount++;
  });
  document.getElementById("kpiPhotos").textContent = photoCount;
}

function renderList(){
  const q = (document.getElementById("q").value || "").toLowerCase();
  const saleType = document.getElementById("filtSaleType").value || "";
  const sortBy = document.getElementById("sortBy").value;

  let list = [...db];
  if (saleType) list = list.filter(x => (x.SaleType||"") === saleType);

  if (q){
    list = list.filter(x=>{
      const hay = [x.TP,x.Title,x.Description,x.PriceUSD,x.OperatingSystem,x.Warranty,x.SaleType].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  if (sortBy==="newest") list.sort((a,b)=>(Number(b.CreatedAt)||0)-(Number(a.CreatedAt)||0));
  if (sortBy==="oldest") list.sort((a,b)=>(Number(a.CreatedAt)||0)-(Number(b.CreatedAt)||0));
  if (sortBy==="tp") list.sort((a,b)=>(String(a.TP||"")).localeCompare(String(b.TP||"")));

  document.getElementById("queueCount").textContent = list.length;

  const el = document.getElementById("list");
  el.innerHTML = "";

  if (!list.length){
    el.innerHTML = `<div class="hint">No items in ${STAGE}.</div>`;
    setFilterOptions(); renderKPIs();
    return;
  }

  list.forEach(it=>{
    const d = document.createElement("div");
    d.className = "item";
    d.onclick = ()=> openItem(it.TP);

    const needs = (!(it.Title||"").toString().trim() || !(it.PriceUSD||"").toString().trim())
      ? ` <span class="pill" style="border-color:rgba(255,209,102,.55)">Needs basics</span>` : "";
    const pcount = (photosDB[it.TP] || []).length;
    const returnsAccepted = String(it.ReturnsAccepted).toLowerCase() === "true" || it.ReturnsAccepted === true || it.ReturnsAccepted === 1;
    const returnsLabel = (it.SaleType==="As-Is" || it.SaleType==="Surplus") ? "NO RETURNS" : (returnsAccepted ? "Returns OK" : "As listed");

    d.innerHTML = `
      <div class="top">
        <div class="tp">${escapeHtml(it.TP)}</div>
        <div class="pill">${escapeHtml(it.SaleType || "‚Äî")}</div>
      </div>
      <div class="meta">
        <b>${escapeHtml(it.Title || "‚Äî")}</b>${needs}<br>
        Price: ${escapeHtml(it.PriceUSD || "‚Äî")} ‚Ä¢ Warranty: ${escapeHtml(it.Warranty || "‚Äî")}
        <br>üîÅ ${escapeHtml(returnsLabel)} ‚Ä¢ üì∏ <b>${pcount}</b>
      </div>
    `;
    el.appendChild(d);
  });

  setFilterOptions();
  renderKPIs();
}

/* ===================== Photos (local only) ===================== */
function getPhotos(tp){ return photosDB[tp] || []; }
function setPhotos(tp, arr){ photosDB[tp] = arr; savePhotos(); }

function fileToDataUrl(file, maxWidth=1600, quality=0.85){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onerror = reject;
    fr.onload = () => {
      const img = new Image();
      img.onload = () => {
        const scale = Math.min(1, maxWidth / img.width);
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);

        const c = document.createElement("canvas");
        c.width = w; c.height = h;
        c.getContext("2d").drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL("image/jpeg", quality));
      };
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.readAsDataURL(file);
  });
}

async function addPhotosFromInput(){
  if (!currentTP) return;
  const input = document.getElementById("photoInput");
  const files = [...(input.files || [])];
  if (!files.length) return;

  const existing = getPhotos(currentTP);
  for (const f of files){
    if (!f.type.startsWith("image/")) continue;
    const dataUrl = await fileToDataUrl(f);
    existing.push({ name: f.name, dataUrl, ts: Date.now() });
    if (existing.length >= 12) break;
  }
  setPhotos(currentTP, existing);
  input.value = "";
  renderPhotosPanel();
  renderKPIs();
  toast("Photos added (local)");
}

function removePhoto(idx){
  if (!currentTP) return;
  const arr = getPhotos(currentTP);
  arr.splice(idx,1);
  setPhotos(currentTP, arr);
  renderPhotosPanel();
  renderKPIs();
}
function movePhoto(idx, dir){
  if (!currentTP) return;
  const arr = getPhotos(currentTP);
  const n = idx + dir;
  if (n < 0 || n >= arr.length) return;
  [arr[idx], arr[n]] = [arr[n], arr[idx]];
  setPhotos(currentTP, arr);
  renderPhotosPanel();
}
function clearAllPhotos(){
  if (!currentTP) return;
  if (!confirm("Remove all photos for this TP?")) return;
  setPhotos(currentTP, []);
  renderPhotosPanel();
  renderKPIs();
}

/* ===================== Buyer Agreement / eBay HTML ===================== */
const ASIS_AGREEMENT_TEXT = `
TEK-PAK INC. AS-IS PURCHASE AGREEMENT & RETURN POLICY

By purchasing any item from Tek-Pak Inc. through eBay, the buyer acknowledges, understands,
and expressly agrees to the following terms and conditions:

1. AS-IS / NO RETURNS
‚Ä¢ All items marked AS-IS, NO RETURNS, FOR PARTS, or otherwise disclosed with defects are
sold strictly AS-IS.
‚Ä¢ No returns, refunds, exchanges, or partial credits will be accepted for any reason.
‚Ä¢ Disclosed defects or limitations are not grounds for disputes or claims.

2. FULL DISCLOSURE & BUYER RESPONSIBILITY
‚Ä¢ All known defects, limitations, and conditions are clearly disclosed in the item description.
‚Ä¢ Buyers are solely responsible for reading and understanding the listing prior to purchase.
‚Ä¢ Failure to read the listing does not entitle the buyer to a return, refund, or feedback revision.

3. AGREEMENT AT PURCHASE
By clicking Buy It Now, submitting an offer, or placing a bid, the buyer confirms acceptance of all terms.
This constitutes a binding agreement.

4. IMPROPER RETURN REQUESTS
Submitting a return request or dispute for an issue disclosed in the listing is a violation of this agreement.
Tek-Pak Inc. reserves the right to deny such requests.

5. FEES, COST RECOVERY & DAMAGES
‚Ä¢ Tek-Pak Inc. reserves the right to recover all costs resulting from improper return attempts.
‚Ä¢ Recoverable costs may include shipping, handling, restocking, administrative, and platform fees.
‚Ä¢ Such amounts represent reasonable damages and are not penalties.

6. ACCOUNT RESTRICTIONS
Violations may result in permanent buyer blocks across all Tek-Pak Inc. sales channels.

7. LEGAL REMEDIES
Tek-Pak Inc. reserves all legal rights and remedies under applicable law.

8. GOVERNING LAW
This agreement shall be governed by the laws of the State of North Carolina.

If you do not agree to these terms, do not purchase this item.
`.trim();

const PROFESSIONAL_BULLETS = [
  "Used electronics may show cosmetic wear (scratches/scuffs/shine/label residue). Review photos closely.",
  "Only what is pictured/explicitly stated is included. Accessories (chargers, cables, etc.) are not included unless stated.",
  "Devices are wiped/reset when applicable; buyer is responsible for setup and any software licensing/activation.",
  "We use <b>100% recycled</b> packaging materials whenever possible to reduce waste.",
  "Serial numbers/identifiers may be recorded to help prevent fraud."
];

function normalizeMulti(s){
  return String(s||"").split(",").map(x=>x.trim()).filter(Boolean);
}
function safeLine(s){ return String(s||"").trim(); }

function returnPolicyLine(it){
  const st = (it.SaleType || "").trim();
  const returns = !!it.ReturnsAccepted;

  if (st === "As-Is" || st === "Surplus"){
    return "NO RETURNS: As-Is / Surplus items are sold as-is and are not eligible for returns or warranty unless explicitly stated otherwise in the listing.";
  }
  if (st === "Refurbished"){
    return returns
      ? "Returns/Warranty: Refurbished item ‚Äî return eligibility and warranty terms are as stated in this listing‚Äôs item details."
      : "Warranty/Returns: Refurbished item ‚Äî terms are as stated in this listing‚Äôs item details.";
  }
  return returns
    ? "Returns: Accepted only when stated in the listing‚Äôs item details (and handled per eBay policy)."
    : "Returns: Only if explicitly stated in the listing‚Äôs item details.";
}

function buildSpecRows(it){
  const spec = [];
  const add = (label, val) => { if (val && String(val).trim()) spec.push([label, String(val).trim()]); };

  add("Tek-Pak TP#", it.TP);
  add("Category", it.Category);
  add("Brand", it.Brand);
  add("Model", it.Model);
  add("Color", it.Color);

  add("Screen Size", it.ScreenSizeIn ? `${it.ScreenSizeIn} in` : "");
  add("CPU", it.CPU);
  add("Memory", it.MemoryGB ? `${it.MemoryGB} GB` : "");
  add("Storage", it.StorageGB ? `${it.StorageGB} GB` : "");
  add("GPU", it.GPU);
  add("Series", it.Series);
  const conn = normalizeMulti(it.Connectivity).join(", ");
  add("Connectivity", conn);
  add("Condition", it.Condition);

  add("Sale Type", it.SaleType);
  add("Operating System", it.OperatingSystem);
  add("Warranty", it.Warranty);

  return spec;
}

function buildConditionNarrative(it){
  const st = safeLine(it.SaleType);
  const cond = safeLine(it.Condition);
  if (st === "As-Is" || st === "Surplus"){
    return "This item is sold <b>AS-IS</b>. It may be untested, partially tested, or have known/unknown issues. Please review the full description and photos carefully before purchase.";
  }
  if (cond){
    return `Condition noted as <b>${escapeHtml(cond)}</b>. Item has been inspected and documented to the best of our ability. See photos and description for exact details.`;
  }
  return "Item has been inspected and documented to the best of our ability. See photos and description for exact details.";
}

function formatAgreementForHtml(text){
  const lines = String(text||"").split("\n").map(l=>l.trim()).filter(l=>l.length);
  const out = [];
  for (const line of lines){
    if (line.startsWith("‚Ä¢")){
      out.push(`<li>${escapeHtml(line.replace(/^‚Ä¢\s*/,""))}</li>`);
    } else if (/^\d+\./.test(line)){
      out.push(`<div style="margin-top:8px; font-weight:700;">${escapeHtml(line)}</div>`);
    } else {
      out.push(`<div style="margin-top:4px;">${escapeHtml(line)}</div>`);
    }
  }
  let html = out.join("");
  html = html.replace(/((?:<li>.*?<\/li>)+)/gs, '<ul style="margin:6px 0 10px; padding-left:18px;">$1</ul>');
  return html;
}

function buildEbayHTML(it, imageUrls, logoUrl){
  const title = safeLine(it.Title) || [it.Brand,it.Model,it.CPU,it.MemoryGB?it.MemoryGB+"GB":"",it.StorageGB?it.StorageGB+"GB":""] .filter(Boolean).join(" ").trim() || it.TP || "Item";
  const desc = safeLine(it.Description);
  const shipPolicy = safeLine(it.ShippingPolicy);
  const tp = safeLine(it.TP) || "‚Äî";
  const saleType = safeLine(it.SaleType) || "Standard";

  const specs = buildSpecRows(it);

  const imgBlock = imageUrls.length
    ? imageUrls.map((u,i)=>`<div style="margin:10px 0;"><img src="${escapeAttr(u)}" alt="Photo ${i+1}" style="max-width:100%; border:1px solid #e6e6e6; border-radius:10px;"></div>`).join("")
    : `<div style="padding:10px; border:1px dashed #bbb; border-radius:10px; color:#555;">
         <b>Photos:</b> Upload images in the eBay listing UI (recommended).<br>
         (Optional) Paste hosted image URLs into the STAGING generator to embed them here.
       </div>`;

  const policyLine = returnPolicyLine(it);
  const conditionNarr = buildConditionNarrative(it);

  const agreementHtml = (saleType === "As-Is" || saleType === "Surplus")
    ? `<div style="margin-top:12px; border:1px solid #f0d0d0; border-radius:12px; padding:12px; background:#fff7f8;">
         <div style="font-size:13px; font-weight:800; color:#8a0f22;">AS-IS PURCHASE AGREEMENT & RETURN POLICY</div>
         <div style="font-size:12px; color:#333; margin-top:8px;">
           ${formatAgreementForHtml(ASIS_AGREEMENT_TEXT)}
         </div>
       </div>`
    : "";

  const profBullets = PROFESSIONAL_BULLETS.map(b=>`<li>${b}</li>`).join("");

  const logoBlock = logoUrl
    ? `<div style="display:flex; align-items:center; gap:10px;">
         <img src="${escapeAttr(logoUrl)}" alt="Tek-Pak" style="height:34px; width:auto;">
         <div style="font-size:12px; opacity:.95;">Tek-Pak Inc.</div>
       </div>`
    : `<div style="font-size:12px; opacity:.95;">Tek-Pak Inc.</div>`;

  return `
<div style="font-family:Arial, Helvetica, sans-serif; color:#111; line-height:1.35;">
  <div style="border:1px solid #e6e6e6; border-radius:14px; overflow:hidden;">
    <div style="padding:14px 16px; background:#0b2a4a; color:#fff;">
      ${logoBlock}
      <div style="margin-top:10px; font-size:18px; font-weight:700;">${escapeHtml(title)}</div>
      <div style="font-size:12px; opacity:.92; margin-top:4px;">
        Internal Ref (TP#): <b>${escapeHtml(tp)}</b> ‚Ä¢ Sale Type: <b>${escapeHtml(saleType)}</b>
      </div>
    </div>

    <div style="padding:14px 16px;">
      ${imgBlock}

      <div style="margin-top:12px; padding:10px 12px; border:1px solid #eee; border-radius:12px; background:#fcfcfc; font-size:13px;">
        <b>Return Policy:</b> ${escapeHtml(policyLine)}
      </div>

      <div style="margin-top:10px; padding:10px 12px; border:1px solid #eee; border-radius:12px; background:#fcfcfc; font-size:13px;">
        ${conditionNarr}
      </div>

      <h3 style="margin:14px 0 8px; font-size:14px;">Item Details</h3>
      <table style="width:100%; border-collapse:collapse; font-size:13px;">
        ${specs.map(([k,v])=>`
          <tr>
            <td style="padding:8px 10px; border:1px solid #eee; width:34%; background:#fafafa;"><b>${escapeHtml(k)}</b></td>
            <td style="padding:8px 10px; border:1px solid #eee;">${escapeHtml(v)}</td>
          </tr>`).join("")}
      </table>

      <h3 style="margin:14px 0 8px; font-size:14px;">Description</h3>
      <div style="padding:10px 12px; border:1px solid #eee; border-radius:12px; background:#fcfcfc; white-space:pre-wrap;">
        ${escapeHtml(desc || "See item details and photos for condition and included items.")}
      </div>

      ${shipPolicy ? `
      <h3 style="margin:14px 0 8px; font-size:14px;">Shipping Policy</h3>
      <div style="padding:10px 12px; border:1px solid #eee; border-radius:12px; background:#fcfcfc;">
        ${escapeHtml(shipPolicy)}
      </div>` : ""}

      <h3 style="margin:14px 0 8px; font-size:14px;">Buyer Agreement & Professional Notes</h3>
      <ul style="margin:0; padding-left:18px;">
        ${profBullets}
      </ul>

      ${agreementHtml}

      <div style="margin-top:12px; font-size:11px; color:#666;">
        Internal Ref (TP#): <b>${escapeHtml(tp)}</b>
      </div>
    </div>
  </div>
</div>
  `.trim();
}

/* ===================== CORE ACTIONS ===================== */
async function newItem(){
  const tp = generateUniqueTP();
  const payload = {
    TP: tp,
    Stage: STAGE,
    CreatedAt: Date.now(),
    UpdatedAt: Date.now(),
    SaleType: "As-Is",
    ReturnsAccepted: false
  };
  await apiPost("upsertItem", payload);
  await boot();
  openItem(tp);
  toast("New TP created (sheet)");
}

async function openItem(tp){
  currentTP = tp;
  const it = await readItem(tp);

  document.getElementById("statusLine").textContent = `${it.TP} ‚Ä¢ Stage: ${it.Stage}`;

  const dd = dropdowns || {};
  const saleTypes = dd.SaleType?.length ? dd.SaleType : ["As-Is","Surplus","Refurbished","Standard"];
  const osList = dd.OperatingSystem?.length ? dd.OperatingSystem : ["Windows 11","Windows 10","ChromeOS","macOS","Linux","No OS"];
  const warrantyList = dd.Warranty?.length ? dd.Warranty : ["None","7 Day","30 Day","90 Day"];
  const shipList = dd.ShippingPolicy?.length ? dd.ShippingPolicy : ["Free Shipping","Flat Rate","Calculated","Local Pickup"];

  document.getElementById("detail").innerHTML = `
    <div class="tpCallout" style="align-items:flex-start;">
      <div style="width:100%;">
        <div style="color:var(--muted); font-size:12px; margin-bottom:6px;">TP Item Number (manual override allowed)</div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; width:100%;">
          <input id="f_TP" value="${escapeAttr(it.TP)}" style="flex:1; min-width:220px; font-family:var(--mono); font-weight:950;" />
          <button class="miniBtn" onclick="copyTP()">Copy</button>
          <button class="miniBtn warn" onclick="regenerateTP()">Regenerate</button>
          <button class="miniBtn good" onclick="applyTPChange()">Apply TP#</button>
        </div>
        <div class="hint" style="margin-top:6px;">Default TP = random 9 alphanumeric. Unique check becomes global via sheet.</div>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Sale Type</div>
        <select id="f_SaleType">${selectHTML(saleTypes, it.SaleType)}</select>
      </div>
      <div>
        <div class="lab">Returns Accepted (only if listing allows)</div>
        <div class="checkRow">
          <label><input type="checkbox" id="f_ReturnsAccepted" ${it.ReturnsAccepted ? "checked" : ""}> Mark returns accepted</label>
        </div>
        <div class="hint">As-Is/Surplus will auto-disable returns on save.</div>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Title</div>
        <input id="f_Title" value="${escapeAttr(it.Title||"")}" placeholder="Brand Model CPU RAM SSD etc."/>
      </div>
      <div>
        <div class="lab">Operating System</div>
        <select id="f_OperatingSystem">${selectHTML(osList, it.OperatingSystem)}</select>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Warranty</div>
        <select id="f_Warranty">${selectHTML(warrantyList, it.Warranty)}</select>
      </div>
      <div>
        <div class="lab">Shipping Policy</div>
        <select id="f_ShippingPolicy">${selectHTML(shipList, it.ShippingPolicy)}</select>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Price (USD)</div>
        <input id="f_PriceUSD" value="${escapeAttr(it.PriceUSD||"")}" placeholder="e.g., 169.99"/>
      </div>
      <div>
        <div class="lab">Quick Notes (optional)</div>
        <input id="f_Quick" value="" placeholder="e.g., includes charger / missing keycap"/>
      </div>
    </div>

    <div class="lab">Description</div>
    <textarea id="f_Description" placeholder="Tested details, cosmetic notes, what's included‚Ä¶">${escapeHtml(it.Description||"")}</textarea>

    <div class="divider"></div>

    <div class="photoBar">
      <div style="flex:1">
        <div class="lab">Photos (local workflow)</div>
        <input id="photoInput" type="file" accept="image/*" multiple />
      </div>
      <button class="good miniBtn" onclick="addPhotosFromInput()">Add Photos</button>
      <button class="danger miniBtn" onclick="clearAllPhotos()">Clear Photos</button>
    </div>

    <div class="hint" style="margin-top:8px">
      üìå Photos are stored <b>locally</b> per PC for now. Sheet sync is for item data.
    </div>

    <div class="divider"></div>

    <div class="btns">
      <button class="good" onclick="save()">Save</button>
      <button class="warn" onclick="movePrev()">‚Üê Back</button>
      <button class="primary" onclick="moveNext()">Next ‚Üí ${NEXT_STAGE}</button>
      <button class="primary" onclick="generateNow()">Generate eBay HTML</button>
      <button class="miniBtn" onclick="refreshCurrent()">Refresh</button>
    </div>
  `;

  renderPhotosPanel();
  renderGenerator(it);
  renderKPIs();
}

function copyTP(){
  if (!currentTP) return;
  navigator.clipboard.writeText(currentTP);
  toast("TP# copied");
}

async function refreshCurrent(){
  if (!currentTP) return;
  await boot(false);
  await openItem(currentTP);
  toast("Refreshed from sheet");
}

async function applyTPChange(){
  if (!currentTP) return;

  const input = document.getElementById("f_TP");
  const desired = normalizeTP(input?.value);

  if (!desired) { input.value = currentTP; return toast("TP# can't be blank"); }
  if (desired === currentTP) return toast("TP# unchanged");

  // update sheet key
  const res = await apiGet({ action:"updateTP", oldTp: currentTP, newTp: desired });
  if (!res || !res.ok){
    input.value = currentTP;
    return toast(res?.error || "TP update failed");
  }

  // move photos mapping local
  if (photosDB[currentTP]){
    photosDB[desired] = photosDB[currentTP];
    delete photosDB[currentTP];
    savePhotos();
  }

  currentTP = desired;
  await boot(false);
  await openItem(desired);
  toast("TP# updated");
}

async function regenerateTP(){
  const input = document.getElementById("f_TP");
  const newTP = generateUniqueTP();
  if (input) input.value = newTP;
  await applyTPChange();
}

async function save(){
  if (!currentTP) return;
  const tp = currentTP;

  const saleType = document.getElementById("f_SaleType").value || "";
  let returnsAccepted = !!document.getElementById("f_ReturnsAccepted").checked;

  if (saleType === "As-Is" || saleType === "Surplus") returnsAccepted = false;

  const payload = {
    TP: tp,
    Stage: STAGE,
    UpdatedAt: Date.now(),
    SaleType: saleType,
    ReturnsAccepted: returnsAccepted,
    Title: document.getElementById("f_Title").value.trim(),
    OperatingSystem: document.getElementById("f_OperatingSystem").value,
    Warranty: document.getElementById("f_Warranty").value,
    ShippingPolicy: document.getElementById("f_ShippingPolicy").value,
    PriceUSD: document.getElementById("f_PriceUSD").value.trim(),
    Description: document.getElementById("f_Description").value
  };

  const quick = (document.getElementById("f_Quick")?.value || "").trim();
  if (quick){
    if (!payload.Description || !payload.Description.trim()) payload.Description = quick;
    else if (!payload.Description.includes(quick)) payload.Description = payload.Description.trim() + "\n\n" + quick;
  }

  await apiPost("upsertItem", payload);
  await boot(false);
  toast("Saved to sheet");
}

async function moveNext(){
  if (!currentTP) return;
  await save();
  const res = await apiGet({ action:"moveStage", tp: currentTP, stage: NEXT_STAGE });
  if (!res || !res.ok) return toast(res?.error || "Move failed");

  currentTP = null;
  document.getElementById("detail").innerHTML = `<div class="hint">Moved to <b>${NEXT_STAGE}</b>.</div>`;
  document.getElementById("generator").innerHTML = `<div class="hint">Select an item to generate eBay HTML.</div>`;
  document.getElementById("statusLine").textContent = "‚Äî";
  await boot(false);
  toast("Forwarded");
}

async function movePrev(){
  if (!currentTP) return;
  await save();
  const res = await apiGet({ action:"moveStage", tp: currentTP, stage: PREV_STAGE });
  if (!res || !res.ok) return toast(res?.error || "Move failed");

  currentTP = null;
  document.getElementById("detail").innerHTML = `<div class="hint">Moved back to <b>${PREV_STAGE}</b>.</div>`;
  document.getElementById("generator").innerHTML = `<div class="hint">Select an item to generate eBay HTML.</div>`;
  document.getElementById("statusLine").textContent = "‚Äî";
  await boot(false);
  toast("Backed");
}

/* Photos panel */
function renderPhotosPanel(){
  if (!currentTP) return;
  const arr = getPhotos(currentTP);

  const markerId = "photoBlockMarker";
  const detail = document.getElementById("detail");
  const existing = document.getElementById(markerId);
  if (existing) existing.remove();

  const marker = document.createElement("div");
  marker.id = markerId;

  marker.innerHTML = `
    <div class="divider"></div>
    <div class="lab">Attached Photos (${arr.length})</div>
    ${arr.length ? `
      <div class="photoGrid">
        ${arr.map((p,idx)=>`
          <div class="thumb">
            <img src="${p.dataUrl}" alt="photo ${idx+1}">
            <div class="cap">
              <div class="left">
                <span class="badge">#${idx+1}</span>
                <span title="${escapeAttr(p.name||"")}" style="max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                  ${escapeHtml((p.name||"photo").slice(0,18))}
                </span>
              </div>
              <div style="display:flex; gap:6px; flex-wrap:wrap;">
                <button class="miniBtn" onclick="movePhoto(${idx},-1)">‚óÄ</button>
                <button class="miniBtn" onclick="movePhoto(${idx},1)">‚ñ∂</button>
                <button class="miniBtn danger" onclick="removePhoto(${idx})">‚úï</button>
              </div>
            </div>
          </div>
        `).join("")}
      </div>
    ` : `<div class="hint">No photos yet. Add 4‚Äì6 pics (front/back/keyboard/ports/spec screen + any damage).</div>`}
  `;

  detail.appendChild(marker);
}

/* Generator panel */
function renderGenerator(it){
  const tp = it.TP || "";
  const pcount = (getPhotos(tp) || []).length;

  document.getElementById("generator").innerHTML = `
    <div class="tpCallout">
      <div style="color:#666; font-size:12px;">This HTML will include TP#</div>
      <div class="big">${escapeHtml(tp)}</div>
      <button class="miniBtn" onclick="copyTP()">Copy TP#</button>
      <button class="miniBtn" onclick="openTpSettings()">TP Settings</button>
    </div>

    <div class="hint" style="margin-top:10px;">
      Generates eBay-safe HTML using sheet fields.
      Local photos attached: <b>${pcount}</b>.
    </div>

    <div class="divider"></div>

    <div class="row">
      <div>
        <div class="lab">Logo URL (optional)</div>
        <input id="logoUrl" value="${escapeAttr(DEFAULT_LOGO_URL)}" placeholder="assets/tekpak-logo.png or https://..."/>
        <div class="hint">If logo doesn‚Äôt render on eBay, host it and paste full URL.</div>
      </div>
      <div>
        <div class="lab">Image Mode (optional)</div>
        <select id="imgMode" onchange="toggleImgMode()">
          <option value="placeholders">Placeholders (upload photos in eBay UI)</option>
          <option value="urls">Embed hosted image URLs in description</option>
        </select>
      </div>
    </div>

    <div id="urlModeBox" style="display:none;">
      <div class="lab">Hosted Image URLs (one per line, 4‚Äì6 recommended)</div>
      <textarea class="urlBox" id="imgUrls" placeholder="https://.../photo1.jpg
https://.../photo2.jpg"></textarea>
    </div>

    <div class="divider"></div>

    <div class="btns">
      <button class="primary miniBtn" onclick="generateNow()">Generate</button>
      <button class="good miniBtn" onclick="copyHtml()">Copy HTML</button>
      <button class="miniBtn" onclick="downloadHtml()">Download .html</button>
    </div>

    <div class="lab">Generated eBay Description HTML</div>
    <textarea class="outBox" id="outHtml" placeholder="Click Generate‚Ä¶"></textarea>
  `;
}

function toggleImgMode(){
  const mode = document.getElementById("imgMode").value;
  document.getElementById("urlModeBox").style.display = (mode === "urls") ? "block" : "none";
}

async function generateNow(){
  if (!currentTP) return;
  await save();
  const it = await readItem(currentTP);

  const mode = document.getElementById("imgMode")?.value || "placeholders";
  let urls = [];
  if (mode === "urls"){
    const raw = (document.getElementById("imgUrls")?.value || "").trim();
    urls = raw ? raw.split("\n").map(x=>x.trim()).filter(Boolean) : [];
  }
  const logoUrl = (document.getElementById("logoUrl")?.value || "").trim();

  const html = buildEbayHTML(it, urls, logoUrl);
  document.getElementById("outHtml").value = html;
  toast("eBay HTML generated");
}

async function copyHtml(){
  const box = document.getElementById("outHtml");
  if (!box || !box.value.trim()) return toast("Generate first");
  await navigator.clipboard.writeText(box.value);
  toast("Copied");
}

function downloadHtml(){
  const box = document.getElementById("outHtml");
  if (!box || !box.value.trim()) return toast("Generate first");
  const blob = new Blob([box.value], {type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = (currentTP ? currentTP : "listing") + "_ebay_description.html";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* TP Settings UI */
function openTpSettings(){
  const s = loadTpSettings();
  const preview = generateTP(s);

  document.getElementById("generator").innerHTML = `
    <div class="tpCallout" style="justify-content:space-between; width:100%;">
      <div>
        <div style="color:#666; font-size:12px;">TP Settings (saved to this PC)</div>
        <div class="big" style="margin-top:4px;">${escapeHtml(preview)}</div>
      </div>
      <button class="miniBtn" onclick="${currentTP ? "openItem(currentTP)" : "renderList()"}">Back</button>
    </div>

    <div class="row">
      <div>
        <div class="lab">Prefix (optional)</div>
        <input id="tp_prefix" value="${escapeAttr(s.prefix)}" placeholder="TP"/>
      </div>
      <div>
        <div class="lab">Separator</div>
        <input id="tp_sep" value="${escapeAttr(s.sep)}" placeholder="-"/>
      </div>
    </div>

    <div class="row">
      <div>
        <div class="lab">Random Length</div>
        <input id="tp_len" type="number" min="3" max="20" value="${Number(s.randLen)||9}"/>
      </div>
      <div>
        <div class="lab">Case</div>
        <select id="tp_case">
          <option value="upper" ${s.case==="upper"?"selected":""}>UPPER</option>
          <option value="lower" ${s.case==="lower"?"selected":""}>lower</option>
        </select>
      </div>
    </div>

    <div class="lab">Include Date (YYYYMMDD)</div>
    <div class="checkRow">
      <label><input type="checkbox" id="tp_date" ${s.includeDate ? "checked":""}> Include date stamp</label>
    </div>

    <div class="lab">Character Set (advanced)</div>
    <input id="tp_charset" value="${escapeAttr(s.charset)}"/>

    <div class="divider"></div>
    <div class="btns">
      <button class="good miniBtn" onclick="saveTpSettingsFromUI()">Save</button>
      <button class="primary miniBtn" onclick="previewTpSettings()">Preview</button>
      <button class="miniBtn warn" onclick="resetTpSettings()">Reset</button>
    </div>

    <div class="lab">Preview</div>
    <input id="tp_preview" readonly value="${escapeAttr(preview)}"/>
  `;
}

function readTpSettingsFromUI(){
  return {
    prefix: String(document.getElementById("tp_prefix")?.value || "").trim(),
    sep: String(document.getElementById("tp_sep")?.value ?? "-"),
    randLen: Number(document.getElementById("tp_len")?.value || 9),
    case: String(document.getElementById("tp_case")?.value || "upper"),
    includeDate: !!document.getElementById("tp_date")?.checked,
    charset: String(document.getElementById("tp_charset")?.value || DEFAULT_TP_SETTINGS.charset).trim()
  };
}
function previewTpSettings(){
  const s = readTpSettingsFromUI();
  document.getElementById("tp_preview").value = generateTP(s);
}
function saveTpSettingsFromUI(){
  const s = readTpSettingsFromUI();
  saveTpSettings(s);
  document.getElementById("tp_preview").value = generateTP(s);
  toast("TP settings saved");
}
function resetTpSettings(){
  saveTpSettings(DEFAULT_TP_SETTINGS);
  toast("TP settings reset");
  openTpSettings();
}

/* Keyboard shortcuts */
document.addEventListener("keydown", (e)=>{
  if (e.ctrlKey && (e.key==="f" || e.key==="F")){ e.preventDefault(); document.getElementById("q").focus(); }
  if (e.key==="Enter" && currentTP && document.activeElement && document.activeElement.tagName!=="TEXTAREA"){ e.preventDefault(); save(); }
  if (e.ctrlKey && (e.key==="g" || e.key==="G")){ e.preventDefault(); generateNow(); }
});

/* Boot */
async function boot(showToast=true){
  if (!API_URL || API_URL.includes("https://script.google.com/macros/s/AKfycbw5s7R5FFQBNKqmQPwNl-jSa6g987HeyXS2eMDR1Y2H9pq5XUEn4QHnqGA5-B8cXAelEw/exec")){
    document.getElementById("list").innerHTML = `<div class="hint"><b>API_URL not set.</b><br>Paste your Apps Script Web App URL into staging.html.</div>`;
    return;
  }
  try{
    loadPhotos();
    const dd = await apiGet({ action:"getDropdowns" });
    dropdowns = dd?.dropdowns || {};
    await refreshQueue();
    renderList();
    renderKPIs();
    if (showToast) toast("Connected to sheet");
  }catch(err){
    document.getElementById("list").innerHTML = `<div class="hint"><b>API error.</b><br>${escapeHtml(err.message || String(err))}</div>`;
  }
}
boot();
</script>
</body>
</html>
